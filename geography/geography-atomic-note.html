<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geography Ultimate Learning OS</title>
    <!-- Tailwind CSS for modern, utility-first styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom styles for modal transitions and other small tweaks -->
    <style>
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .toast {
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translateY(20px);
            opacity: 0;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .confidence-selector .star-btn {
            font-size: 2em;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.3;
            color: #ffc107;
        }
        .confidence-selector .star-btn:hover,
        .confidence-selector .star-btn.active {
            opacity: 1;
            transform: scale(1.2);
        }
        /* A few custom styles can remain for complex selectors or states if needed */
        .stat-pill {
            @apply bg-gray-100 dark:bg-gray-700/50 text-gray-600 dark:text-gray-300 text-sm px-3 py-1.5 rounded-full flex items-center gap-2;
        }
        .stat-pill .stat-label {
            @apply font-medium;
        }
        .stat-pill .stat-value {
            @apply font-bold text-blue-600 dark:text-blue-400;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <!-- Main Header -->
        <header class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 mb-8 text-center">
            <h1 class="text-4xl sm:text-5xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 dark:from-blue-400 dark:to-purple-400 text-transparent bg-clip-text mb-2">üåç Geography Ultimate Learning OS</h1>
            <p class="text-gray-500 dark:text-gray-400 text-lg">Your Complete System for Mastering O-Level Geography</p>
        </header>

        <!-- Stats Bar -->
        <section class="grid grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6 mb-8">
            <div class="stat-card bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md text-center">
                <div class="text-4xl font-bold text-green-500" id="topicsGreen">0</div>
                <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">üü¢ Topics Mastered</div>
            </div>
            <div class="stat-card bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md text-center">
                <div class="text-4xl font-bold text-blue-500" id="casesTotal">47</div>
                <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">üìö Cases in Deck</div>
            </div>
            <div class="stat-card bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md text-center">
                <div class="text-4xl font-bold text-yellow-500" id="flashcardsDue">0</div>
                <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">üîÑ Cards Due Today</div>
            </div>
            <div class="stat-card bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md text-center">
                <div class="text-4xl font-bold text-purple-500" id="weekProgress">0%</div>
                <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">‚úÖ Week Progress</div>
            </div>
        </section>

        <!-- Dashboard Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Left: Module Cards -->
            <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-6">
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col cursor-pointer" onclick="window.openAtomicNotes()">
                    <div class="flex items-center gap-3 text-lg font-bold text-gray-800 dark:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                        <span>Atomic Notes</span>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2 flex-grow">Deep understanding of concepts with detailed explanations.</p>
                    <div class="mt-4">
                        <span class="text-xs font-semibold px-2.5 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300 self-start">Layer 1: Knowledge</span>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col cursor-pointer" onclick="openQuizletManager()">
                    <div class="flex items-center gap-3 text-lg font-bold text-gray-800 dark:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                        <span>Flashcards</span>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2 flex-grow">Manage your Quizlet study plan and track progress.</p>
                    <div class="mt-4">
                       <span class="text-xs font-semibold px-2.5 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300 self-start">Layer 1: Knowledge</span>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col cursor-pointer" onclick="openCaseDeck()">
                    <div class="flex items-center gap-3 text-lg font-bold text-gray-800 dark:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                        <span>Case Deck</span>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2 flex-grow">Evidence database for perfect arguments.</p>
                    <div class="mt-4">
                        <span class="text-xs font-semibold px-2.5 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300 self-start">Layer 1: Knowledge</span>
                    </div>
                </div>
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col cursor-pointer" onclick="showToast('Practice module - Import past papers and track performance!', 'info')">
                    <div class="flex items-center gap-3 text-lg font-bold text-gray-800 dark:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z" /></svg>
                        <span>Practice</span>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2 flex-grow">Past papers, model answers, and application exercises.</p>
                     <div class="mt-4">
                        <span class="text-xs font-semibold px-2.5 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300 self-start">Layer 1: Knowledge</span>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col cursor-pointer" onclick="showToast('Archetype Hub - Learn to decode 6 question types!', 'info')">
                    <div class="flex items-center gap-3 text-lg font-bold text-gray-800 dark:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                        <span>Archetype Hub</span>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2 flex-grow">Question pattern recognition and signal word identification.</p>
                    <div class="mt-4">
                        <span class="text-xs font-semibold px-2.5 py-1 rounded-full bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300 self-start">Layer 2: Strategy</span>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col cursor-pointer" onclick="showToast('Framework Library - Master P.E.E.L.+, C.E.M., and more!', 'info')">
                    <div class="flex items-center gap-3 text-lg font-bold text-gray-800 dark:text-white">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <span>Framework Library</span>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2 flex-grow">Writing frameworks, templates, and self-correction checklists.</p>
                    <div class="mt-4">
                        <span class="text-xs font-semibold px-2.5 py-1 rounded-full bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300 self-start">Layer 2: Strategy</span>
                    </div>
                </div>
            </div>

            <!-- Right: Sidebar -->
            <aside class="space-y-6">
                <!-- This Week's Mission -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md">
                    <h3 class="flex items-center gap-3 text-lg font-bold text-blue-500 dark:text-blue-400 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <span>This Week's Mission</span>
                    </h3>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="newMissionInput" placeholder="Add a new mission..." class="flex-grow bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-blue-500 rounded-lg p-2 text-sm outline-none transition">
                        <button onclick="addMission()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors whitespace-nowrap">‚ûï Add</button>
                    </div>
                    <div id="missionList" class="space-y-2"></div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="confirmClearCompleted()" class="flex-1 bg-red-100 hover:bg-red-200 text-red-700 dark:bg-red-900 dark:text-red-300 dark:hover:bg-red-800 text-sm font-semibold py-2 px-3 rounded-lg transition">üóëÔ∏è Clear Completed</button>
                        <button onclick="confirmResetWeek()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 text-sm font-semibold py-2 px-3 rounded-lg transition">üîÑ New Week</button>
                    </div>
                </div>

                <!-- Quizlet Study Queue -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md">
                    <h3 class="flex items-center gap-3 text-lg font-bold text-blue-500 dark:text-blue-400 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7.014A8.003 8.003 0 0112 2c2.21 0 4.21.896 5.657 2.343a8 8 0 010 11.314z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 12l2 4-2 2-2-4 2-2z" /></svg>
                        <span>Quizlet Study Queue</span>
                    </h3>
                    <div id="quizletQueue" class="space-y-2">
                        <!-- Dynamic content here -->
                    </div>
                     <button class="w-full text-center mt-4 py-2 px-4 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 text-sm font-semibold rounded-lg transition" onclick="openQuizletManager()">
                        Manage Quizlet Sets ‚Üí
                    </button>
                </div>
            </aside>
        </main>

        <!-- Knowledge Heatmap -->
        <section class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 sm:p-8">
             <div class="flex flex-wrap justify-between items-start gap-4 mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-1">üìä Knowledge Heatmap</h2>
                    <p class="text-gray-500 dark:text-gray-400">Rate your confidence from 1 to 5 stars.</p>
                </div>
                <div class="flex flex-wrap gap-3">
                    <div class="stat-pill"><span class="stat-label">Progress:</span> <span class="stat-value" id="overallProgress">0%</span></div>
                    <div class="stat-pill"><span class="stat-label">Ready:</span> <span class="stat-value" id="readyTopics">0/0</span></div>
                    <div class="stat-pill"><span class="stat-label">Review:</span> <span class="stat-value" id="needsReview">0</span></div>
                </div>
            </div>
            <div class="priority-banner bg-yellow-50 border border-yellow-200 dark:bg-yellow-900/20 dark:border-yellow-500/30 text-yellow-800 dark:text-yellow-300 p-4 rounded-lg mb-6" id="priorityBanner" style="display: none;">
                <strong class="font-bold">üî• Priority This Week:</strong> <span id="priorityList"></span>
            </div>
            <div id="heatmapGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Heatmap columns generated by JS -->
            </div>
        </section>
    </div>

    <!-- Modals -->
    <div id="confirmationModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-sm">
            <h3 id="modalTitle" class="text-lg font-bold text-gray-900 dark:text-white mb-2">Confirmation</h3>
            <p id="modalMessage" class="text-gray-600 dark:text-gray-300 mb-6">Are you sure?</p>
            <div class="flex justify-end gap-3">
                <button id="modalCancel" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold transition">Cancel</button>
                <button id="modalConfirm" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-semibold transition">Confirm</button>
            </div>
        </div>
    </div>
    
    <div id="topicModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div id="topicModalContent" class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-md relative">
             <button onclick="closeTopicModal()" class="absolute top-3 right-3 text-2xl text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition">&times;</button>
            <div id="topicModalBody"></div>
        </div>
    </div>
    
    <div id="caseDeckModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-40 p-4">
        <div class="bg-white dark:bg-gray-800 w-full max-w-4xl h-[90vh] rounded-2xl shadow-2xl flex flex-col">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">üóÉÔ∏è Case Deck</h2>
                <button onclick="closeCaseDeck()" class="text-2xl text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 transition">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow">
                <p class="text-gray-700 dark:text-gray-300">This is a placeholder for the Case Deck content.</p>
            </div>
        </div>
    </div>

    <!-- Quizlet Manager Modal -->
    <div id="quizletManagerModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 w-full max-w-2xl h-[90vh] rounded-2xl shadow-2xl flex flex-col">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">üìö Quizlet Set Manager</h2>
                <button onclick="closeQuizletManager()" class="text-2xl text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 transition">&times;</button>
            </div>
            <div id="quizletManagerBody" class="p-6 overflow-y-auto flex-grow space-y-4">
                <!-- Dynamic Content Here -->
            </div>
        </div>
    </div>
    
    <!-- Mark as Studied Modal -->
    <div id="studyFeedbackModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center">
            <h3 id="studyFeedbackTitle" class="text-lg font-bold text-gray-900 dark:text-white mb-2">Great work!</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-4">How did the study session go?</p>
            <div class="grid grid-cols-3 gap-3 mb-4">
                <button id="feedbackBtnHard" class="p-3 bg-red-100 hover:bg-red-200 dark:bg-red-900/50 dark:hover:bg-red-900 rounded-lg">
                    <span class="text-2xl">üò∞</span><br><span class="text-xs font-semibold">Hard</span>
                </button>
                 <button id="feedbackBtnGood" class="p-3 bg-yellow-100 hover:bg-yellow-200 dark:bg-yellow-900/50 dark:hover:bg-yellow-900 rounded-lg">
                    <span class="text-2xl">üòä</span><br><span class="text-xs font-semibold">Good</span>
                </button>
                 <button id="feedbackBtnEasy" class="p-3 bg-green-100 hover:bg-green-200 dark:bg-green-900/50 dark:hover:bg-green-900 rounded-lg">
                    <span class="text-2xl">üéâ</span><br><span class="text-xs font-semibold">Easy</span>
                </button>
            </div>
             <input type="number" id="studyTimeInput" placeholder="Study time (optional, in minutes)" class="w-full text-center bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-blue-500 rounded-lg p-2 text-sm outline-none transition mb-4">
             <button onclick="closeStudyFeedbackModal()" class="w-full px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold transition">Cancel</button>
        </div>
    </div>


    <!-- Toast Notifications Container -->
    <div id="toastContainer" class="fixed bottom-5 right-5 z-50 flex flex-col gap-3"></div>
    
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- App State, Config & UI Elements ---
        let missions = [];
        let topicMetadata = {};
        let quizletTrackingData = {};
        
        // YOUR FIREBASE CONFIG IS PASTED HERE
        const localFirebaseConfig = {
            apiKey: "AIzaSyDdtQYfOC87IvpTZPFoDyb6ZgpEISzqw_I",
            authDomain: "emath-study-plan.firebaseapp.com",
            projectId: "emath-study-plan",
            storageBucket: "emath-study-plan.appspot.com",
            messagingSenderId: "589299697460",
            appId: "1:589299697460:web:df1e0bb0586b3740c04761",
            measurementId: "G-09QVE4GLS0"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : localFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'geography-os-local';
        let userId, db, auth, missionsDocRef, heatmapDocRef, quizletDocRef;

        const missionListEl = document.getElementById('missionList');
        const newMissionInput = document.getElementById('newMissionInput');
        const weekProgressEl = document.getElementById('weekProgress');
        const heatmapGridEl = document.getElementById('heatmapGrid');
        const quizletQueueEl = document.getElementById('quizletQueue');
        
        // --- TOPICS DATABASE ---
        const TOPICS_DATABASE = {
            'C1': { name: 'Everyday Life', topics: [{ id: 'T1.1', name: 'Thinking Geographically', weight: 1.0 }, { id: 'T1.2', name: 'Sustainable Development', weight: 1.2 }, { id: 'T1.3', name: 'Fieldwork Methods', weight: 1.0 }] },
            'C2': { name: 'Tourism', topics: [{ id: 'T2.1', name: 'Tourism as a System', weight: 1.2 }, { id: 'T2.2', name: 'Tourism Development', weight: 1.5 }, { id: 'T2.3', name: 'Sustainable Tourism', weight: 1.3 }] },
            'C3': { name: 'Climate', topics: [{ id: 'T3.1', name: 'Climate Change', weight: 1.4 }, { id: 'T3.2', name: 'Climate Impacts', weight: 1.3 }, { id: 'T3.3', name: 'Climate Adaptation', weight: 1.2 }] },
            'C4': { name: 'Tectonics', topics: [{ id: 'T4.1', name: 'Plate Tectonics', weight: 1.2 }, { id: 'T4.2', name: 'Earthquakes & Volcanoes', weight: 1.4 }, { id: 'T4.3', name: 'Disaster Risk Management', weight: 1.5 }] },
            'C5': { name: 'Singapore', topics: [{ id: 'T5.1', name: 'Urban Planning', weight: 1.3 }, { id: 'T5.2', name: 'Environmental Sustainability', weight: 1.2 }, { id: 'T5.3', name: 'Future Challenges', weight: 1.1 }] }
        };

        // --- Initialization ---
        async function initialize() {
            // **FIX 1: Immediate UI rendering from local data**
            // Create a default state for the heatmap instantly
            const defaultMetadata = {};
            Object.values(TOPICS_DATABASE).forEach(cluster => {
                cluster.topics.forEach(topic => {
                    defaultMetadata[topic.id] = {
                        id: topic.id, name: topic.name, cluster: cluster.name, weight: topic.weight,
                        confidence: 1, lastReviewed: null,
                    };
                });
            });
            topicMetadata = defaultMetadata;
            renderHeatmap(); // Render the heatmap immediately with default data

            try {
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("AIzaSyDdtQYfOC87IvpTZP")) {
                     console.warn("Using placeholder Firebase config. Using local mode. Progress will not be saved across sessions.");
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        setupFirestoreListeners();
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                        showToast("Authentication failed. Please enable Anonymous sign-in in your Firebase project.", "error");
                    }
                }
            } catch (e) {
                console.error("Firebase initialization failed:", e.message);
                showToast("Could not connect to database. Check your Firebase config.", "error");
            }
        }

        async function setupFirestoreListeners() {
            if (!userId) return;
            
            missionsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'missions');
            heatmapDocRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'heatmap');
            quizletDocRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'quizlet');

            // Robust listener for Missions
            onSnapshot(missionsDocRef, async (docSnap) => {
                if (!docSnap.exists()) {
                    const defaultMissions = [{ id: Date.now(), text: 'Setup Quizlet Links', completed: false }];
                    await setDoc(missionsDocRef, { tasks: defaultMissions });
                } else {
                    missions = docSnap.data()?.tasks || [];
                    renderMissions();
                }
            }, (error) => console.error("Missions listener error:", error));

            // Robust listener for Heatmap
            onSnapshot(heatmapDocRef, async (docSnap) => {
                if (!docSnap.exists()) {
                    // We already rendered a default, so we just create the doc for the next session
                    await setDoc(heatmapDocRef, { metadata: topicMetadata });
                } else {
                    topicMetadata = docSnap.data()?.metadata || {};
                    renderHeatmap();
                    renderQuizletQueue();
                }
            }, (error) => console.error("Heatmap listener error:", error));
            
            // Quizlet listener
            onSnapshot(quizletDocRef, (docSnap) => {
                quizletTrackingData = docSnap.data()?.tracking || {};
                renderQuizletQueue();
            }, (error) => console.error("Quizlet listener error:", error));
        }
        
        // --- QUIZLET MODULE LOGIC ---
        async function saveQuizletData() {
            if (!quizletDocRef) return;
            try {
                await setDoc(quizletDocRef, { tracking: quizletTrackingData });
            } catch (e) {
                console.error("Error saving Quizlet data:", e);
                showToast("Failed to save Quizlet link.", "error");
            }
        }

        const getDaysSince = (dateString) => {
            if (!dateString) return 999;
            const diff = new Date() - new Date(dateString);
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        };

        function getQuizletPriority() {
            if (Object.keys(topicMetadata).length === 0) return [];
            // **FIX 2.1: Get ALL linked topics, score them, then sort.**
            return Object.values(topicMetadata)
                .filter(topic => quizletTrackingData[topic.id]?.quizletSetUrl) // Only consider topics with a URL
                .map(topic => {
                    const quizlet = quizletTrackingData[topic.id];
                    let score = 0;
                    if (topic.confidence <= 2) score += 50;
                    else if (topic.confidence === 3) score += 30;
                    
                    const daysSince = getDaysSince(quizlet.lastStudied);
                    if (daysSince >= (quizlet.studyFrequency || 7)) score += 40;
                    
                    if ((quizlet.studyCount || 0) < 3) score += 20;

                    // Ensure even newly added items that are not due have some score to be considered
                    if (score === 0 && !quizlet.lastStudied) score += 10;
                    
                    return { 
                        topic, 
                        quizlet, 
                        priorityScore: score, 
                        daysOverdue: Math.max(0, daysSince - (quizlet.studyFrequency || 7)) 
                    };
                })
                .sort((a, b) => b.priorityScore - a.priorityScore);
        }

        function renderQuizletQueue() {
            const allPriorityItems = getQuizletPriority();
            
            // **FIX 2.2: Filter for what is actually 'due' to be shown in the queue**
            const dueItems = allPriorityItems.filter(p => p.daysOverdue >= 0);
            
            document.getElementById('flashcardsDue').textContent = dueItems.length;
            if (!quizletQueueEl) return;

            if (dueItems.length === 0) {
                 if(Object.keys(quizletTrackingData).length > 0) {
                    quizletQueueEl.innerHTML = `<div class="text-center text-sm text-gray-500 dark:text-gray-400 p-2 italic">All caught up! Nothing to review today. üéâ</div>`;
                 } else {
                    quizletQueueEl.innerHTML = `<div class="text-center text-sm text-gray-500 dark:text-gray-400 p-2 italic">Nothing to review. Set up your Quizlet links!</div>`;
                 }
                return;
            }

            quizletQueueEl.innerHTML = dueItems.slice(0, 3).map(item => {
                const isUrgent = item.daysOverdue > 0;
                return `
                    <div class="p-2.5 bg-gray-100 dark:bg-gray-700/50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-semibold text-gray-800 dark:text-gray-200">${item.topic.id} ${item.topic.name}</span>
                            ${isUrgent ? `<span class="text-xs font-bold text-red-500">${item.daysOverdue}d overdue</span>` : `<span class="text-xs text-green-600 dark:text-green-400">Due today</span>`}
                        </div>
                        <div class="flex gap-2 mt-2">
                             <button onclick="window.openQuizlet('${item.topic.id}')" class="flex-1 text-xs text-center py-1.5 px-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-md transition">üì± Open</button>
                             <button onclick="window.markStudied('${item.topic.id}')" class="flex-1 text-xs text-center py-1.5 px-2 bg-white hover:bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 font-semibold rounded-md transition">‚úÖ Studied</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // --- Heatmap UI Rendering ---
        function renderHeatmap() {
            if (!heatmapGridEl || Object.keys(topicMetadata).length === 0) return;
            heatmapGridEl.innerHTML = Object.entries(TOPICS_DATABASE).map(([clusterId, cluster]) => {
                const clusterTopics = cluster.topics.map(t => topicMetadata[t.id]).filter(Boolean);
                const readyCount = clusterTopics.filter(t => t.confidence >= 4).length;
                return `
                    <div class="bg-gray-100 dark:bg-gray-800/50 rounded-lg p-4 flex flex-col">
                        <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-3 text-sm flex justify-between">${clusterId}: ${cluster.name} <span class="text-blue-500">${readyCount}/${cluster.topics.length}</span></h4>
                        <div class="space-y-3 flex-grow">
                            ${cluster.topics.map(t => renderTopicCard(topicMetadata[t.id])).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            updateStatistics();
            updatePriorityBanner();
        }

        function renderTopicCard(topic) {
            if (!topic) return '';
            const daysSince = getDaysSince(topic.lastReviewed);
            const isUrgent = daysSince > 7;
            const isPriority = topic.confidence <= 2 || isUrgent;
            const stars = Array.from({ length: 5 }, (_, i) => i < topic.confidence ? '‚≠ê' : '‚òÜ').join('');

            return `
                <div onclick="window.openTopicModal('${topic.id}')" class="topic-card bg-white dark:bg-gray-700 rounded-lg p-3 shadow-sm hover:shadow-md hover:border-blue-500 border-2 border-transparent transition-all cursor-pointer ${isPriority ? 'border-l-4 border-l-yellow-500' : ''}">
                    <div class="flex justify-between items-start">
                        <span class="text-sm font-semibold text-gray-800 dark:text-gray-200 pr-2">${topic.id} ${topic.name}</span>
                        ${isPriority ? '<span class="text-xs bg-yellow-400 text-white font-bold px-1.5 py-0.5 rounded-full" title="Priority">üî•</span>' : ''}
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-lg leading-none" title="Confidence: ${topic.confidence}/5">${stars}</span>
                        <span class="text-xs font-medium px-2 py-1 rounded-full ${isUrgent ? 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300' : 'bg-gray-200 text-gray-600 dark:bg-gray-600 dark:text-gray-300'}">
                            ${topic.lastReviewed ? (daysSince === 0 ? 'Today' : `${daysSince}d ago`) : 'Never'}
                        </span>
                    </div>
                </div>
            `;
        }
        
        function updateStatistics() {
            const topics = Object.values(topicMetadata);
            if (topics.length === 0) return;
            const readyTopics = topics.filter(t => t.confidence >= 4).length;
            const totalTopics = topics.length;
            document.getElementById('overallProgress').textContent = `${totalTopics > 0 ? Math.round((readyTopics / totalTopics) * 100) : 0}%`;
            document.getElementById('readyTopics').textContent = `${readyTopics}/${totalTopics}`;
            document.getElementById('needsReview').textContent = topics.filter(t => getDaysSince(t.lastReviewed) > 7).length;
            document.getElementById('topicsGreen').textContent = readyTopics;
        }

        function calculatePriorityScore(topicData) {
            if (!topicData) return 0;
            let score = 0;
            if (topicData.confidence <= 2) score += 50;
            else if (topicData.confidence === 3) score += 30;
            if (topicData.lastReviewed) {
                const daysSince = getDaysSince(topicData.lastReviewed);
                if (daysSince > 14) score += 40;
                else if (daysSince > 7) score += 25;
                else if (daysSince > 3) score += 10;
            } else {
                score += 60;
            }
            score *= topicData.weight || 1.0;
            return Math.round(score);
        }

        function updatePriorityBanner() {
            const banner = document.getElementById('priorityBanner');
            const listEl = document.getElementById('priorityList');
            if (!banner || !listEl || Object.keys(topicMetadata).length === 0) return;
            
            const priorityTopics = Object.values(topicMetadata)
                .map(t => ({ ...t, score: calculatePriorityScore(t) }))
                .sort((a, b) => b.score - a.score)
                .slice(0, 3);
            
            if (priorityTopics.length > 0 && priorityTopics[0].score > 40) {
                listEl.textContent = priorityTopics.map(t => t.id).join(', ');
                banner.style.display = 'block';
            } else {
                banner.style.display = 'none';
            }
        }
        
        async function saveHeatmapState() {
            if (!heatmapDocRef) return;
            try {
                await setDoc(heatmapDocRef, { metadata: topicMetadata });
            } catch (e) {
                console.error("Error saving heatmap state:", e);
                showToast("Failed to save progress.", "error");
            }
        }

        // --- All Modals and Interactions ---
        const topicModal = document.getElementById('topicModal');
        const topicModalBody = document.getElementById('topicModalBody');
        window.openTopicModal = (topicId) => {
            const topic = topicMetadata[topicId]; if (!topic) return;
            topicModalBody.innerHTML = `<h3 class="text-xl font-bold text-gray-900 dark:text-white mb-1">${topic.id}: ${topic.name}</h3><p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Cluster: ${topic.cluster}</p><div class="bg-gray-100 dark:bg-gray-700/50 p-4 rounded-lg mb-4"><p class="text-sm font-semibold text-gray-800 dark:text-gray-200 mb-2">Update Confidence:</p><div class="confidence-selector flex justify-center">${[1, 2, 3, 4, 5].map(level => `<span class="star-btn ${level <= topic.confidence ? 'active' : ''}" onclick="window.setConfidence('${topicId}', ${level})">‚≠ê</span>`).join('')}</div></div><button onclick="window.quickReview('${topicId}')" class="w-full text-center py-2 px-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition mb-4">Mark as Reviewed Now</button>`;
            topicModal.classList.remove('hidden');
        };
        window.closeTopicModal = () => topicModal.classList.add('hidden');
        window.setConfidence = (topicId, level) => { topicMetadata[topicId].confidence = level; topicMetadata[topicId].lastReviewed = new Date().toISOString(); showToast(`Confidence for ${topicId} set to ${level} stars!`, "success"); saveHeatmapState(); closeTopicModal(); };
        window.quickReview = (topicId) => { topicMetadata[topicId].lastReviewed = new Date().toISOString(); showToast(`${topicId} marked as reviewed!`, "success"); saveHeatmapState(); closeTopicModal(); };
        
        async function saveMissions() { if (missionsDocRef) await setDoc(missionsDocRef, { tasks: missions }); }
        function renderMissions() { if (!missionListEl) return; if (missions.length === 0) { missionListEl.innerHTML = `<div class="text-center text-sm text-gray-500 dark:text-gray-400 p-4 italic">No missions yet. Add one! üéØ</div>`; } else { missionListEl.innerHTML = missions.map(m => `<div class="flex items-center gap-3 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg group"><div onclick="window.toggleMission(${m.id})" class="w-6 h-6 rounded-md border-2 ${m.completed ? 'bg-blue-500 border-blue-500' : 'border-gray-300 dark:border-gray-500'} flex items-center justify-center cursor-pointer transition-colors flex-shrink-0">${m.completed ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}</div><span onclick="window.toggleMission(${m.id})" class="flex-grow text-sm text-gray-800 dark:text-gray-200 ${m.completed ? 'line-through opacity-50' : ''} cursor-pointer">${m.text}</span><button onclick="window.confirmDeleteMission(${m.id})" class="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity text-lg">&times;</button></div>`).join(''); } updateWeekProgress(); }
        window.addMission = () => { const text = newMissionInput.value.trim(); if (text) { missions.push({ id: Date.now(), text, completed: false }); newMissionInput.value = ''; saveMissions(); } };
        window.toggleMission = (id) => { const mission = missions.find(m => m.id === id); if (mission) { mission.completed = !mission.completed; saveMissions(); } };
        window.confirmDeleteMission = (id) => showConfirmation("Delete Mission", "Are you sure you want to delete this mission?", () => { missions = missions.filter(m => m.id !== id); saveMissions(); showToast("Mission deleted.", "success"); });
        window.confirmClearCompleted = () => { const completedCount = missions.filter(m => m.completed).length; if (completedCount === 0) { showToast("No completed missions to clear.", "info"); return; } showConfirmation("Clear Completed", `Clear ${completedCount} completed mission(s)?`, () => { missions = missions.filter(m => !m.completed); saveMissions(); showToast("Completed missions cleared.", "success"); }); };
        window.confirmResetWeek = () => { if (missions.length === 0) { showToast("No missions to reset.", "info"); return; } showConfirmation("Start New Week", "This will clear all current missions.", () => { missions = []; saveMissions(); showToast("New week started!", "success"); }); };
        function updateWeekProgress() { const total = missions.length; const completed = missions.filter(m => m.completed).length; if(weekProgressEl) weekProgressEl.textContent = `${total > 0 ? Math.round((completed / total) * 100) : 0}%`; }
        const modal = document.getElementById('confirmationModal'); const modalTitle = document.getElementById('modalTitle'); const modalMessage = document.getElementById('modalMessage'); const modalConfirm = document.getElementById('modalConfirm'); const modalCancel = document.getElementById('modalCancel'); let confirmCallback = null;
        function showConfirmation(title, message, onConfirm) { modalTitle.textContent = title; modalMessage.textContent = message; confirmCallback = onConfirm; modal.classList.remove('hidden'); }
        modalConfirm.addEventListener('click', () => { if (confirmCallback) confirmCallback(); modal.classList.add('hidden'); });
        modalCancel.addEventListener('click', () => { modal.classList.add('hidden'); });
        window.showToast = (message, type = 'info') => { const container = document.getElementById('toastContainer'); const toast = document.createElement('div'); const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500' }; toast.className = `toast text-white text-sm font-semibold py-2 px-4 rounded-lg shadow-lg ${colors[type]}`; toast.textContent = message; container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 3000); };
        const caseDeckModal = document.getElementById('caseDeckModal');
        window.openCaseDeck = () => caseDeckModal.classList.remove('hidden');
        window.closeCaseDeck = () => caseDeckModal.classList.add('hidden');
        window.openAtomicNotes = () => window.open('geography-atomic-note.html', '_blank');
        newMissionInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addMission(); });
        
        const quizletManagerModal = document.getElementById('quizletManagerModal');
        const quizletManagerBody = document.getElementById('quizletManagerBody');
        const studyFeedbackModal = document.getElementById('studyFeedbackModal');
        window.openQuizlet = (topicId) => { const url = quizletTrackingData[topicId]?.quizletSetUrl; if (url) { window.open(url, '_blank'); } else { showToast("No Quizlet URL set for this topic.", "error"); } };
        window.openQuizletManager = () => { quizletManagerBody.innerHTML = Object.values(TOPICS_DATABASE).flatMap(cluster => cluster.topics).map(topic => { const tracking = quizletTrackingData[topic.id] || {}; return `<div class="flex items-center gap-3 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg"><span class="font-semibold text-sm w-28 flex-shrink-0">${topic.id}</span><input type="url" id="quizlet-url-${topic.id}" class="flex-grow bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-600 focus:border-blue-500 rounded-lg p-2 text-sm outline-none transition" value="${tracking.quizletSetUrl || ''}" placeholder="Paste Quizlet Set URL here..."><button onclick="window.saveQuizletLink('${topic.id}')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold rounded-lg transition">Save</button></div>`; }).join(''); quizletManagerModal.classList.remove('hidden'); };
        window.closeQuizletManager = () => quizletManagerModal.classList.add('hidden');
        window.saveQuizletLink = (topicId) => { const urlInput = document.getElementById(`quizlet-url-${topicId}`); if (!quizletTrackingData[topicId]) { quizletTrackingData[topicId] = { studyFrequency: 7, studyCount: 0, lastStudied: null, history: [] }; } quizletTrackingData[topicId].quizletSetUrl = urlInput.value.trim(); saveQuizletData().then(() => showToast("Quizlet link saved!", "success")); };
        window.markStudied = (topicId) => { document.getElementById('studyFeedbackTitle').textContent = `Great! You studied ${topicId} üéâ`; document.getElementById('feedbackBtnHard').onclick = () => window.saveStudy(topicId, 1); document.getElementById('feedbackBtnGood').onclick = () => window.saveStudy(topicId, 3); document.getElementById('feedbackBtnEasy').onclick = () => window.saveStudy(topicId, 5); studyFeedbackModal.classList.remove('hidden'); };
        window.saveStudy = (topicId, rating) => { const time = document.getElementById('studyTimeInput').value || 15; const data = quizletTrackingData[topicId]; if (!data) return; data.lastStudied = new Date().toISOString(); data.studyCount = (data.studyCount || 0) + 1; if (!data.history) data.history = []; data.history.push({ date: data.lastStudied, duration: parseInt(time), selfRating: rating }); const intervals = {1: 1, 3: 3, 5: 7}; data.studyFrequency = intervals[rating] || 3; saveQuizletData().then(() => { showToast(`${topicId} marked as studied! Next review in ${data.studyFrequency} days`, "success"); }); topicMetadata[topicId].lastReviewed = data.lastStudied; saveHeatmapState(); closeStudyFeedbackModal(); };
        window.closeStudyFeedbackModal = () => { document.getElementById('studyTimeInput').value = ''; studyFeedbackModal.classList.add('hidden'); };
        
        // --- INITIALIZE ---
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>

