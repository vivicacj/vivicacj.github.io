<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chemistry A1 Sprint Study Plan</title>
    <!-- ÂºïÂÖ• Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* --- CSS styles remain unchanged --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; line-height: 1.6; min-height: 100vh; }
        .container { max-width: 1200px; margin: 30px auto 0 auto; padding: 20px; }
        .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 20px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-radius: 15px; margin-bottom: 30px; }
        .title { color: #2c3e50; font-size: 2.2em; font-weight: 700; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .subtitle { color: #7f8c8d; font-size: 1.1em; font-weight: 500; }
        .back-link { display: block; color: #3498db; text-decoration: none; font-weight: 600; margin-top: 10px; transition: color 0.3s ease; }
        .back-link:hover { color: #2980b9; text-decoration: underline; }
        .countdown-section { padding: 30px 20px; text-align: center; background: rgba(255, 255, 255, 0.1); border-radius: 20px; backdrop-filter: blur(10px); margin-bottom: 30px; }
        .countdown-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .countdown-card { background: linear-gradient(135deg, #4834d4, #686de0); color: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .countdown-card.paper1 { background: linear-gradient(135deg, #ff6b6b, #ee5a24); }
        .countdown-title { font-size: 1.4em; font-weight: 600; margin-bottom: 15px; }
        .countdown-display { font-size: 2.5em; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .countdown-unit { font-size: 0.8em; opacity: 0.9; margin-top: 5px; }
        .progress-overview { background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .progress-bar { width: 100%; height: 12px; background: #ecf0f1; border-radius: 6px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #00b894, #00cec9); transition: width 0.5s ease; border-radius: 6px; }
        .week-section { background: rgba(255, 255, 255, 0.95); margin-bottom: 30px; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .week-header { background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; padding: 20px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        .week-content { display: none; padding: 25px; }
        .week-content.active { display: block; animation: slideDown 0.3s ease; }
        .week-goal { background-color: #f8f9fa; border-left: 4px solid #0984e3; padding: 15px; margin-bottom: 20px; border-radius: 4px; color: #2c3e50; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .task-table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
        .task-table th, .task-table td { padding: 15px; text-align: left; border-bottom: 1px solid #ecf0f1; vertical-align: middle; }
        .task-table th { background-color: #f1f3f5; font-weight: 600; }
        .task-row:hover { background: #f8f9fa; }
        .day-cell { width: 8%; font-weight: 700; color: #2c3e50; }
        .mission-cell { width: 22%; font-weight: 600; }
        .details-cell { width: 50%; }
        .status-cell { width: 20%; text-align: center; }
        .status-content { display: flex; align-items: center; justify-content: flex-start; gap: 15px; }
        .task-checkbox { transform: scale(1.3); cursor: pointer; flex-shrink: 0; }
        .task-completed .details-cell, .task-completed .mission-cell, .task-completed .day-cell { text-decoration: line-through; opacity: 0.6; }
        .task-row.task-completed { background-color: #f7fdfb; }
        .details-cell code { background-color: #e9ecef; padding: 3px 6px; border-radius: 4px; font-family: 'SF Mono', 'Consolas', monospace; color: #c7254e; }
        .link-area { display: flex; align-items: center; flex-wrap: wrap; gap: 6px; }
        .link-pill, .add-link-btn { padding: 4px 10px; font-size: 0.8em; font-weight: 600; border-radius: 20px; border: 1px solid #3498db; background-color: #eaf2f8; color: #2980b9; cursor: pointer; transition: all 0.2s ease; text-decoration: none; display: inline-block; }
        .link-pill:hover, .add-link-btn:hover { background-color: #d4e6f1; border-color: #2980b9; }
        .add-link-btn { border-style: dashed; background-color: transparent; color: #3498db; }
        .expand-icon { transition: transform 0.3s ease; }
        .expand-icon.rotated { transform: rotate(180deg); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: linear-gradient(135deg, #a29bfe, #6c5ce7); color: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .stat-number { font-size: 2em; font-weight: 700; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
        .floating-action { position: fixed; bottom: 30px; right: 30px; background: linear-gradient(135deg, #ff7675, #d63031); color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 1.5em; cursor: pointer; box-shadow: 0 4px 20px rgba(0,0,0,0.3); transition: all 0.3s ease; }
        .floating-action:hover { transform: scale(1.1); box-shadow: 0 6px 25px rgba(0,0,0,0.4); }
        @media (max-width: 992px) { .details-cell { width: 45%; } .status-cell { width: 25%; } }
        @media (max-width: 768px) { .task-table, .task-table th, .task-table td { display: block; width: 100% !important; text-align: left !important; } .task-table thead { display: none; } .task-table tr { margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; } .task-table td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 40%; } .task-table td:before { position: absolute; left: 15px; width: 35%; font-weight: bold; content: attr(data-label); } .status-cell { display: flex; align-items: center; } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { font-size: 1.4em; color: #2c3e50; margin-bottom: 15px; }
        .modal-input { width: 100%; padding: 10px; font-size: 1em; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 20px; }
        .modal-actions { display: flex; justify-content: space-between; gap: 10px; }
        .modal-btn { padding: 10px 20px; border-radius: 5px; border: none; font-size: 0.9em; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .modal-btn-primary { background-color: #3498db; color: white; }
        .modal-btn-primary:hover { background-color: #2980b9; }
        .modal-btn-secondary { background-color: #ecf0f1; color: #34495e; }
        .modal-btn-secondary:hover { background-color: #bdc3c7; }
        .modal-btn-danger { background-color: #e74c3c; color: white; margin-right: auto; }
        .modal-btn-danger:hover { background-color: #c0392b; }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1 class="title">üéØ Chemistry Sprint Study Plan</h1>
            <p class="subtitle">7-Day Paper 2 Comprehensive Review Plan - Dynamic Tracking System</p>
            <a href="index.html" class="back-link">‚ùÆ ËøîÂõûÂ≠¶‰π†‰ª™Ë°®Áõò</a>
        </div>
        
        <!-- COUNTDOWN -->
        <div class="countdown-section">
            <h2 style="color: white; margin-bottom: 20px; font-size: 1.5em;">‚è∞ Exam Countdown</h2>
            <div class="countdown-grid">
                <div class="countdown-card">
                    <div class="countdown-title">üìã Paper 2</div>
                    <div class="countdown-display" id="paper2-countdown">--</div>
                    <div class="countdown-unit">days to exam</div>
                </div>
                <div class="countdown-card paper1">
                    <div class="countdown-title">üìù Paper 1</div>
                    <div class="countdown-display" id="paper1-countdown">--</div>
                    <div class="countdown-unit">days to exam</div>
                </div>
            </div>
        </div>
        
        <!-- PROGRESS OVERVIEW -->
        <div class="progress-overview">
             <h3 style="margin-bottom: 20px; color: #2c3e50;">üìä Overall Progress Overview</h3>
             <div class="stats-grid">
                  <div class="stat-card"> <div class="stat-number" id="total-tasks">0</div> <div class="stat-label">Total Tasks</div> </div>
                  <div class="stat-card"> <div class="stat-number" id="completed-tasks">0</div> <div class="stat-label">Completed</div> </div>
                  <div class="stat-card"> <div class="stat-number" id="completion-rate">0%</div> <div class="stat-label">Completion Rate</div> </div>
                  <div class="stat-card"> <div class="stat-number" id="days-remaining">--</div> <div class="stat-label">Days Left</div> </div>
             </div>
             <div class="progress-bar"> <div class="progress-fill" id="overall-progress" style="width: 0%"></div> </div>
        </div>

        <!-- CHEMISTRY PLAN SECTION -->
        <div class="week-section">
            <div class="week-header" onclick="toggleWeek(1)">
                <span>üî• Chemistry Sprint: Paper 2 Assault (Sep 27 - Oct 3)</span>
                <span class="expand-icon" id="icon-1">‚ñº</span>
            </div>
            <div class="week-content" id="week-1">
                <p class="week-goal"><strong>Core Goal (Sep 27 - Oct 1):</strong> Annihilate all core topic weaknesses for Paper 2 and build unshakable confidence.</p>
                <table class="task-table">
                    <thead>
                        <tr>
                            <th class="day-cell">Day</th>
                            <th class="mission-cell">Core Mission</th>
                            <th class="details-cell">Specific Asset/Practice List</th>
                            <th class="status-cell">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Day: Saturday -->
                        <tr class="task-row" data-task-index="0">
                            <td class="day-cell" data-label="Day" rowspan="3"><strong>Sat</strong><br>(Sep 27)</td>
                            <td class="mission-cell" data-label="Mission" rowspan="3"><strong>Diagnosis & Foundation</strong></td>
                            <td class="details-cell" data-label="Task">üèÜ <strong>Task:</strong> Complete one full <strong>Paper 2</strong> from the practice set under strict timed conditions.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="1">
                            <td class="details-cell" data-label="Task">‚úçÔ∏è <strong>Task:</strong> Create your "Mistake Analysis Log". For every error, classify it using the 5 Error Types (M/P/C/Q/L-Error).</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                         <tr class="task-row" data-task-index="2">
                            <td class="details-cell" data-label="Task">üìö <strong>Task:</strong> Master all <strong>Level 1: Fact & Definition Flashcards</strong> for ALL topics (Core + Satellite).</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <!-- Day: Sunday -->
                        <tr class="task-row" data-task-index="3">
                            <td class="day-cell" data-label="Day" rowspan="3"><strong>Sun</strong><br>(Sep 28)</td>
                            <td class="mission-cell" data-label="Mission" rowspan="3"><strong>Core Assault (Batch 1)</strong></td>
                            <td class="details-cell" data-label="Task">‚úÖ <strong>Task:</strong> Complete all Paper 2 questions from the <code>Acids, Bases & Salts / QA</code> drill package.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="4">
                            <td class="details-cell" data-label="Task">‚öñÔ∏è <strong>Task:</strong> Complete all questions from the <code>Stoichiometry & Mole Concept</code> drill package.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="5">
                             <td class="details-cell" data-label="Task">‚úçÔ∏è <strong>Task:</strong> For every error, update your "Mistake Analysis Log" and immediately review the corresponding AKM.</td>
                             <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <!-- And so on for other days -->
                         <tr class="task-row" data-task-index="6">
                            <td class="day-cell" data-label="Day" rowspan="3"><strong>Mon</strong><br>(Sep 29)</td>
                            <td class="mission-cell" data-label="Mission" rowspan="3"><strong>Core Assault (Batch 2)</strong></td>
                            <td class="details-cell" data-label="Task">üîó <strong>Task:</strong> Complete all Paper 2 questions from the <code>Chemical Bonding & Structure</code> drill package.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="7">
                            <td class="details-cell" data-label="Task">‚ö° <strong>Task:</strong> Complete all Paper 2 questions from the <code>Redox & Reactivity</code> drill package.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="8">
                             <td class="details-cell" data-label="Task">üìö <strong>Task:</strong> Master all <strong>Level 2 (SOP), Level 3 (Conceptual), and Level 4 (Pitfall)</strong> Flashcards for all Core Topics.</td>
                             <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="9">
                            <td class="day-cell" data-label="Day" rowspan="3"><strong>Tue</strong><br>(Sep 30)</td>
                            <td class="mission-cell" data-label="Mission" rowspan="3"><strong>Final Simulation & Precision Strike</strong></td>
                            <td class="details-cell" data-label="Task">‚è≥ <strong>Task:</strong> Complete a new, unseen <strong>Paper 2</strong> under strict exam conditions (2h 10min).</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="10">
                            <td class="details-cell" data-label="Task">üéØ <strong>Task:</strong> Perform a "surgical analysis" on your errors. Identify the weakest <strong>Core Competency</strong> on your Radar Chart.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="11">
                             <td class="details-cell" data-label="Task">‚öîÔ∏è <strong>Task:</strong> Dedicate the rest of the day to a "precision strike" on that single weakest area using atomic notes and drills.</td>
                             <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="12">
                            <td class="day-cell" data-label="Day" rowspan="3"><strong>Wed</strong><br>(Oct 1)</td>
                            <td class="mission-cell" data-label="Mission" rowspan="3"><strong>Zen Day & Consolidation</strong></td>
                            <td class="details-cell" data-label="Task">üß† <strong>Task:</strong> Read through your "Mistake Analysis Log" one last time.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="13">
                            <td class="details-cell" data-label="Task">üßò <strong>Task:</strong> Read through the <strong>Quick-Look Cheat Sheets</strong> for all Core Topics until they are internalized.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="14">
                            <td class="details-cell" data-label="Task">üòå <strong>Task:</strong> No new questions. Relax your mind. Pack your stationery. Get a full night's sleep.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="15">
                            <td class="day-cell" data-label="Day"><strong>Thu</strong><br>(Oct 2)</td>
                            <td class="mission-cell" data-label="Mission"><strong>P2 BATTLE DAY</strong></td>
                            <td class="details-cell" data-label="Task">üöÄ <strong>Task:</strong> Quick scan of the <strong>Cheat Sheets</strong> only. Trust your preparation. Good luck!</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="16">
                            <td class="day-cell" data-label="Day"><strong>Fri</strong><br>(Oct 3)</td>
                            <td class="mission-cell" data-label="Mission"><strong>P1 BATTLE DAY</strong></td>
                            <td class="details-cell" data-label="Task">üöÄ <strong>Task:</strong> Quick run-through of <strong>Level 1 Flashcards</strong> to activate broad knowledge. Good luck!</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL AND FLOATING BUTTON -->
    <button class="floating-action" onclick="resetProgress()" title="Reset Progress">üîÑ</button>
    <div id="link-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="modal-title">Edit Link</h3>
            <input id="modal-input" type="url" class="modal-input" placeholder="https://docs.google.com/...">
            <div class="modal-actions">
                <button id="modal-btn-delete" class="modal-btn modal-btn-danger">Delete</button>
                <button id="modal-btn-cancel" class="modal-btn modal-btn-secondary">Cancel</button>
                <button id="modal-btn-save" class="modal-btn modal-btn-primary">Save & Open</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDdtQYfOC87IvpTZPFoDyb6ZgpEISzqw_I",
            authDomain: "emath-study-plan.firebaseapp.com",
            projectId: "emath-study-plan",
            storageBucket: "emath-study-plan.firebasestorage.app",
            messagingSenderId: "589299697460",
            appId: "1:589299697460:web:df1e0bb0586b3740c04761",
            measurementId: "G-09QVE4GLS0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const docRef = db.collection("sprintPlan").doc("chemistry_tasks_v1");

        // --- 2. LOCAL CONFIGURATION & GLOBAL VARS ---
        const paper2Date = new Date('2025-10-02');
        const paper1Date = new Date('2025-10-03');
        const MAX_LINKS_PER_TASK = 3;
        let currentModalCallback = null;

        // --- Ê†∏ÂøÉ‰øÆÊ≠£ÔºöÊ≠§ÂáΩÊï∞Áé∞Âú®‰ºö‰ªé HTML Ë°®Ê†º‰∏≠ÊèêÂèñÂÆåÊï¥ÁöÑÊï∞ÊçÆ ---
        function getInitialTaskData() {
            const allTasks = [];
            const rows = document.querySelectorAll('.task-row[data-task-index]');
            let currentDay = '';
            let currentMission = '';

            rows.forEach(row => {
                const dayCell = row.querySelector('.day-cell');
                if (dayCell) {
                    currentDay = dayCell.textContent.trim().split('\n')[0].replace(/\s/g, ''); // Extract just 'Sat', 'Sun', etc.
                }

                const missionCell = row.querySelector('.mission-cell');
                if (missionCell) {
                    currentMission = missionCell.textContent.trim();
                }

                const detailsCell = row.querySelector('.details-cell');
                const missionText = detailsCell ? detailsCell.textContent.trim().replace('Task:', '').trim() : 'No details';
                
                allTasks.push({
                    day: currentDay,
                    mission: missionText, // Using detailed task as the mission
                    coreMission: currentMission, // Storing the overarching mission
                    checked: false,
                    links: []
                });
            });
            return allTasks;
        }
        
        // --- 3. CORE DATA & UI FUNCTIONS ---
        function getProgressData() { 
            const d = sessionStorage.getItem('localDataCache'); 
            if (d) { 
                try { return JSON.parse(d); } catch(e){} 
            }
            // If no cache, generate from HTML
            return getInitialTaskData();
        }

        function saveProgressData(data) { 
            sessionStorage.setItem('localDataCache', JSON.stringify(data)); 
            // Save the complete data object to Firebase
            docRef.set({ allTasks: data }).catch(e => console.error("Firebase save error: ", e)); 
        }

        function renderLinksForTask(taskIndex, links) { 
            const linkArea = document.querySelector(`.task-row[data-task-index="${taskIndex}"] .link-area`); 
            if (!linkArea) return; 
            linkArea.innerHTML = ''; 
            links.forEach((link, linkIndex) => { 
                const pill = document.createElement('a'); 
                pill.className = 'link-pill'; 
                pill.textContent = `Link ${linkIndex + 1}`; 
                pill.href = link; 
                pill.target = '_blank'; // Open in new tab
                pill.dataset.linkIndex = linkIndex; 
                linkArea.appendChild(pill); 
            }); 
            if (links.length < MAX_LINKS_PER_TASK) { 
                const addButton = document.createElement('button'); 
                addButton.className = 'add-link-btn'; 
                addButton.textContent = '‚ûï Add'; 
                linkArea.appendChild(addButton); 
            } 
        }

        function loadProgress(data) { 
            const rows = document.querySelectorAll('.task-row[data-task-index]'); 
            rows.forEach((row) => { 
                const idx = parseInt(row.dataset.taskIndex, 10);
                // Ensure data from Firebase has priority, but fall back to initial structure
                const taskData = data[idx] || {checked: false, links: []};
                const cb = row.querySelector('.task-checkbox'); 
                if (cb) cb.checked = taskData.checked; 
                renderLinksForTask(idx, taskData.links || []); // Ensure links is an array
            }); 
            sessionStorage.setItem('localDataCache', JSON.stringify(data)); 
            updateOverallProgress(); 
        }

        // --- CUSTOM MODAL FUNCTIONS ---
        function showModal(config) {
            const modal = document.getElementById('link-modal');
            const titleEl = document.getElementById('modal-title');
            const inputEl = document.getElementById('modal-input');
            const deleteBtn = document.getElementById('modal-btn-delete');
            titleEl.textContent = config.title;
            inputEl.value = config.value || '';
            deleteBtn.style.display = config.showDelete ? 'block' : 'none';
            modal.classList.add('visible');
            inputEl.focus();
            currentModalCallback = (result) => {
                modal.classList.remove('visible');
                config.callback(result);
                currentModalCallback = null;
            };
        }

        // --- EVENT HANDLING ---
        function handleTableClick(event) {
            const target = event.target;
            const row = target.closest('.task-row[data-task-index]');
            if (!row) return;
            const taskIndex = parseInt(row.dataset.taskIndex, 10);
            let data = getProgressData();
            let taskData = data[taskIndex];
            
            if (target.matches('.task-checkbox')) {
                taskData.checked = target.checked;
                saveProgressData(data);
                // No need to call updateOverallProgress here, as listenForProgressChanges will do it
                return;
            }
            if (target.matches('.add-link-btn')) {
                showModal({
                    title: 'Add New Link',
                    value: 'https://',
                    showDelete: false,
                    callback: (result) => {
                        if (result.action === 'save' && result.value && result.value !== 'https://') {
                            if (!taskData.links) taskData.links = [];
                            taskData.links.push(result.value);
                            saveProgressData(data);
                        }
                    }
                });
                return;
            }
            if (target.matches('.link-pill')) {
                event.preventDefault();
                const linkIndex = parseInt(target.dataset.linkIndex, 10);
                const currentLink = taskData.links[linkIndex];
                showModal({
                    title: `Edit Link ${linkIndex + 1}`,
                    value: currentLink,
                    showDelete: true,
                    callback: (result) => {
                        if (result.action === 'save') {
                            taskData.links[linkIndex] = result.value;
                            window.open(result.value, '_blank');
                        } else if (result.action === 'delete') {
                            taskData.links.splice(linkIndex, 1);
                        }
                        saveProgressData(data);
                    }
                });
            }
        }
        
        function listenForProgressChanges() { 
            docRef.onSnapshot((doc) => { 
                if (doc.exists && doc.data().allTasks && doc.data().allTasks.length > 0) { 
                    loadProgress(doc.data().allTasks); 
                } else { 
                    // If doc doesn't exist or is empty, create it from the HTML table
                    console.log("No data in Firebase. Initializing from HTML table.");
                    const initialData = getInitialTaskData();
                    saveProgressData(initialData); 
                    loadProgress(initialData);
                } 
            }, (e) => { 
                console.error("Firebase listen error:", e); 
                alert("Cloud connection error. Progress may not be saved."); 
            }); 
        }

        // --- UTILITY & UI ---
        function updateOverallProgress() { 
            const data = getProgressData();
            const total = data.length;
            const completed = data.filter(task => task.checked).length;
            
            document.querySelectorAll('.task-row[data-task-index]').forEach(row => { 
                const idx = parseInt(row.dataset.taskIndex, 10);
                if (data[idx] && data[idx].checked) { 
                    row.classList.add('task-completed'); 
                } else { 
                    row.classList.remove('task-completed'); 
                } 
            }); 
            
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0; 
            document.getElementById('total-tasks').textContent = total; 
            document.getElementById('completed-tasks').textContent = completed; 
            document.getElementById('completion-rate').textContent = `${rate}%`; 
            document.getElementById('overall-progress').style.width = `${rate}%`; 
        }
        function updateCountdown() { const now = new Date(); const p1d = Math.ceil((paper1Date - now) / (1000*60*60*24)); const p2d = Math.ceil((paper2Date - now) / (1000*60*60*24)); document.getElementById('paper1-countdown').textContent = p1d > 0 ? `${p1d}` : 'Done'; document.getElementById('paper2-countdown').textContent = p2d > 0 ? `${p2d}` : 'Done'; const rem = Math.max(0, Math.min(p1d > 0 ? p1d : Infinity, p2d > 0 ? p2d : Infinity)); document.getElementById('days-remaining').textContent = rem === Infinity ? '0' : rem; }
        function toggleWeek(num) { const c = document.getElementById(`week-${num}`); const i = document.getElementById(`icon-${num}`); c.classList.toggle('active'); i.classList.toggle('rotated'); }
        function resetProgress(force = false) { if (force || confirm('This will reset all progress and links for everyone. Are you sure?')) { const initialData = getInitialTaskData(); saveProgressData(initialData); } }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            updateCountdown();
            setInterval(updateCountdown, 60000);
            listenForProgressChanges();
            document.querySelector('.container').addEventListener('click', handleTableClick);
            document.getElementById('modal-btn-save').addEventListener('click', () => { if (currentModalCallback) currentModalCallback({ action: 'save', value: document.getElementById('modal-input').value.trim() }); });
            document.getElementById('modal-btn-cancel').addEventListener('click', () => { if (currentModalCallback) currentModalCallback({ action: 'cancel' }); });
            document.getElementById('modal-btn-delete').addEventListener('click', () => { if (currentModalCallback) currentModalCallback({ action: 'delete' }); });
            document.getElementById('link-modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) { if (currentModalCallback) currentModalCallback({ action: 'cancel' }); } });
            toggleWeek(1);
        });
    </script>
</body>
</html>
