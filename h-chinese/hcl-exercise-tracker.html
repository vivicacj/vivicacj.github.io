<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oæ°´å‡†é«˜çº§åæ–‡ç»ƒä¹ å¹³å° (å®æ—¶äº‘åŒæ­¥ç‰ˆ)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        /* CSSæ ·å¼éƒ¨åˆ†ä¿æŒä¸å˜ */
        :root {
            --primary-color: #667eea;
            --text-on-dark: rgba(255, 255, 255, 0.95);
            --card-background: rgba(255, 255, 255, 0.98);
            --text-color: #34495e;
            --text-light: #7f8c8d;
            --border-color: rgba(0, 0, 0, 0.08);
            --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-color);
            padding-top: 90px;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 30px; }
        .header { background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.2); position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; padding: 0 30px; }
        .logo { font-size: 1.8rem; font-weight: 700; color: white; text-shadow: 1px 1px 5px rgba(0,0,0,0.2); }
        .main-content { padding: 40px 0; }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        .section-title { font-size: 2.2rem; font-weight: 700; color: var(--text-on-dark); text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 500; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: white; color: var(--primary-color); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-primary:hover { background-color: #f8f9fa; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .btn-secondary { background: rgba(255,255,255,0.2); color: var(--text-on-dark); border: 1px solid rgba(255,255,255,0.3); }
        .btn-secondary:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
        .toolbar { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); border-radius: 12px; box-shadow: var(--shadow-md); margin-bottom: 40px; flex-wrap: wrap; gap: 20px; }
        .search-box { display: flex; align-items: center; background: #f1f3f5; border-radius: 8px; padding: 8px 12px; min-width: 250px; }
        .search-box input { border: none; outline: none; flex: 1; font-size: 14px; background: transparent; }
        .filter-tabs { display: flex; gap: 8px; }
        .filter-tab { padding: 8px 16px; background: #e9ecef; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; font-size: 0.9rem; font-weight: 500; color: var(--text-light); }
        .filter-tab.active { background: var(--primary-color); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .practice-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; }
        .practice-card { background: var(--card-background); border-radius: 16px; box-shadow: var(--shadow-md); transition: all 0.3s ease; overflow: visible; position: relative; }
        .practice-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-lg); }
        .card-header { padding: 20px; color: white; position: relative; border-radius: 16px 16px 0 0; }
        .card-header-practical-writing { background: linear-gradient(135deg, #2b8a3e, #51cf66); }
        .card-header-composition { background: linear-gradient(135deg, #e8590c, #fd7e14); }
        .card-header-language-application { background: linear-gradient(135deg, #c92a2a, #fa5252); }
        .card-header-reading-1 { background: linear-gradient(135deg, #1971c2, #339af0); }
        .card-header-reading-2 { background: linear-gradient(135deg, #0b7285, #15aabf); }
        .card-header-summary { background: linear-gradient(135deg, #a61e4d, #f06595); }
        .card-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 5px; }
        .card-meta { font-size: 0.85rem; opacity: 0.9; }
        .card-content { padding: 25px; }
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .info-item { background: #f8f9fa; border-radius: 8px; padding: 10px; text-align: center; }
        .info-label { font-size: 0.8rem; color: var(--text-light); }
        .info-value { font-weight: 500; }
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; color: white; }
        .status-completed { background-color: #28a745; }
        .status-pending { background-color: #fd7e14; }
        .status-new { background-color: #1c7ed6; }
        .difficulty-badge { font-weight: 500; }
        .difficulty-beginner { color: #28a745; }
        .difficulty-intermediate { color: #fd7e14; }
        .difficulty-advanced { color: #c92a2a; }
        .card-actions-menu { position: absolute; top: 15px; right: 15px; width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(255, 255, 255, 0.2); color: white; font-size: 1.5rem; line-height: 1; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
        .card-actions-menu:hover { background: rgba(255, 255, 255, 0.4); }
        .card-menu { display: none; position: absolute; top: 55px; right: 15px; background: white; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); z-index: 10; overflow: hidden; animation: fadeInMenu 0.2s ease-out; }
        .card-menu.show { display: block; }
        @keyframes fadeInMenu { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .card-menu-item { display: flex; align-items: center; gap: 10px; padding: 12px 20px; border: none; background: none; width: 100%; text-align: left; cursor: pointer; font-size: 0.9rem; color: var(--text-color); }
        .card-menu-item:hover { background-color: #f1f3f5; }
        .card-menu-item.delete { color: #e74c3c; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal-header { font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-input, .form-select { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; font-size: 1rem; transition: all 0.2s ease; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px; }
        #batchUploadModal .modal-content { max-width: 700px; }
        .upload-tab-nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .upload-tab { display: none; }
        .upload-tab.active { display: block; }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">âœï¸ é«˜çº§åæ–‡ãƒ»ç»ƒä¹ ä¸­æ¢ (å®æ—¶äº‘åŒæ­¥ç‰ˆ)</div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openPracticeModal()">â• æ·»åŠ ç»ƒä¹ </button>
                    <button class="btn btn-secondary" onclick="openBatchUploadModal()">ğŸ“ æ‰¹é‡ä¸Šä¼ </button>
                    <button class="btn btn-secondary" onclick="exportProgress()">ğŸ“Š å¯¼å‡ºè¿›åº¦</button>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="content-header">
                <h1 class="section-title" id="sectionTitle">ä¸“é¡¹è€ƒé¢˜ä¸€ï¼šå®ç”¨æ–‡</h1>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <select class="form-input" id="sectionSelect" onchange="changeSection()" style="max-width: 250px;">
                        <option value="practical-writing">ä¸“é¡¹è€ƒé¢˜ä¸€ï¼šå®ç”¨æ–‡</option>
                        <option value="composition">ä¸“é¡¹è€ƒé¢˜äºŒï¼šä½œæ–‡</option>
                        <option value="language-application">ä¸“é¡¹è€ƒé¢˜ä¸‰ï¼šè¯­æ–‡åº”ç”¨</option>
                        <option value="reading-1">ä¸“é¡¹è€ƒé¢˜å››ï¼šé˜…è¯»ç†è§£ä¸€</option>
                        <option value="reading-2">ä¸“é¡¹è€ƒé¢˜äº”ï¼šé˜…è¯»ç†è§£äºŒ</option>
                        <option value="summary">ä¸“é¡¹è€ƒé¢˜å…­ï¼šç‰‡æ®µç¼©å†™</option>
                        <option value="all-sections">ğŸ” æŸ¥çœ‹å…¨éƒ¨é¢˜å‹</option>
                    </select>
                </div>
            </div>

            <div class="toolbar">
                <div class="search-box">
                    <span>ğŸ”</span>
                    <input type="text" placeholder="æŒ‰åç§°æœç´¢..." id="searchInput">
                </div>
                <div class="filter-tabs">
                    <button class="filter-tab active" data-filter="all">å…¨éƒ¨</button>
                    <button class="filter-tab" data-filter="completed">å·²å®Œæˆ</button>
                    <button class="filter-tab" data-filter="pending">è¿›è¡Œä¸­</button>
                    <button class="filter-tab" data-filter="new">æ–°é¢˜ç›®</button>
                </div>
            </div>

            <div class="practice-grid" id="practiceGrid">
                 <p style="color: white; text-align: center; grid-column: 1 / -1; font-size: 1.1rem; padding: 50px 0;">æ­£åœ¨è¿æ¥äº‘ç«¯ï¼Œè¯·ç¨å€™...</p>
            </div>
        </div>
    </main>
    
    <div class="modal" id="practiceModal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">æ·»åŠ æ–°ç»ƒä¹ </div>
            <form id="practiceForm">
                <div class="form-group">
                    <label class="form-label" for="practiceName">ç»ƒä¹ åç§° *</label>
                    <input type="text" class="form-input" id="practiceName" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="practiceType">ç»ƒä¹ ç±»å‹</label>
                    <select class="form-select" id="practiceType"></select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="documentContent">ç»ƒä¹ å†…å®¹/é“¾æ¥ *</label>
                    <textarea class="form-input" id="documentContent" rows="4" placeholder="è¾“å…¥ç»ƒä¹ å†…å®¹æˆ–ç²˜è´´æ–‡æ¡£é“¾æ¥..." required></textarea>
                    <small style="color: #6c757d; font-size: 0.85rem;">æç¤ºï¼šå¯ä»¥ç›´æ¥è¾“å…¥ç»ƒä¹ é¢˜ç›®å†…å®¹ï¼Œæˆ–ç²˜è´´Google Docsã€OneDriveç­‰æ–‡æ¡£é“¾æ¥</small>
                </div>
                <div class="form-group">
                    <label class="form-label" for="contentType">å†…å®¹ç±»å‹</label>
                    <select class="form-select" id="contentType">
                        <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                        <option value="text">æ–‡æœ¬å†…å®¹</option>
                        <option value="link">å¤–éƒ¨é“¾æ¥</option>
                    </select>
                    <small style="color: #6c757d; font-size: 0.85rem;">å¦‚æœè‡ªåŠ¨æ£€æµ‹ä¸å‡†ç¡®ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å†…å®¹ç±»å‹</small>
                </div>
                <div class="form-group">
                    <label class="form-label" for="practiceStatus">çŠ¶æ€</label>
                    <select class="form-select" id="practiceStatus">
                        <option value="new">æ–°é¢˜ç›®</option>
                        <option value="pending">è¿›è¡Œä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="difficultyLevel">éš¾åº¦ç­‰çº§</label>
                    <select class="form-select" id="difficultyLevel">
                        <option value="beginner">åˆçº§</option>
                        <option value="intermediate">ä¸­çº§</option>
                        <option value="advanced">é«˜çº§</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="estimatedTime">é¢„è®¡æ—¶é—´ (åˆ†é’Ÿ)</label>
                    <input type="number" class="form-input" id="estimatedTime" min="5">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closePracticeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" id="saveButton">ä¿å­˜åˆ°äº‘ç«¯</button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal" id="batchUploadModal">
        <div class="modal-content">
            <div class="modal-header">æ‰¹é‡ä¸Šä¼ ç»ƒä¹ </div>
             <div class="upload-tab-nav">
                <button class="btn btn-primary" id="manualTabBtn" onclick="switchUploadTab('manual')">æ‰‹åŠ¨è¾“å…¥</button>
                <button class="btn btn-secondary" id="templateTabBtn" onclick="switchUploadTab('template')">ä½¿ç”¨æ¨¡æ¿</button>
            </div>
            <div id="manualUploadTab" class="upload-tab active">
                <p style="color: #666; margin-bottom: 15px;">æ¯è¡Œä¸€ä¸ªç»ƒä¹ , æ ¼å¼: åç§° | å†…å®¹/é“¾æ¥ | éš¾åº¦ | æ—¶é—´</p>
                <textarea class="form-input" id="batchPracticeInput" rows="8" placeholder="ç§äººç”µé‚®ï¼šé‚€è¯·æœ‹å‹ | å†™ä¸€å°ç”µé‚®é‚€è¯·æœ‹å‹å‚åŠ ç”Ÿæ—¥èšä¼š | beginner | 30"></textarea>
            </div>
            <div id="templateUploadTab" class="upload-tab">
                <a href="javascript:void(0)" onclick="downloadCSVTemplate()" class="btn btn-secondary" style="margin-bottom: 15px;">ğŸ“¥ ä¸‹è½½CSVæ¨¡æ¿</a>
                <input type="file" class="form-input" id="csvFileUpload" accept=".csv">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeBatchUploadModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="processBatchUpload()">ä¸Šä¼ </button>
            </div>
        </div>
    </div>
    
    <script>
    console.log('æ£€æŸ¥ç‚¹1ï¼šä¸»è„šæœ¬å—å·²å¼€å§‹æ‰§è¡Œ');

    // 2. Firebase é…ç½®ä¿¡æ¯
    const firebaseConfig = {
        apiKey: "AIzaSyDdtQYfOC87IvpTZPFoDyb6ZgpEISzqw_I",
        authDomain: "emath-study-plan.firebaseapp.com",
        projectId: "emath-study-plan",
        storageBucket: "emath-study-plan.firebasestorage.app",
        messagingSenderId: "589299697460",
        appId: "1:589299697460:web:df1e0bb0586b3740c04761",
        measurementId: "G-09QVE4GLS0"
    };
    console.log('æ£€æŸ¥ç‚¹2ï¼šfirebaseConfigå¯¹è±¡å·²å®šä¹‰', firebaseConfig);


    // 3. Firebase åŒæ­¥é€»è¾‘
    try {
        console.log('æ£€æŸ¥ç‚¹3ï¼šå‡†å¤‡åˆå§‹åŒ–Firebaseã€‚å…¨å±€firebaseå¯¹è±¡:', firebase);
        firebase.initializeApp(firebaseConfig);
        console.log('æ£€æŸ¥ç‚¹4ï¼šFirebase App åˆå§‹åŒ–å®Œæ¯•');

        const auth = firebase.auth();
        const db = firebase.firestore();
        console.log('æ£€æŸ¥ç‚¹5ï¼šAuth å’Œ Firestore æœåŠ¡å·²è·å–');
        
        let user = null;
        let userDocRef = null;
        let unsubscribe; // ç”¨äºä¿å­˜å–æ¶ˆä¾¦å¬çš„å‡½æ•°
        
        auth.onAuthStateChanged(async (firebaseUser) => {
            console.log('æ£€æŸ¥ç‚¹6ï¼šAuthçŠ¶æ€å·²æ”¹å˜');
            if (unsubscribe) unsubscribe(); 

            if (firebaseUser) {
                user = firebaseUser;
                userDocRef = db.collection('userPractices').doc(user.uid);
                console.log("æ£€æŸ¥ç‚¹7ï¼šå·²ç™»å½•ï¼ŒUID:", user.uid);

                unsubscribe = userDocRef.onSnapshot(docSnap => {
                    console.log("æ£€æŸ¥ç‚¹8ï¼šæ”¶åˆ°æ¥è‡ªFirestoreçš„å®æ—¶æ›´æ–°");
                    if (docSnap.exists) {
                        practicesData = docSnap.data();
                        for (const key in sectionTypes) {
                            if (!practicesData[key]) {
                                practicesData[key] = [];
                            }
                        }
                    } else {
                        practicesData = defaultPracticesData;
                        saveData(); 
                    }
                    renderPractices();
                }, error => {
                    console.error("Firebaseä¾¦å¬å™¨é”™è¯¯:", error);
                });

            } else {
                console.log('æ£€æŸ¥ç‚¹6.1ï¼šç”¨æˆ·æœªç™»å½•ï¼Œå°è¯•åŒ¿åç™»å½•');
                auth.signInAnonymously().catch(error => {
                    console.error("åŒ¿åç™»å½•å¤±è´¥:", error);
                });
            }
        });

    } catch (e) {
        console.error("!!! è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°è‡´å‘½é”™è¯¯ !!!", e);
    }


    // é¡µé¢å…¶ä»–å˜é‡...
    const sectionTypes = { 'practical-writing': ['ç§äººç”µé‚®', 'å…¬åŠ¡ç”µé‚®', 'åšå®¢', 'ç½‘é¡µ', 'è®ºå›'], 'composition': ['è®°å™æ–‡', 'è®ºè¯´æ–‡', 'æ¼”è®²è¯', 'æ–°é—»/ææ–™è¯»åæ„Ÿ'], 'language-application': ['A. çŸ­æ–‡å¡«ç©º', 'B. ç—…å¥ä¿®æ”¹'], 'reading-1': ['é˜…è¯»ç†è§£ä¸€'], 'reading-2': ['é˜…è¯»ç†è§£äºŒ'], 'summary': ['ç‰‡æ®µç¼©å†™'] };
    const defaultPracticesData = { 'practical-writing': [], 'composition': [], 'language-application': [], 'reading-1': [], 'reading-2': [], 'summary': [] };
    let practicesData = {};
    let currentSection = 'practical-writing';
    let currentFilter = 'all';
    let practiceGrid, searchInput, practiceModal, batchUploadModal, practiceForm;
    let modalTitle, sectionTitle, sectionSelect, practiceTypeSelect;
    
    // ä»¥ä¸‹æ‰€æœ‰å‡½æ•°ä¿æŒä¸å˜...
    async function saveData() { if (!userDocRef) return; try { await userDocRef.set(practicesData, { merge: true }); console.log("Data saved to Firestore."); } catch (error) { console.error("Error saving data to Firestore:", error); alert("ä¿å­˜æ•°æ®åˆ°äº‘ç«¯å¤±è´¥ï¼"); } }
    function findPractice(id) { for (const section in practicesData) { const practice = practicesData[section].find(p => p.id == id); if (practice) return practice; } return null; }
    function getStatusText(status) { return { 'completed': 'å·²å®Œæˆ', 'pending': 'è¿›è¡Œä¸­', 'new': 'æ–°é¢˜ç›®' }[status] || 'æœªçŸ¥'; }
    function getDifficultyText(difficulty) { return { 'beginner': 'åˆçº§', 'intermediate': 'ä¸­çº§', 'advanced': 'é«˜çº§' }[difficulty] || 'ä¸­çº§'; }
    async function openPracticeModal(id = null) { practiceForm.reset(); practiceForm.dataset.editingId = ''; if (id) { const practice = findPractice(id); if (practice) { let practiceSection = currentSection; if (currentSection === 'all-sections') { for (const [sectionKey, practices] of Object.entries(practicesData)) { if (practices.some(p => p.id === practice.id)) { practiceSection = sectionKey; break; } } } const types = sectionTypes[practiceSection] || []; practiceTypeSelect.innerHTML = types.map(type => `<option value="${type}">${type}</option>`).join(''); modalTitle.textContent = 'ç¼–è¾‘ç»ƒä¹ '; document.getElementById('practiceName').value = practice.name; document.getElementById('practiceType').value = practice.type; document.getElementById('documentContent').value = practice.documentContent; document.getElementById('contentType').value = practice.contentType || 'auto'; document.getElementById('practiceStatus').value = practice.status; document.getElementById('difficultyLevel').value = practice.difficulty; document.getElementById('estimatedTime').value = practice.estimatedTime; practiceForm.dataset.editingId = id; practiceForm.dataset.practiceSection = practiceSection; } } else { if (currentSection === 'all-sections') { alert('è¯·å…ˆé€‰æ‹©å…·ä½“çš„ç»ƒä¹ åˆ†ç±»ï¼Œç„¶åå†æ·»åŠ ç»ƒä¹ ã€‚'); return; } updatePracticeTypeOptions(); modalTitle.textContent = 'æ·»åŠ æ–°ç»ƒä¹ '; document.getElementById('practiceStatus').value = 'new'; document.getElementById('difficultyLevel').value = 'intermediate'; document.getElementById('estimatedTime').value = 30; if (practiceTypeSelect.options.length > 0) { practiceTypeSelect.selectedIndex = 0; } } practiceModal.style.display = 'flex'; }
    async function deletePractice(id) { if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç»ƒä¹ å—ï¼Ÿæ­¤æ“ä½œå°†ä»äº‘ç«¯æ°¸ä¹…åˆ é™¤ã€‚')) { for (const sectionKey in practicesData) { const index = practicesData[sectionKey].findIndex(p => p.id == id); if (index > -1) { practicesData[sectionKey].splice(index, 1); break; } } await saveData(); } }
    function changeSection() { currentSection = sectionSelect.value; if (currentSection === 'all-sections') { sectionTitle.textContent = 'å…¨éƒ¨é¢˜å‹æ€»è§ˆ'; document.querySelector('.btn-primary').style.display = 'none'; } else { sectionTitle.textContent = sectionSelect.options[sectionSelect.selectedIndex].text; document.querySelector('.btn-primary').style.display = 'inline-flex'; if (practiceModal.style.display === 'flex') { updatePracticeTypeOptions(); if (practiceTypeSelect.options.length > 0) { practiceTypeSelect.selectedIndex = 0; } } } renderPractices(); }
    function openBatchUploadModal() { batchUploadModal.style.display = 'flex'; }
    function exportProgress() { const allPractices = Object.values(practicesData).flat(); if(allPractices.length === 0) return alert('æ²¡æœ‰è¿›åº¦å¯ä»¥å¯¼å‡ºã€‚'); let content = `Oæ°´å‡†é«˜çº§åæ–‡ç»ƒä¹ è¿›åº¦æŠ¥å‘Š\nç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}\n==========================\n\n`; Object.keys(sectionTypes).forEach(sectionKey => { const sectionName = sectionSelect.querySelector(`option[value="${sectionKey}"]`).textContent; content += `${sectionName}\n----------------\n`; const sectionPractices = practicesData[sectionKey] || []; if (sectionPractices.length > 0) { sectionPractices.forEach(p => { content += `- [${p.status === 'completed' ? 'x' : ' '}] ${p.name} (${p.type})\n`; content += `  éš¾åº¦ï¼š${getDifficultyText(p.difficulty)} | æ—¶é—´ï¼š${p.estimatedTime}åˆ†é’Ÿ\n`; if (p.status === 'completed' && p.completedDate) { content += `  å®Œæˆæ—¥æœŸï¼š${p.completedDate}\n`; } content += '\n'; }); } else { content += "æš‚æ— ç»ƒä¹ \n\n"; } }); const totalPractices = allPractices.length; const completedPractices = allPractices.filter(p => p.status === 'completed').length; const pendingPractices = allPractices.filter(p => p.status === 'pending').length; const newPractices = allPractices.filter(p => p.status === 'new').length; content += `\nç»Ÿè®¡ä¿¡æ¯\n----------------\n`; content += `æ€»ç»ƒä¹ æ•°ï¼š${totalPractices}\n`; content += `å·²å®Œæˆï¼š${completedPractices} (${((completedPractices/totalPractices)*100||0).toFixed(1)}%)\n`; content += `è¿›è¡Œä¸­ï¼š${pendingPractices}\n`; content += `æ–°é¢˜ç›®ï¼š${newPractices}\n`; const blob = new Blob([content], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.setAttribute("href", url); link.setAttribute("download", `åæ–‡ç»ƒä¹ è¿›åº¦æŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.txt`); document.body.appendChild(link); link.click(); document.body.removeChild(link); }
    function viewContent(id) { const practice = findPractice(id); if (!practice) return; const modal = document.createElement('div'); modal.className = 'modal'; modal.style.display = 'flex'; modal.innerHTML = ` <div class="modal-content"> <div class="modal-header">${practice.name}</div> <div style="margin-bottom: 20px;"> <strong>ç±»å‹ï¼š</strong>${practice.type}<br> <strong>éš¾åº¦ï¼š</strong>${getDifficultyText(practice.difficulty)}<br> <strong>é¢„è®¡æ—¶é—´ï¼š</strong>${practice.estimatedTime} åˆ†é’Ÿ </div> <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6;"> ${practice.documentContent} </div> <div class="form-actions"> <button class="btn btn-secondary" onclick="closeContentModal(this)">å…³é—­</button> <button class="btn btn-primary" onclick="markAsCompleted(${practice.id}); closeContentModal(this);">æ ‡è®°ä¸ºå·²å®Œæˆ</button> </div> </div> `; document.body.appendChild(modal); modal.addEventListener('click', (e) => { if (e.target === modal) closeContentModal(modal); }); }
    function closeContentModal(element) { const modal = element.closest ? element.closest('.modal') : element; if (modal) { document.body.removeChild(modal); } }
    async function markAsCompleted(id) { const practice = findPractice(id); if (practice) { practice.status = 'completed'; practice.completedDate = new Date().toISOString().split('T')[0]; await saveData(); } }
    function closePracticeModal() { practiceModal.style.display = 'none'; }
    function closeBatchUploadModal() { batchUploadModal.style.display = 'none'; }
    function switchUploadTab(tabName) { document.querySelectorAll('.upload-tab').forEach(tab => tab.classList.remove('active')); document.querySelectorAll('.upload-tab-nav .btn').forEach(btn => { btn.classList.remove('btn-primary'); btn.classList.add('btn-secondary'); }); document.getElementById(`${tabName}UploadTab`).classList.add('active'); document.getElementById(`${tabName}TabBtn`).classList.add('btn-primary'); }
    async function processBatchUpload() { const input = document.getElementById('batchPracticeInput').value.trim(); if (!input) return alert('è¯·è¾“å…¥ç»ƒä¹ ä¿¡æ¯'); const lines = input.split('\n').filter(line => line.trim()); const newPractices = lines.map((line, index) => { const parts = line.split('|').map(p => p.trim()); if (parts.length < 2) return null; return { id: Date.now() + index, name: parts[0], documentContent: parts[1], type: parts.length > 2 && parts[2] && sectionTypes[currentSection]?.includes(parts[2]) ? parts[2] : sectionTypes[currentSection]?.[0] || 'ç»ƒä¹ ', difficulty: parts[3] || 'intermediate', estimatedTime: parseInt(parts[4]) || 30, status: 'new', dateAdded: new Date().toISOString().split('T')[0] }; }).filter(p => p); if (!practicesData[currentSection]) practicesData[currentSection] = []; practicesData[currentSection].push(...newPractices); await saveData(); closeBatchUploadModal(); alert(`æˆåŠŸæ‰¹é‡æ·»åŠ  ${newPractices.length} ä¸ªç»ƒä¹ ï¼`); }
    function downloadCSVTemplate() { const headers = "ç»ƒä¹ åç§°,ç±»å‹,ç»ƒä¹ å†…å®¹/é“¾æ¥,éš¾åº¦,é¢„è®¡æ—¶é—´(åˆ†é’Ÿ)"; const example = "è®°å™æ–‡ï¼šæˆ‘çš„çˆ±å¥½,è®°å™æ–‡,ä»¥æˆ‘çš„çˆ±å¥½ä¸ºé¢˜å†™ä¸€ç¯‡è®°å™æ–‡,intermediate,90"; const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers + "\n" + example; const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "åæ–‡ç»ƒä¹ å¯¼å…¥æ¨¡æ¿.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link); }
    function updatePracticeTypeOptions() { const types = sectionTypes[currentSection] || []; practiceTypeSelect.innerHTML = types.map(type => `<option value="${type}">${type}</option>`).join(''); }
    function getFilteredData() { const searchTerm = searchInput.value.toLowerCase(); let practices = []; if (currentSection === 'all-sections') { practices = Object.values(practicesData).flat(); } else { practices = practicesData[currentSection] || []; } if (currentFilter !== 'all') { practices = practices.filter(p => p.status === currentFilter); } if (searchTerm) { practices = practices.filter(p => p.name.toLowerCase().includes(searchTerm)); } return practices.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded)); }
    function createPracticeCard(practice) { const card = document.createElement('div'); card.className = 'practice-card'; card.dataset.id = practice.id; let practiceSection = currentSection; if (currentSection === 'all-sections') { for (const [sectionKey, practices] of Object.entries(practicesData)) { if (practices.some(p => p.id === practice.id)) { practiceSection = sectionKey; break; } } } const headerClass = `card-header-${practiceSection}`; let isLink = false; if (practice.contentType === 'link') { isLink = true; } else if (practice.contentType === 'text') { isLink = false; } else { isLink = practice.documentContent && ( practice.documentContent.trim().startsWith('http://') ||  practice.documentContent.trim().startsWith('https://') || practice.documentContent.includes('docs.google.com') || practice.documentContent.includes('onedrive.live.com') || practice.documentContent.includes('drive.google.com') || (practice.documentContent.includes('http') && practice.documentContent.trim().split('\n').length <= 3) ); } const actionButton = isLink  ? `<a href="${practice.documentContent}" target="_blank" class="btn btn-primary" style="width: 100%;">æ‰“å¼€æ–‡æ¡£</a>` : `<button class="btn btn-primary" onclick="viewContent(${practice.id})" style="width: 100%;">æŸ¥çœ‹å†…å®¹</button>`; const sectionBadge = currentSection === 'all-sections'  ? `<span style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 10px;">${getSectionName(practiceSection)}</span>` : ''; card.innerHTML = ` <div class="card-header ${headerClass}"> <h3 class="card-title">${practice.name}${sectionBadge}</h3> <p class="card-meta">${practice.type}</p> <button class="card-actions-menu">â‹®</button> <div class="card-menu"> <button class="card-menu-item edit" onclick="openPracticeModal(${practice.id})">âœï¸ ç¼–è¾‘</button> <button class="card-menu-item delete" onclick="deletePractice(${practice.id})">ğŸ—‘ï¸ åˆ é™¤</button> </div> </div> <div class="card-content"> <div class="info-grid"> <div class="info-item"> <div class="info-label">çŠ¶æ€</div> <div class="info-value"><span class="status-badge status-${practice.status}">${getStatusText(practice.status)}</span></div> </div> <div class="info-item"> <div class="info-label">éš¾åº¦</div> <div class="info-value difficulty-badge difficulty-${practice.difficulty}">${getDifficultyText(practice.difficulty)}</div> </div> <div class="info-item"> <div class="info-label">æ·»åŠ æ—¥æœŸ</div> <div class="info-value">${practice.dateAdded}</div> </div> <div class="info-item"> <div class="info-label">é¢„è®¡æ—¶é—´</div> <div class="info-value">${practice.estimatedTime} åˆ†é’Ÿ</div> </div> </div> ${actionButton} </div> `; return card; }
    function getSectionName(sectionKey) { const sectionNames = { 'practical-writing': 'å®ç”¨æ–‡', 'composition': 'ä½œæ–‡', 'language-application': 'è¯­æ–‡åº”ç”¨', 'reading-1': 'é˜…è¯»ç†è§£ä¸€', 'reading-2': 'é˜…è¯»ç†è§£äºŒ', 'summary': 'ç‰‡æ®µç¼©å†™' }; return sectionNames[sectionKey] || sectionKey; }
    function renderPractices() { const filteredData = getFilteredData(); practiceGrid.innerHTML = ''; if (Object.keys(practicesData).length === 0 && !user) return; if (filteredData.length === 0) { practiceGrid.innerHTML = '<p style="color: #7b8b9a; text-align: center; grid-column: 1 / -1; font-size: 1.1rem; padding: 50px 0;">è¯¥åˆ†ç±»ä¸‹æ²¡æœ‰ç»ƒä¹ ã€‚</p>'; return; } filteredData.forEach(practice => { practiceGrid.appendChild(createPracticeCard(practice)); }); }
    async function handleFormSubmit(e) { e.preventDefault(); const id = practiceForm.dataset.editingId; const formData = { name: document.getElementById('practiceName').value, type: document.getElementById('practiceType').value, documentContent: document.getElementById('documentContent').value, contentType: document.getElementById('contentType').value, status: document.getElementById('practiceStatus').value, difficulty: document.getElementById('difficultyLevel').value, estimatedTime: parseInt(document.getElementById('estimatedTime').value) || 30, }; if (id) { const originalSection = practiceForm.dataset.practiceSection || currentSection; const index = practicesData[originalSection].findIndex(p => p.id == id); if (index !== -1) { const existingPractice = practicesData[originalSection][index]; practicesData[originalSection][index] = { ...existingPractice, ...formData }; } } else { if (currentSection === 'all-sections') return; const newPractice = { ...formData, id: Date.now(), dateAdded: new Date().toISOString().split('T')[0] }; if (!practicesData[currentSection]) practicesData[currentSection] = []; practicesData[currentSection].push(newPractice); } await saveData(); closePracticeModal(); }
    
    function setupEventListeners() {
        searchInput.addEventListener('input', renderPractices);
        document.querySelectorAll('.filter-tab').forEach(tab => { tab.addEventListener('click', e => { document.querySelector('.filter-tab.active').classList.remove('active'); e.target.classList.add('active'); currentFilter = e.target.dataset.filter; renderPractices(); }); });
        practiceForm.addEventListener('submit', handleFormSubmit);
        document.getElementById('saveButton').addEventListener('click', function(e) { e.preventDefault(); handleFormSubmit(e); });
        practiceModal.addEventListener('click', (e) => { if (e.target === practiceModal) closePracticeModal(); });
        batchUploadModal.addEventListener('click', (e) => { if (e.target === batchUploadModal) closeBatchUploadModal(); });
        practiceGrid.addEventListener('click', e => { const menuButton = e.target.closest('.card-actions-menu'); if (menuButton) { const currentMenu = menuButton.nextElementSibling; const isVisible = currentMenu.classList.contains('show'); document.querySelectorAll('.card-menu.show').forEach(menu => { menu.classList.remove('show'); }); if (!isVisible) { currentMenu.classList.add('show'); } } });
        window.addEventListener('click', e => { if (!e.target.closest('.practice-card')) { document.querySelectorAll('.card-menu.show').forEach(menu => menu.classList.remove('show')); } });
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log('æ£€æŸ¥ç‚¹Aï¼šDOMå†…å®¹å·²åŠ è½½ï¼Œå‡†å¤‡åˆå§‹åŒ–å˜é‡');
        practiceGrid = document.getElementById('practiceGrid');
        searchInput = document.getElementById('searchInput');
        practiceModal = document.getElementById('practiceModal');
        batchUploadModal = document.getElementById('batchUploadModal');
        practiceForm = document.getElementById('practiceForm');
        modalTitle = document.getElementById('modalTitle');
        sectionTitle = document.getElementById('sectionTitle');
        sectionSelect = document.getElementById('sectionSelect');
        practiceTypeSelect = document.getElementById('practiceType');
        
        console.log('æ£€æŸ¥ç‚¹Bï¼šå˜é‡åˆå§‹åŒ–å®Œæ¯•ï¼Œå‡†å¤‡è®¾ç½®äº‹ä»¶ç›‘å¬å™¨');
        setupEventListeners();
        console.log('æ£€æŸ¥ç‚¹Cï¼šäº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæ¯•ã€‚Firebaseé€»è¾‘åº”åœ¨æ­¤ä¹‹å‰å·²å¼€å§‹æ‰§è¡Œã€‚');
    });

</script>
</body>
</html>
