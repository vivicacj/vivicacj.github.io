<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O水准高级华文练习平台 (最终版)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary-color: #667eea;
            --text-on-dark: rgba(255, 255, 255, 0.95);
            --card-background: rgba(255, 255, 255, 0.98);
            --text-color: #34495e;
            --text-light: #7f8c8d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-color);
        }
        .hidden { display: none !important; }
        #auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .auth-box { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .auth-box h2 { margin-bottom: 20px; color: var(--text-color); }
        .auth-box .form-input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px; font-size: 1rem; }
        .auth-box .btn { width: 100%; padding: 12px; border-radius: 8px; font-size: 1rem; font-weight: 500; margin-top: 10px; }
        .auth-toggle-link { margin-top: 20px; color: var(--primary-color); cursor: pointer; font-size: 0.9rem; }
        .auth-error { color: #e74c3c; margin-top: 15px; font-size: 0.9rem; min-height: 1.2em; }
        #main-app-container { padding-top: 90px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 30px; }
        .header { background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.2); position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; padding: 0 30px; }
        .logo { font-size: 1.8rem; font-weight: 700; color: white; text-shadow: 1px 1px 5px rgba(0,0,0,0.2); }
        .header-user-info { color: white; font-size: 0.9rem; display: flex; align-items: center; gap: 15px; }
        .main-content { padding: 40px 0; }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        .section-title { font-size: 2.2rem; font-weight: 700; color: var(--text-on-dark); text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 500; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: white; color: var(--primary-color); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-primary:hover { background-color: #f8f9fa; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .btn-secondary { background: rgba(255,255,255,0.2); color: var(--text-on-dark); border: 1px solid rgba(255,255,255,0.3); }
        .btn-secondary:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); margin-bottom: 40px; flex-wrap: wrap; gap: 20px; }
        .search-box { display: flex; align-items: center; background: #f1f3f5; border-radius: 8px; padding: 8px 12px; min-width: 250px; flex-grow: 1; }
        .search-box input { border: none; outline: none; flex: 1; font-size: 14px; background: transparent; }
        .filter-checkboxes { display: flex; gap: 15px; align-items: center; color: var(--text-color); font-size: 0.9rem;}
        .filter-checkboxes label { cursor: pointer; display: flex; align-items: center; gap: 5px; user-select: none;}
        .filter-checkboxes input { cursor: pointer; }
        .practice-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; }
        .practice-card { background: var(--card-background); border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; overflow: visible; position: relative; }
        .practice-card:hover { transform: translateY(-8px); box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15); }
        .card-header { padding: 20px; color: white; position: relative; border-radius: 16px 16px 0 0; }
        .card-header-practical-writing { background: linear-gradient(135deg, #2b8a3e, #51cf66); }
        .card-header-composition { background: linear-gradient(135deg, #e8590c, #fd7e14); }
        .card-header-language-application { background: linear-gradient(135deg, #c92a2a, #fa5252); }
        .card-header-reading-1 { background: linear-gradient(135deg, #1971c2, #339af0); }
        .card-header-reading-2 { background: linear-gradient(135deg, #0b7285, #15aabf); }
        .card-header-summary { background: linear-gradient(135deg, #a61e4d, #f06595); }
        .card-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 5px; }
        .card-meta { font-size: 0.85rem; opacity: 0.9; }
        .card-content { padding: 25px; }
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .info-item { background: #f8f9fa; border-radius: 8px; padding: 10px; text-align: center; }
        .info-label { font-size: 0.8rem; color: var(--text-light); }
        .info-value { font-weight: 500; }
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; color: white; }
        .status-completed { background-color: #28a745; }
        .status-pending { background-color: #fd7e14; }
        .status-new { background-color: #1c7ed6; }
        .difficulty-badge { font-weight: 500; }
        .difficulty-beginner { color: #28a745; }
        .difficulty-intermediate { color: #fd7e14; }
        .difficulty-advanced { color: #c92a2a; }
        .card-actions-menu { position: absolute; top: 15px; right: 15px; width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(255, 255, 255, 0.2); color: white; font-size: 1.5rem; line-height: 1; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
        .card-actions-menu:hover { background: rgba(255, 255, 255, 0.4); }
        .card-menu { display: none; position: absolute; top: 55px; right: 15px; background: white; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); z-index: 10; overflow: hidden; animation: fadeInMenu 0.2s ease-out; }
        .card-menu.show { display: block; }
        @keyframes fadeInMenu { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .card-menu-item { display: flex; align-items: center; gap: 10px; padding: 12px 20px; border: none; background: none; width: 100%; text-align: left; cursor: pointer; font-size: 0.9rem; color: var(--text-color); }
        .card-menu-item:hover { background-color: #f1f3f5; }
        .card-menu-item.delete { color: #e74c3c; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal-header { font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-input, .form-select { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; font-size: 1rem; transition: all 0.2s ease; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px; }
        #batchUploadModal .modal-content { max-width: 700px; }
        .upload-tab-nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .upload-tab { display: none; }
        .upload-tab.active { display: block; }
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="auth-box">
            <div id="login-view">
                <h2>登录</h2>
                <form id="login-form">
                    <input type="email" id="login-email" class="form-input" placeholder="邮箱" required>
                    <input type="password" id="login-password" class="form-input" placeholder="密码" required>
                    <p id="login-error" class="auth-error"></p>
                    <button type="submit" class="btn btn-primary">登录</button>
                </form>
                <p class="auth-toggle-link" onclick="toggleAuthView()">还没有账号？点击注册</p>
            </div>
            <div id="register-view" class="hidden">
                <h2>注册新账号</h2>
                <form id="register-form">
                    <input type="email" id="register-email" class="form-input" placeholder="邮箱" required>
                    <input type="password" id="register-password" class="form-input" placeholder="密码 (至少6位)" required>
                    <p id="register-error" class="auth-error"></p>
                    <button type="submit" class="btn btn-primary">注册</button>
                </form>
                <p class="auth-toggle-link" onclick="toggleAuthView()">已有账号？点击登录</p>
            </div>
        </div>
    </div>
    
    <div id="main-app-container" class="hidden">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">✍️ 高级华文・练习中枢</div>
                    <div class="header-user-info">
                        <span id="user-email-display"></span>
                        <button class="btn btn-danger" onclick="handleLogout()">登出</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="container">
                <div class="content-header">
                    <h1 class="section-title" id="sectionTitle">专项考题一：实用文</h1>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openPracticeModal()">➕ 添加练习</button>
                        <button class="btn btn-secondary" onclick="openBatchUploadModal()">📁 批量上传</button>
                        <button class="btn btn-secondary" onclick="exportProgress()">📊 导出进度</button>
                    </div>
                </div>

                <div class="toolbar">
                    <div class="search-box">
                        <span>🔍</span>
                        <input type="text" placeholder="按名称搜索..." id="searchInput">
                    </div>
                    <div class="filter-checkboxes" id="statusFilters">
                        <label><input type="checkbox" name="status" value="new" checked> 新题目</label>
                        <label><input type="checkbox" name="status" value="pending" checked> 进行中</label>
                        <label><input type="checkbox" name="status" value="completed" checked> 已完成</label>
                    </div>
                    <select class="form-input" id="sectionSelect" onchange="changeSection()" style="max-width: 250px; min-width: 200px;">
                        <option value="practical-writing">专项考题一：实用文</option>
                        <option value="composition">专项考题二：作文</option>
                        <option value="language-application">专项考题三：语文应用</option>
                        <option value="reading-1">专项考题四：阅读理解一</option>
                        <option value="reading-2">专项考题五：阅读理解二</option>
                        <option value="summary">专项考题六：片段缩写</option>
                        <option value="all-sections">🔍 查看全部题型</option>
                    </select>
                </div>

                <div class="practice-grid" id="practiceGrid"></div>
            </div>
        </main>
    </div>
    
    <div class="modal" id="practiceModal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">添加新练习</div>
            <form id="practiceForm">
                <div class="form-group"><label class="form-label" for="practiceName">练习名称 *</label><input type="text" class="form-input" id="practiceName" required></div>
                <div class="form-group"><label class="form-label" for="practiceType">练习类型</label><select class="form-select" id="practiceType"></select></div>
                <div class="form-group"><label class="form-label" for="documentContent">练习内容/链接 *</label><textarea class="form-input" id="documentContent" rows="4" placeholder="输入练习内容或粘贴文档链接..." required></textarea></div>
                <div class="form-group"><label class="form-label" for="contentType">内容类型</label><select class="form-select" id="contentType"><option value="auto">自动检测</option><option value="text">文本内容</option><option value="link">外部链接</option></select></div>
                <div class="form-group"><label class="form-label" for="practiceStatus">状态</label><select class="form-select" id="practiceStatus"><option value="new">新题目</option><option value="pending">进行中</option><option value="completed">已完成</option></select></div>
                <div class="form-group"><label class="form-label" for="difficultyLevel">难度等级</label><select class="form-select" id="difficultyLevel"><option value="beginner">初级</option><option value="intermediate">中级</option><option value="advanced">高级</option></select></div>
                <div class="form-group"><label class="form-label" for="estimatedTime">预计时间 (分钟)</label><input type="number" class="form-input" id="estimatedTime" min="5"></div>
                <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="closePracticeModal()">取消</button><button type="submit" class="btn btn-primary" id="saveButton">保存到云端</button></div>
            </form>
        </div>
    </div>
    <div class="modal" id="batchUploadModal">
        <div class="modal-content">
            <div class="modal-header">批量上传练习</div>
            <div class="upload-tab-nav"><button class="btn btn-primary" id="manualTabBtn" onclick="switchUploadTab('manual')">手动输入</button><button class="btn btn-secondary" id="templateTabBtn" onclick="switchUploadTab('template')">使用模板</button></div>
            <div id="manualUploadTab" class="upload-tab active"><p style="color: #666; margin-bottom: 15px;">每行一个练习, 格式: 名称 | 内容/链接 | 难度 | 时间</p><textarea class="form-input" id="batchPracticeInput" rows="8" placeholder="私人电邮：邀请朋友 | 写一封电邮邀请朋友参加生日聚会 | beginner | 30"></textarea></div>
            <div id="templateUploadTab" class="upload-tab"><a href="javascript:void(0)" onclick="downloadCSVTemplate()" class="btn btn-secondary" style="margin-bottom: 15px;">📥 下载CSV模板</a><input type="file" class="form-input" id="csvFileUpload" accept=".csv"></div>
            <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="closeBatchUploadModal()">取消</button><button type="button" class="btn btn-primary" onclick="processBatchUpload()">上传</button></div>
        </div>
    </div>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDdtQYfOC87IvpTZPFoDyb6ZgpEISzqw_I",
            authDomain: "emath-study-plan.firebaseapp.com",
            projectId: "emath-study-plan",
            storageBucket: "emath-study-plan.firebasestorage.app",
            messagingSenderId: "589299697460",
            appId: "1:589299697460:web:df1e0bb0586b3740c04761",
            measurementId: "G-09QVE4GLS0"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let user = null;
        let userDocRef = null;
        let unsubscribe; 

        const authContainer = document.getElementById('auth-container');
        const mainAppContainer = document.getElementById('main-app-container');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const userEmailDisplay = document.getElementById('user-email-display');
        
        const sectionTypes = { 'practical-writing': ['私人电邮', '公务电邮', '博客', '网页', '论坛'], 'composition': ['记叙文', '论说文', '演讲词', '新闻/材料读后感'], 'language-application': ['A. 短文填空', 'B. 病句修改'], 'reading-1': ['阅读理解一'], 'reading-2': ['阅读理解二'], 'summary': ['片段缩写'] };
        const defaultPracticesData = { 'practical-writing': [], 'composition': [], 'language-application': [], 'reading-1': [], 'reading-2': [], 'summary': [] };
        let practicesData = {};
        let currentSection = 'practical-writing';
        let practiceGrid, searchInput, practiceModal, batchUploadModal, practiceForm, statusFilters;
        let modalTitle, sectionTitle, sectionSelect, practiceTypeSelect;

        auth.onAuthStateChanged(firebaseUser => {
            if (unsubscribe) unsubscribe();
            if (firebaseUser) {
                user = firebaseUser;
                userDocRef = db.collection('userPractices').doc(user.uid);
                authContainer.classList.add('hidden');
                mainAppContainer.classList.remove('hidden');
                userEmailDisplay.textContent = user.email;
                unsubscribe = userDocRef.onSnapshot(docSnap => {
                    if (docSnap.exists) {
                        practicesData = docSnap.data();
                        for (const key in sectionTypes) { if (!practicesData[key]) { practicesData[key] = []; } }
                    } else {
                        practicesData = defaultPracticesData;
                        saveData();
                    }
                    renderPractices();
                }, error => {
                    console.error("Error with real-time listener:", error);
                });
            } else {
                user = null;
                userDocRef = null;
                authContainer.classList.remove('hidden');
                mainAppContainer.classList.add('hidden');
                practicesData = {};
                if(practiceGrid) practiceGrid.innerHTML = '';
            }
        });
        
        function toggleAuthView() { loginView.classList.toggle('hidden'); registerView.classList.toggle('hidden'); document.getElementById('login-error').textContent = ''; document.getElementById('register-error').textContent = ''; }
        function handleRegister(e) { e.preventDefault(); const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; const errorElement = document.getElementById('register-error'); auth.createUserWithEmailAndPassword(email, password).catch(error => { errorElement.textContent = error.message; }); }
        function handleLogin(e) { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; const errorElement = document.getElementById('login-error'); auth.signInWithEmailAndPassword(email, password).catch(error => { errorElement.textContent = error.message; }); }
        function handleLogout() { if (confirm('您确定要登出吗？')) { auth.signOut(); } }
        async function saveData() { if (!userDocRef) return; try { await userDocRef.set(practicesData, { merge: true }); console.log("Data saved to Firestore."); } catch (error) { console.error("Error saving data to Firestore:", error); alert("保存数据到云端失败！"); } }
        function findPractice(id) { for (const section in practicesData) { const practice = practicesData[section].find(p => p.id == id); if (practice) return practice; } return null; }
        function getStatusText(status) { return { 'completed': '已完成', 'pending': '进行中', 'new': '新题目' }[status] || '未知'; }
        function getDifficultyText(difficulty) { return { 'beginner': '初级', 'intermediate': '中级', 'advanced': '高级' }[difficulty] || '中级'; }
        
        function getFilteredData() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedStatuses = Array.from(statusFilters.querySelectorAll('input:checked')).map(cb => cb.value);
            let practices = [];
            if (currentSection === 'all-sections') {
                practices = Object.values(practicesData).flat();
            } else {
                practices = practicesData[currentSection] || [];
            }
            if (selectedStatuses.length > 0) {
                 practices = practices.filter(p => selectedStatuses.includes(p.status));
            } else {
                practices = [];
            }
            if (searchTerm) {
                practices = practices.filter(p => p.name.toLowerCase().includes(searchTerm));
            }
            return practices.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            practiceGrid = document.getElementById('practiceGrid');
            searchInput = document.getElementById('searchInput');
            practiceModal = document.getElementById('practiceModal');
            batchUploadModal = document.getElementById('batchUploadModal');
            practiceForm = document.getElementById('practiceForm');
            modalTitle = document.getElementById('modalTitle');
            sectionTitle = document.getElementById('sectionTitle');
            sectionSelect = document.getElementById('sectionSelect');
            practiceTypeSelect = document.getElementById('practiceType');
            statusFilters = document.getElementById('statusFilters');
            
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            practiceForm.addEventListener('submit', handleFormSubmit);
            statusFilters.addEventListener('change', renderPractices);
            searchInput.addEventListener('input', renderPractices);
            
            setupEventListeners();
        });

        function setupEventListeners() {
            practiceModal.addEventListener('click', (e) => { if (e.target === practiceModal) closePracticeModal(); });
            batchUploadModal.addEventListener('click', (e) => { if (e.target === batchUploadModal) closeBatchUploadModal(); });
            practiceGrid.addEventListener('click', e => { const menuButton = e.target.closest('.card-actions-menu'); if (menuButton) { const currentMenu = menuButton.nextElementSibling; const isVisible = currentMenu.classList.contains('show'); document.querySelectorAll('.card-menu.show').forEach(menu => { menu.classList.remove('show'); }); if (!isVisible) { currentMenu.classList.add('show'); } } });
            window.addEventListener('click', e => { if (!e.target.closest('.practice-card')) { document.querySelectorAll('.card-menu.show').forEach(menu => menu.classList.remove('show')); } });
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const id = practiceForm.dataset.editingId;
            const formData = {
                name: document.getElementById('practiceName').value,
                type: document.getElementById('practiceType').value,
                documentContent: document.getElementById('documentContent').value,
                contentType: document.getElementById('contentType').value,
                status: document.getElementById('practiceStatus').value,
                difficulty: document.getElementById('difficultyLevel').value,
                estimatedTime: parseInt(document.getElementById('estimatedTime').value) || 30,
            };
            if (id) {
                const originalSection = practiceForm.dataset.practiceSection || currentSection;
                const index = practicesData[originalSection].findIndex(p => p.id == id);
                if (index !== -1) {
                    const existingPractice = practicesData[originalSection][index];
                    practicesData[originalSection][index] = { ...existingPractice, ...formData };
                }
            } else {
                if (currentSection === 'all-sections') { alert('请先选择具体的练习分类，然后再添加练习。'); return; }
                const newPractice = { ...formData, id: Date.now(), dateAdded: new Date().toISOString().split('T')[0] };
                if (!practicesData[currentSection]) practicesData[currentSection] = [];
                practicesData[currentSection].push(newPractice);
            }
            await saveData();
            closePracticeModal();
        }

        function renderPractices() {
            const filteredData = getFilteredData();
            practiceGrid.innerHTML = '';
            if (Object.keys(practicesData).length === 0 && !user) return;
            if (filteredData.length === 0) {
                practiceGrid.innerHTML = '<p style="color: #495057; text-align: center; grid-column: 1 / -1; font-size: 1.1rem; padding: 50px 0;">该分类下没有练习。</p>';
                return;
            }
            filteredData.forEach(practice => {
                practiceGrid.appendChild(createPracticeCard(practice));
            });
        }

        function createPracticeCard(practice) {
            const card = document.createElement('div');
            card.className = 'practice-card';
            card.dataset.id = practice.id;
            let practiceSection = currentSection;
            if (currentSection === 'all-sections') {
                for (const [sectionKey, practices] of Object.entries(practicesData)) {
                    if (practices.some(p => p.id === practice.id)) {
                        practiceSection = sectionKey;
                        break;
                    }
                }
            }
            const headerClass = `card-header-${practiceSection}`;
            let isLink = false;
            if (practice.contentType === 'link') { isLink = true; } 
            else if (practice.contentType === 'text') { isLink = false; } 
            else { isLink = practice.documentContent && ( practice.documentContent.trim().startsWith('http://') || practice.documentContent.trim().startsWith('https://') || practice.documentContent.includes('docs.google.com') || practice.documentContent.includes('onedrive.live.com') || practice.documentContent.includes('drive.google.com') || (practice.documentContent.includes('http') && practice.documentContent.trim().split('\n').length <= 3) ); }
            const actionButton = isLink ? `<a href="${practice.documentContent}" target="_blank" class="btn btn-primary" style="width: 100%;">打开文档</a>` : `<button class="btn btn-primary" onclick="viewContent(${practice.id})" style="width: 100%;">查看内容</button>`;
            const sectionBadge = currentSection === 'all-sections' ? `<span style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 10px;">${getSectionName(practiceSection)}</span>` : '';
            card.innerHTML = `
                <div class="card-header ${headerClass}">
                    <h3 class="card-title">${practice.name}${sectionBadge}</h3>
                    <p class="card-meta">${practice.type}</p>
                    <button class="card-actions-menu">⋮</button>
                    <div class="card-menu">
                        <button class="card-menu-item edit" onclick="openPracticeModal(${practice.id})">✏️ 编辑</button>
                        <button class="card-menu-item delete" onclick="deletePractice(${practice.id})">🗑️ 删除</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="info-grid">
                        <div class="info-item"><div class="info-label">状态</div><div class="info-value"><span class="status-badge status-${practice.status}">${getStatusText(practice.status)}</span></div></div>
                        <div class="info-item"><div class="info-label">难度</div><div class="info-value difficulty-badge difficulty-${practice.difficulty}">${getDifficultyText(practice.difficulty)}</div></div>
                        <div class="info-item"><div class="info-label">添加日期</div><div class="info-value">${practice.dateAdded}</div></div>
                        <div class="info-item"><div class="info-label">预计时间</div><div class="info-value">${practice.estimatedTime} 分钟</div></div>
                    </div>
                    ${actionButton}
                </div>`;
            return card;
        }
        
        function getSectionName(sectionKey) { const sectionNames = { 'practical-writing': '实用文', 'composition': '作文', 'language-application': '语文应用', 'reading-1': '阅读理解一', 'reading-2': '阅读理解二', 'summary': '片段缩写' }; return sectionNames[sectionKey] || sectionKey; }
        function updatePracticeTypeOptions() { const types = sectionTypes[currentSection] || []; practiceTypeSelect.innerHTML = types.map(type => `<option value="${type}">${type}</option>`).join(''); }
        async function markAsCompleted(id) { const practice = findPractice(id); if (practice) { practice.status = 'completed'; practice.completedDate = new Date().toISOString().split('T')[0]; await saveData(); } }
        function closePracticeModal() { practiceModal.style.display = 'none'; }
        function closeBatchUploadModal() { batchUploadModal.style.display = 'none'; }
        function switchUploadTab(tabName) { document.querySelectorAll('.upload-tab').forEach(tab => tab.classList.remove('active')); document.querySelectorAll('.upload-tab-nav .btn').forEach(btn => { btn.classList.remove('btn-primary'); btn.classList.add('btn-secondary'); }); document.getElementById(`${tabName}UploadTab`).classList.add('active'); document.getElementById(`${tabName}TabBtn`).classList.add('btn-primary'); }
        async function processBatchUpload() { const input = document.getElementById('batchPracticeInput').value.trim(); if (!input) return alert('请输入练习信息'); const lines = input.split('\n').filter(line => line.trim()); const newPractices = lines.map((line, index) => { const parts = line.split('|').map(p => p.trim()); if (parts.length < 2) return null; return { id: Date.now() + index, name: parts[0], documentContent: parts[1], type: parts.length > 2 && parts[2] && sectionTypes[currentSection]?.includes(parts[2]) ? parts[2] : sectionTypes[currentSection]?.[0] || '练习', difficulty: parts[3] || 'intermediate', estimatedTime: parseInt(parts[4]) || 30, status: 'new', dateAdded: new Date().toISOString().split('T')[0] }; }).filter(p => p); if (!practicesData[currentSection]) practicesData[currentSection] = []; practicesData[currentSection].push(...newPractices); await saveData(); closeBatchUploadModal(); alert(`成功批量添加 ${newPractices.length} 个练习！`); }
        function downloadCSVTemplate() { const headers = "练习名称,类型,练习内容/链接,难度,预计时间(分钟)"; const example = "记叙文：我的爱好,记叙文,以我的爱好为题写一篇记叙文,intermediate,90"; const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers + "\n" + example; const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "华文练习导入模板.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link); }
        function viewContent(id) { const practice = findPractice(id); if (!practice) return; const modal = document.createElement('div'); modal.className = 'modal'; modal.style.display = 'flex'; modal.innerHTML = ` <div class="modal-content"> <div class="modal-header">${practice.name}</div> <div style="margin-bottom: 20px;"> <strong>类型：</strong>${practice.type}<br> <strong>难度：</strong>${getDifficultyText(practice.difficulty)}<br> <strong>预计时间：</strong>${practice.estimatedTime} 分钟 </div> <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6;"> ${practice.documentContent} </div> <div class="form-actions"> <button class="btn btn-secondary" onclick="closeContentModal(this)">关闭</button> <button class="btn btn-primary" onclick="markAsCompleted(${practice.id}); closeContentModal(this);">标记为已完成</button> </div> </div> `; document.body.appendChild(modal); modal.addEventListener('click', (e) => { if (e.target === modal) closeContentModal(modal); }); }
        function closeContentModal(element) { const modal = element.closest ? element.closest('.modal') : element; if (modal) { document.body.removeChild(modal); } }
    </script>
</body>
</html>
