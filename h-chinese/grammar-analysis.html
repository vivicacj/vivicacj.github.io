<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O-Levelåæ–‡ç—…å¥ä¿®æ”¹æ·±åº¦åˆ†ææŠ¥å‘Š (Proç‰ˆ V3.4 - æœ€ç»ˆç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.0/echarts.min.js"></script>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --text-color: #2c3e50;
            --light-gray: #f8f9fa;
            --border-color: #dee2e6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', -apple-system, sans-serif;
            line-height: 1.7;
            color: var(--text-color);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .section {
            background: rgba(255, 255, 255, 0.98);
            margin-bottom: 40px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }
        .section-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white; padding: 25px 30px; font-size: 1.4em; font-weight: bold;
        }
        .section-content { padding: 30px; }
        .header {
            text-align: center; margin-bottom: 40px; background: rgba(255, 255, 255, 0.98);
            padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .header h1 {
            font-size: 2.8em; margin-bottom: 10px; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .metric-card { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); cursor: pointer; }
        .metric-value { font-size: 2.5em; font-weight: bold; }
        .metric-label { color: #7f8c8d; font-size: 0.9em; }
        .chart-container { width: 100%; height: 500px; }
        
        /* Etiology Tree styles */
        .etiology-tree { padding-left: 20px; text-align: center; }
        .etiology-tree ul { padding-top: 20px; position: relative; }
        .etiology-tree li { float: left; text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; }
        .etiology-tree li::before, .etiology-tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 2px solid #ccc; width: 50%; height: 20px; }
        .etiology-tree li::after { right: auto; left: 50%; border-left: 2px solid #ccc; }
        .etiology-tree li:only-child::after, .etiology-tree li:only-child::before { display: none; }
        .etiology-tree li:first-child::before, .etiology-tree li:last-child::after { border: 0 none; }
        .etiology-tree ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 2px solid #ccc; width: 0; height: 20px; }
        .etiology-tree li div { border: 2px solid var(--border-color); padding: 10px; color: var(--text-color); background-color: white; display: inline-block; border-radius: 8px; min-width: 120px; }
        .etiology-tree .root { background: var(--secondary-color); color: white; border-color: var(--secondary-color); }
        .etiology-tree .level-1 { background: #e8eaf6; border-color: var(--primary-color); }
        .etiology-tree .level-2 { background: #f1f8e9; border-color: #7cb342; }

        /* Bubble Chart Controls */
        .bubble-chart-controls { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; padding: 15px; background-color: var(--light-gray); border-radius: 10px; }
        .bubble-chart-controls label { font-size: 1.1em; font-weight: bold; margin-bottom: 10px; }
        #year-slider { width: 80%; cursor: pointer; }
        #current-year-label { font-size: 1.5em; font-weight: bold; color: var(--primary-color); margin-top: 5px; }

        /* Data Table Controls */
        .table-controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 20px; }
        .table-controls select, .toggle-button { padding: 8px 15px; border-radius: 25px; border: 2px solid var(--border-color); font-size: 1em; background-color: white; cursor: pointer; }
        .toggle-button { background: var(--secondary-color); color: white; border-color: transparent; transition: all 0.3s ease; }
        .toggle-button:hover { background: var(--primary-color); transform: scale(1.05); }
        .data-table-container { max-height: 0; overflow: hidden; transition: max-height 0.8s ease-in-out; }
        .data-table-container.show { max-height: 1200px; overflow-y: auto; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .data-table th, .data-table td { padding: 12px 15px; border: 1px solid var(--border-color); text-align: left; }
        .data-table thead tr { background-color: var(--light-gray); }
        .data-table thead th { font-weight: bold; cursor: pointer; position: relative; }
        .data-table thead th::after { content: ' â†•'; opacity: 0.4; }
        .data-table thead th.sort-asc::after { content: ' â–²'; opacity: 1; }
        .data-table thead th.sort-desc::after { content: ' â–¼'; opacity: 1; }

        /* Mutation Matrix Section */
        .mutation-matrix-controls { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; }
        .mutation-matrix-controls label { font-weight: bold; }
        .mutation-matrix-controls select { padding: 8px 12px; border-radius: 8px; border: 2px solid var(--border-color); font-size: 1em; }
        .mutation-matrix-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .matrix-card { background: var(--light-gray); border-radius: 12px; padding: 20px; border-left: 5px solid var(--primary-color); }
        .matrix-card h4 { color: var(--primary-color); margin-bottom: 10px; }
        .matrix-card p { margin-bottom: 5px; }
        .matrix-card .example { font-style: italic; color: #e74c3c; }
        .matrix-card .correction { color: #27ae60; }

        /* Future Prediction Cards */
        .prediction-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-top: 30px; }
        .prediction-card-container { perspective: 1000px; }
        .prediction-card { background: linear-gradient(135deg, #fd79a8, #e84393); color: white; padding: 25px; border-radius: 15px; min-height: 200px; position: relative; transform-style: preserve-3d; transition: transform 0.7s; }
        .prediction-card-container:hover .prediction-card { transform: rotateY(180deg); }
        .prediction-card-front, .prediction-card-back { position: absolute; top: 0; left: 0; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; padding: 25px; }
        .prediction-card-back { background: linear-gradient(135deg, #0984e3, #74b9ff); transform: rotateY(180deg); border-radius: 15px; }
        .prediction-card h3 { margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>O-Levelåæ–‡ç—…å¥ä¿®æ”¹æ·±åº¦åˆ†ææŠ¥å‘Š (Proç‰ˆ)</h1>
            <div class="subtitle">åŸºäºRIMMLOç¼–ç ä½“ç³»çš„å…«å¹´çœŸé¢˜æ•°æ®åˆ†æä¸æœªæ¥è¶‹åŠ¿é¢„æµ‹ (2016-2023)</div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard">
             <div class="metric-card" onclick="document.getElementById('gene-analysis').scrollIntoView({ behavior: 'smooth' });"><div class="metric-value">3</div><div class="metric-label">æ ¸å¿ƒåŸºå› ç°‡</div></div>
             <div class="metric-card" onclick="document.getElementById('data-table-section').scrollIntoView({ behavior: 'smooth' }); document.getElementById('table-toggle').click();"><div class="metric-value">40</div><div class="metric-label">æ€»é”™è¯¯é¢‘æ¬¡</div></div>
             <div class="metric-card" onclick="document.getElementById('spl-analysis').scrollIntoView({ behavior: 'smooth' });"><div class="metric-value">3.5</div><div class="metric-label">å¹³å‡å¤æ‚åº¦</div></div>
             <div class="metric-card" onclick="document.getElementById('heatmap-analysis').scrollIntoView({ behavior: 'smooth' });"><div class="metric-value">78%</div><div class="metric-label">æ ¸å¿ƒè€ƒç‚¹å æ¯”</div></div>
        </div>
        
        <!-- Error Etiology Tree -->
        <div class="section" id="etiology-tree-section">
            <div class="section-header">ğŸŒ³ è¯­è¨€ç—…å› è¯Šæ–­æ ‘ (Error Etiology Tree)</div>
            <div class="section-content" style="display: flex; justify-content: center;">
                <div class="etiology-tree">
                    <ul><li><div class="root">è¯­è¨€ç—‡çŠ¶</div><ul><li><div class="level-1">æ­é…å†²çª</div><ul><li><div class="level-2">M - æ­é…ä¸å½“</div></li><li><div class="level-2">L - å…³è”è¯é”™è¯¯</div></li></ul></li><li><div class="level-1">ç»“æ„ç¼ºé™·</div><ul><li><div class="level-2">O - æˆåˆ†æ®‹ç¼º</div></li><li><div class="level-2">R - ç”¨è¯é‡å¤</div></li></ul></li><li><div class="level-1">é€»è¾‘å¤±è¡¡</div><ul><li><div class="level-2">M - è¯­åºä¸å½“</div></li><li><div class="level-2">I - ç”¨è¯ä¸å½“</div></li></ul></li></ul></li></ul>
                </div>
            </div>
        </div>

        <!-- Stacked Bar Chart -->
        <div class="section" id="gene-analysis">
            <div class="section-header">ğŸ§¬ ç—…å¥åŸºå› å›¾è°±åˆ†æ (å…«å¹´è€ƒç‚¹æ„æˆ)</div>
            <div class="section-content">
                <div id="stacked-bar-chart" class="chart-container"></div>
            </div>
        </div>

        <!-- Evolving Bubble Chart -->
        <div class="section" id="spl-analysis">
            <div class="section-header">ğŸ“Š é¢˜ç›®éš¾åº¦ä¸å¤æ‚åº¦åˆ†æ (éš¾åº¦-å¤æ‚åº¦å››è±¡é™æ¼”åŒ–å›¾)</div>
            <div class="section-content">
                 <div class="bubble-chart-controls">
                    <label for="year-slider">æ‹–åŠ¨æ»‘å—ï¼Œè§‚å¯Ÿå†å¹´è€ƒé¢˜è¿›åŒ–è¶‹åŠ¿</label>
                    <input type="range" id="year-slider" min="2016" max="2023" value="2016" step="1">
                    <div id="current-year-label">2016</div>
                </div>
                <div id="bubble-chart" class="chart-container"></div>
            </div>
        </div>
        
        <!-- Interactive Heatmap -->
        <div class="section" id="heatmap-analysis">
            <div class="section-header">ğŸ”¥ å…«å¹´è€ƒç‚¹çƒ­åŠ›å›¾ (è€ƒç‚¹-å¹´ä»½äº¤äº’å¼çƒ­åŠ›çŸ©é˜µ)</div>
            <div class="section-content">
                 <div id="heatmap-chart" class="chart-container"></div>
            </div>
        </div>

        <!-- Data Table Section with Filter Controls -->
        <div class="section" id="data-table-section">
            <div class="section-header">ğŸ“‹ å…«å¹´çœŸé¢˜è¯¦ç»†æ•°æ® (å¯ç­›é€‰æ’åº)</div>
            <div class="section-content">
                <div class="table-controls">
                    <button id="table-toggle" class="toggle-button">æ˜¾ç¤º/éšè—è¯¦ç»†æ•°æ®è¡¨</button>
                    <select id="year-filter"><option value="all">æ˜¾ç¤ºå…¨éƒ¨å¹´ä»½</option></select>
                    <select id="type-filter"><option value="all">æ˜¾ç¤ºå…¨éƒ¨é”™è¯¯ç±»å‹</option></select>
                </div>
                <div class="data-table-container" id="table-container">
                    <table class="data-table" id="full-data-table">
                        <thead>
                            <tr>
                                <th data-column="0" data-type="number">å¹´ä»½</th><th data-column="1" data-type="text">é”™è¯¯ç±»å‹</th><th data-column="2" data-type="text">Code</th>
                                <th data-column="3" data-type="number">æ¬¡æ•°</th><th data-column="4" data-type="text">éš¾åº¦</th><th data-column="5" data-type="text">å¤æ‚åº¦</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Mutation Matrix -->
        <div class="section" id="mutation-matrix-section">
            <div class="section-header">ğŸ”¬ ç—…å¥å˜å¼‚çŸ©é˜µ (Mutation Matrix)</div>
            <div class="section-content">
                <div class="mutation-matrix-controls">
                    <label for="error-selector">é€‰æ‹©ä¸€ä¸ªé«˜é¢‘è€ƒç‚¹è¿›è¡Œæ·±åº¦åˆ†æ:</label>
                    <select id="error-selector">
                        <option value="M1-Mismatch">M1 - æ­é…ä¸å½“</option>
                        <option value="R-Redundancy">R - ç”¨è¯é‡å¤</option>
                        <option value="M2-Misordering">M2 - è¯­åºä¸å½“</option>
                        <option value="O-Omission">O - æˆåˆ†æ®‹ç¼º</option>
                    </select>
                </div>
                <div class="mutation-matrix-grid" id="mutation-matrix-display"></div>
            </div>
        </div>

        <!-- Future Predictions -->
        <div class="section">
            <div class="section-header">ğŸ”® æœªæ¥è¿›åŒ–è·¯å¾„é¢„æµ‹</div>
            <div class="section-content">
                <div class="prediction-cards">
                    <div class="prediction-card-container"><div class="prediction-card"><div class="prediction-card-front"><h3>é¢„æµ‹ä¸€ï¼šåŸºå› é‡ç»„</h3><p>å°†å‡ºç°"ä¸€å¥è¯ï¼Œä¸¤ä¸ªç—…"çš„å¤åˆé¢˜å‹ã€‚</p></div><div class="prediction-card-back"><h4>æ ¸å¿ƒæŒ‘æˆ˜</h4><p>è¦æ±‚å­¦ç”Ÿå…·å¤‡å…¨é¢çš„è¯Šæ–­èƒ½åŠ›ã€‚</p></div></div></div>
                    <div class="prediction-card-container"><div class="prediction-card"><div class="prediction-card-front"><h3>é¢„æµ‹äºŒï¼šéšæ€§åŸºå› æ˜¾æ€§åŒ–</h3><p>"è¯­åºä¸å½“"å°†å˜å¾—æ›´å¤æ‚ã€‚</p></div><div class="prediction-card-back"><h4>æ ¸å¿ƒæŒ‘æˆ˜</h4><p>è€ƒéªŒå­¦ç”Ÿæ·±å±‚æ¬¡çš„é€»è¾‘æ€ç»´ã€‚</p></div></div></div>
                    <div class="prediction-card-container"><div class="prediction-card"><div class="prediction-card-front"><h3>é¢„æµ‹ä¸‰ï¼šç¯å¢ƒé€‚åº”æ€§</h3><p>å‡ºç°ç‰¹å®šè¯­å¢ƒå¥å­ã€‚</p></div><div class="prediction-card-back"><h4>æ ¸å¿ƒæŒ‘æˆ˜</h4><p>è¦æ±‚å­¦ç”Ÿå…·å¤‡é«˜çº§è¯­ä½“åˆ¤æ–­èƒ½åŠ›ã€‚</p></div></div></div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const fullData = [
        { year: 2016, type: "æ­é…ä¸å½“", code: "M", freq: 2, diff: "â˜…â˜…â˜†", comp: 3 },
        { year: 2016, type: "ç”¨è¯é‡å¤", code: "R", freq: 1, diff: "â˜…â˜†â˜†", comp: 2 },
        { year: 2016, type: "æˆåˆ†æ®‹ç¼º", code: "O", freq: 1, diff: "â˜…â˜…â˜†", comp: 4 },
        { year: 2016, type: "è¯­åºä¸å½“", code: "M", freq: 1, diff: "â˜…â˜…â˜†", comp: 4 },
        { year: 2017, type: "ç”¨è¯é‡å¤", code: "R", freq: 1, diff: "â˜…â˜†â˜†", comp: 3 },
        { year: 2017, type: "æˆåˆ†æ®‹ç¼º", code: "O", freq: 2, diff: "â˜…â˜…â˜†", comp: 4 },
        { year: 2017, type: "è¯­åºä¸å½“", code: "M", freq: 1, diff: "â˜…â˜…â˜…", comp: 5 },
        { year: 2017, type: "ç”¨è¯ä¸å½“", code: "I", freq: 1, diff: "â˜…â˜…â˜†", comp: 3 },
        { year: 2018, type: "è¯­åºä¸å½“", code: "M", freq: 1, diff: "â˜…â˜…â˜†", comp: 5 },
        { year: 2018, type: "ç”¨è¯é‡å¤", code: "R", freq: 1, diff: "â˜…â˜…â˜†", comp: 3 },
        { year: 2018, type: "ç”¨è¯ä¸å½“", code: "I", freq: 2, diff: "â˜…â˜†â˜† & â˜…â˜…â˜†", comp: "2 & 3" },
        { year: 2018, type: "æˆåˆ†æ®‹ç¼º", code: "O", freq: 1, diff: "â˜…â˜…â˜†", comp: 4 },
        { year: 2019, type: "è¯­åºä¸å½“", code: "M", freq: 2, diff: "â˜…â˜…â˜†", comp: 4 },
        { year: 2019, type: "å…³è”è¯é”™è¯¯", code: "L", freq: 1, diff: "â˜…â˜…â˜†", comp: 5 },
        { year: 2019, type: "æ­é…ä¸å½“", code: "M", freq: 1, diff: "â˜…â˜…â˜†", comp: 3 },
        { year: 2019, type: "ç”¨è¯é‡å¤", code: "R", freq: 1, diff: "â˜…â˜†â˜†", comp: 2 },
        { year: 2020, type: "ç”¨è¯ä¸å½“", code: "I", freq: 1, diff: "â˜…â˜…â˜†", comp: 3 },
        { year: 2020, type: "ç”¨è¯é‡å¤", code: "R", freq: 2, diff: "â˜…â˜†â˜†", comp: "2 & 3" },
        { year: 2020, type: "è¯­åºä¸å½“", code: "M", freq: 1, diff: "â˜…â˜…â˜…", comp: 5 },
        { year: 2020, type: "æˆåˆ†æ®‹ç¼º", code: "O", freq: 1, diff: "â˜…â˜…â˜†", comp: 4 },
        { year: 2021, type: "è¯­åºä¸å½“", code: "M", freq: 2, diff: "â˜…â˜…â˜† & â˜…â˜…â˜…", comp: "4 & 5" },
        { year: 2021, type: "ç”¨è¯ä¸å½“", code: "I", freq: 1, diff: "â˜…â˜…â˜†", comp: 3 },
        { year: 2021, type: "ç”¨è¯é‡å¤", code: "R", freq: 1, diff: "â˜…â˜†â˜†", comp: 2 },
        { year: 2021, type: "æˆåˆ†æ®‹ç¼º", code: "O", freq: 1, diff: "â˜…â˜…â˜†", comp: 5 },
        { year: 2022, type: "è¯­åºä¸å½“", code: "M", freq: 1, diff: "â˜…â˜…â˜†", comp: 4 },
        { year: 2022, type: "ç”¨è¯é‡å¤", code: "R", freq: 1, diff: "â˜…â˜†â˜†", comp: 3 },
        { year: 2022, type: "ç”¨è¯ä¸å½“", code: "I", freq: 2, diff: "â˜…â˜…â˜†", comp: "3 & 4" },
        { year: 2022, type: "æˆåˆ†æ®‹ç¼º", code: "O", freq: 1, diff: "â˜…â˜…â˜†", comp: 5 },
        { year: 2023, type: "æˆåˆ†æ®‹ç¼º", code: "O", freq: 1, diff: "â˜…â˜†â˜†", comp: 3 },
        { year: 2023, type: "å…³è”è¯é”™è¯¯", code: "L", freq: 1, diff: "â˜…â˜…â˜†", comp: 5 },
        { year: 2023, type: "æ­é…ä¸å½“", code: "M", freq: 2, diff: "â˜…â˜…â˜… & â˜…â˜…â˜†", comp: "4 & 4" },
        { year: 2023, type: "ç”¨è¯é‡å¤", code: "R", freq: 1, diff: "â˜…â˜†â˜†", comp: 3 }
    ];
    
    // --- DATA TABLE LOGIC WITH FILTERING & SORTING ---
    const tableBody = document.getElementById('data-table-body');
    const tableContainer = document.getElementById('table-container');
    const tableToggleBtn = document.getElementById('table-toggle');
    const yearFilter = document.getElementById('year-filter');
    const typeFilter = document.getElementById('type-filter');

    function renderTable(dataToDisplay) {
        tableBody.innerHTML = '';
        dataToDisplay.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${item.year}</td><td>${item.type}</td><td>${item.code}</td><td>${item.freq}</td><td>${item.diff}</td><td>${item.comp}</td>`;
            tableBody.appendChild(row);
        });
    }

    function populateFilters() {
        const years = [...new Set(fullData.map(d => d.year))].sort();
        const types = [...new Set(fullData.map(d => d.type))];
        years.forEach(year => {
            const option = document.createElement('option');
            option.value = year; option.textContent = `${year}å¹´`; yearFilter.appendChild(option);
        });
        types.forEach(type => {
            const option = document.createElement('option');
            option.value = type; option.textContent = type; typeFilter.appendChild(option);
        });
    }

    function filterAndRenderTable() {
        let filteredData = fullData;
        if (yearFilter.value !== 'all') filteredData = filteredData.filter(d => d.year == yearFilter.value);
        if (typeFilter.value !== 'all') filteredData = filteredData.filter(d => d.type === typeFilter.value);
        renderTable(filteredData);
    }
    
    tableToggleBtn.addEventListener('click', () => tableContainer.classList.toggle('show'));
    
    document.querySelectorAll('#full-data-table thead th').forEach(headerCell => {
        headerCell.addEventListener('click', () => {
            const table = headerCell.closest('table');
            const columnIndex = headerCell.cellIndex;
            const isAsc = headerCell.classList.contains('sort-asc');
            const type = headerCell.dataset.type;
            sortTableByColumn(table, columnIndex, !isAsc, type);
            table.querySelectorAll('th').forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
            headerCell.classList.toggle('sort-asc', !isAsc);
            headerCell.classList.toggle('sort-desc', isAsc);
        });
    });

    function sortTableByColumn(table, column, asc = true, type = 'text') {
        const dirModifier = asc ? 1 : -1;
        const tBody = table.tBodies[0];
        const rows = Array.from(tBody.querySelectorAll('tr'));
        const sortedRows = rows.sort((a, b) => {
            let aColText = a.querySelector(`td:nth-child(${column + 1})`).textContent.trim();
            let bColText = b.querySelector(`td:nth-child(${column + 1})`).textContent.trim();
            if (type === 'number') return (parseFloat(aColText) - parseFloat(bColText)) * dirModifier;
            return aColText.localeCompare(bColText, 'zh-Hans-CN') * dirModifier;
        });
        while (tBody.firstChild) tBody.removeChild(tBody.firstChild);
        tBody.append(...sortedRows);
    }
    
    populateFilters();
    filterAndRenderTable();
    yearFilter.addEventListener('change', filterAndRenderTable);
    typeFilter.addEventListener('change', filterAndRenderTable);

    // --- MUTATION MATRIX LOGIC ---
    const mutationData = {
        'M1-Mismatch': [
            { title: "åŠ¨å®¾æ­é…", example: "åŠ æ·±äº†å›½é™…ç«äº‰åŠ›", correction: "åº”ä¸ºæå‡/åŠ å¼º" },
            { title: "ä¿®é¥°è¯­æ­é…", example: "æ€»ä¼šå‘¨å¯†åœ°æ²Ÿé€š", correction: "åº”ä¸ºå……åˆ†åœ°" },
            { title: "ä¸»è°“æ­é…", example: "æ„è¯†æœ‰å¾…å¢å¼º", correction: "æ„è¯†æœ‰å¾…æé«˜æˆ–èƒ½åŠ›æœ‰å¾…å¢å¼º" },
            { title: "é¢†åŸŸé”™ä½", example: "ç§‘æŠ€è¯­å¢ƒä¸‹å‘ˆç°ç—‡çŠ¶", correction: "åº”ä¸ºè¡¨ç°å‡º...é—®é¢˜" }
        ],
        'R-Redundancy': [
            { title: "è¯­ä¹‰é‡å¤", example: "æ‰€æœ‰æ¯ä¸ªäººéƒ½åº”è¯¥", correction: "åˆ é™¤æ‰€æœ‰æˆ–æ¯ä¸ª" },
            { title: "ç»“æ„èµ˜ä½™", example: "ä»¥å…¨æ–°çš„å½¢å¼è¿›è¡Œä¸¾åŠ", correction: "åˆ é™¤è¿›è¡Œæˆ–ä¸¾åŠ" },
            { title: "è¯ç¼€é‡å¤", example: "æ°‘ä¼—ä»¬éƒ½å¾ˆæ¬¢è¿", correction: "åˆ é™¤ä»¬" },
            { title: "èŒƒå›´é‡å ", example: "å¤§çº¦ä¼°è®¡æœ‰äº”ç™¾äºº", correction: "åˆ é™¤å¤§çº¦æˆ–ä¼°è®¡" }
        ],
        'M2-Misordering': [
            { title: "ä¿®é¥°è¯­é”™ä½", example: "æˆ‘ä»¬çš„æ´»åŠ¨çƒ­çƒˆå¼•èµ·åå“", correction: "åº”ä¸ºå¼•èµ·äº†çƒ­çƒˆåå“" },
            { title: "å¤šé‡å®šè¯­æ’åº", example: "ä¸€ä»¶ä¸­å›½çº¢è‰²ä¸ç»¸çš„æ——è¢", correction: "åº”ä¸ºä¸€ä»¶çº¢è‰²ä¸ç»¸çš„ä¸­å›½æ——è¢" },
            { title: "å…³è”è¯ä½ç½®", example: "ä»–ä¸ä½†æˆç»©å¥½", correction: "å…³è”è¯åœ¨ä¸»è¯­å" },
            { title: "é€»è¾‘é¡ºåºé¢ å€’", example: "æˆ‘ä»¬å…¨é¢åœ°ã€æ·±å…¥åœ°åˆ†æ", correction: "ä¸€èˆ¬å…ˆå…¨é¢ï¼Œå†æ·±å…¥" }
        ],
        'O-Omission': [
            { title: "ç¼ºå°‘ä¸»è¯­", example: "è®©å¹´é•¿è€…éƒ½å®‰å¿ƒå…»è€ï¼Œå°†å¸®åŠ©ä»–ä»¬", correction: "(è¿™é¡¹æªæ–½)å°†å¸®åŠ©ä»–ä»¬" },
            { title: "ç¼ºå°‘å®¾è¯­", example: "åœ¨ä»»ä½•é˜¶æ®µéƒ½èƒ½æŠŠæ¡", correction: "åº”ä¸ºæŠŠæ¡å­¦ä¹ çš„æœºä¼š" },
            { title: "ç¼ºå°‘ä»‹è¯", example: "åœ¨å…¨çƒåŒ–çš„å½±å“", correction: "è¡¥å……ä»‹è¯ä¸‹" },
            { title: "æ»¥ç”¨ä»‹è¯è‡´æ®‹ç¼º", example: "é€šè¿‡è¿™æ¬¡æ´»åŠ¨ï¼Œä½¿æˆ‘å­¦åˆ°å¾ˆå¤š", correction: "åˆ é™¤é€šè¿‡æˆ–ä½¿" }
        ]
    };
    const errorSelector = document.getElementById('error-selector');
    const matrixDisplay = document.getElementById('mutation-matrix-display');
    function updateMatrix(errorType) {
        matrixDisplay.innerHTML = '';
        const data = mutationData[errorType] || [];
        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'matrix-card';
            card.innerHTML = `<h4>${item.title}</h4><p><b>ç¤ºä¾‹:</b> <span class="example">${item.example}</span></p><p><b>å»ºè®®:</b> <span class="correction">${item.correction}</span></p>`;
            matrixDisplay.appendChild(card);
        });
    }
    errorSelector.addEventListener('change', (e) => updateMatrix(e.target.value));
    updateMatrix('M1-Mismatch');

    // --- ECHARTS IMPLEMENTATION ---
    const themeColors = ['#8ECFC9', '#FFBE7A', '#82B0D2', '#BEB8DC', '#E79796', '#7A6F6F', '#95DEE3'];
    const difficultyMap = { 'â˜…â˜†â˜†': 1, 'â˜…â˜…â˜†': 2, 'â˜…â˜…â˜…': 3 };
    const processedData = fullData.map(d => {
        let specificType = d.code === 'M' ? (d.type === 'æ­é…ä¸å½“' ? 'M1-æ­é…ä¸å½“' : 'M2-è¯­åºä¸å½“') : `${d.code}-${d.type}`;
        const complexity = typeof d.comp === 'string' ? parseFloat(d.comp.split('&')[0]) : d.comp;
        const difficulty = typeof d.diff === 'string' && d.diff.includes('&') ? difficultyMap[d.diff.split('&')[0].trim()] : difficultyMap[d.diff];
        return { ...d, specificType, difficultyNum: difficulty, complexityNum: complexity };
    });
    const years = [...new Set(processedData.map(d => d.year))].sort();
    const errorTypes = [...new Set(processedData.map(d => d.specificType))].sort();

    function renderStackedBarChart() {
        const myChart = echarts.init(document.getElementById('stacked-bar-chart'));
        const seriesData = errorTypes.map(type => ({
            name: type, type: 'bar', stack: 'total', emphasis: { focus: 'series' },
            data: years.map(year => processedData.filter(d => d.year === year && d.specificType === type).reduce((sum, item) => sum + item.freq, 0))
        }));
        myChart.setOption({
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            legend: { data: errorTypes, top: 10, textStyle: { color: '#333' } },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { type: 'category', data: years }, yAxis: { type: 'value' },
            series: seriesData, color: themeColors
        });
        return myChart;
    }

    function renderBubbleChart() {
        const myChart = echarts.init(document.getElementById('bubble-chart'));
        const slider = document.getElementById('year-slider');
        const yearLabel = document.getElementById('current-year-label');
        const dataByYear = years.reduce((acc, year) => {
            acc[year] = processedData.filter(d => d.year === year).map(d => [d.complexityNum, d.difficultyNum, d.freq, d.specificType, d.example || '']);
            return acc;
        }, {});
        function updateChart(year) {
            yearLabel.textContent = year;
            myChart.setOption({
                title: { text: `${year}å¹´ è€ƒé¢˜éš¾åº¦-å¤æ‚åº¦åˆ†å¸ƒ`, left: 'center' },
                xAxis: { name: 'å¥å­å¤æ‚åº¦', nameLocation: 'middle', nameGap: 30, type: 'value', min: 1, max: 5, interval: 1, splitLine: { lineStyle: { type: 'dashed' } } },
                yAxis: { name: 'é¢˜ç›®éš¾åº¦', nameLocation: 'middle', nameGap: 30, type: 'value', min: 0, max: 3, interval: 1, axisLabel: { formatter: (v) => ['','â˜…â˜†â˜†','â˜…â˜…â˜†','â˜…â˜…â˜…'][v] || '' }, splitLine: { lineStyle: { type: 'dashed' } } },
                tooltip: { formatter: (p) => `<b>${p.data[3]}</b><br/>å¤æ‚åº¦: ${p.data[0]}<br/>éš¾åº¦: ${['','â˜…â˜†â˜†','â˜…â˜…â˜†','â˜…â˜…â˜…'][p.data[1]]}<br/>é¢‘æ¬¡: ${p.data[2]}` },
                series: [{ type: 'scatter', data: dataByYear[year], symbolSize: p => p[2] * 25, itemStyle: { opacity: 0.7 }, label: { show: true, formatter: '{@[3]}', fontSize: 9 } }],
                color: themeColors
            }, true);
        }
        slider.addEventListener('input', (e) => updateChart(e.target.value));
        updateChart(slider.value);
        return myChart;
    }

    function renderHeatmap() {
        const myChart = echarts.init(document.getElementById('heatmap-chart'));
        const data = errorTypes.flatMap((type, typeIndex) => years.map((year, yearIndex) => [yearIndex, typeIndex, processedData.filter(d => d.year === year && d.specificType === type).reduce((sum, item) => sum + item.freq, 0)])).filter(item => item[2] > 0);
        myChart.setOption({
            tooltip: { position: 'top' }, grid: { height: '70%', top: '10%' },
            xAxis: { type: 'category', data: years, splitArea: { show: true } },
            yAxis: { type: 'category', data: errorTypes, splitArea: { show: true } },
            visualMap: { min: 0, max: 3, calculable: true, orient: 'horizontal', left: 'center', bottom: '5%', inRange: { color: ['#d1c4e9', '#764ba2'] } },
            series: [{ name: 'å‡ºç°é¢‘æ¬¡', type: 'heatmap', data: data, label: { show: true }, emphasis: { itemStyle: { shadowBlur: 10, shadowColor: 'rgba(0, 0, 0, 0.5)' } } }]
        });
        return myChart;
    }

    const charts = [renderStackedBarChart(), renderBubbleChart(), renderHeatmap()];
    window.addEventListener('resize', () => charts.forEach(chart => chart.resize()));
});
</script>
</body>
</html>