<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O-Level E-Math Practice Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2563eb;
            --text-on-dark: rgba(255, 255, 255, 0.95);
            --card-background: rgba(255, 255, 255, 0.98);
            --text-color: #1f2937;
            --text-light: #6b7280;
            --status-not-started: #fca5a5;
            --status-in-progress: #fde68a;
            --status-practicing: #93c5fd;
            --status-mastered: #86efac;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%); min-height: 100vh; color: var(--text-color); }
        .hidden { display: none !important; }
        
        /* ÊÅ¢Â§ç‰∫Ü Auth Ê†∑Âºè */
        #auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .auth-box { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .auth-box h2 { margin-bottom: 20px; color: var(--text-color); }
        .auth-box .form-input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px; font-size: 1rem; }
        .auth-box .btn { width: 100%; padding: 12px; border-radius: 8px; font-size: 1rem; font-weight: 500; margin-top: 10px; }
        .auth-toggle-link { margin-top: 20px; color: var(--primary-color); cursor: pointer; font-size: 0.9rem; }
        .auth-error { color: #dc2626; margin-top: 15px; font-size: 0.9rem; min-height: 1.2em; }
        
        #main-app-container { padding-top: 90px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 30px; }
        .header { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.2); position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; padding: 0 30px; }
        .logo { font-size: 1.8rem; font-weight: 700; color: white; text-shadow: 1px 1px 5px rgba(0,0,0,0.2); }
        .header-user-info { color: white; font-size: 0.9rem; display: flex; align-items: center; gap: 15px; }
        .main-content { padding: 40px 0; }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        .section-title { font-size: 2.2rem; font-weight: 700; color: var(--text-on-dark); text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 500; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: white; color: var(--primary-color); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-primary:hover { background-color: #f8f9fa; transform: translateY(-2px); }
        .btn-secondary { background: rgba(255,255,255,0.2); color: var(--text-on-dark); border: 1px solid rgba(255,255,255,0.3); }
        .btn-secondary:hover { background: rgba(255,255,255,0.3); }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        
        .toolbar { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); margin-bottom: 40px; flex-wrap: wrap; gap: 20px; }
        .search-box { display: flex; align-items: center; background: #f1f3f5; border-radius: 8px; padding: 8px 12px; min-width: 250px; }
        .search-box input { border: none; outline: none; flex: 1; font-size: 14px; background: transparent; }
        .status-filter { display: flex; align-items: center; gap: 20px; padding: 0 10px; flex-grow: 1; justify-content: center; flex-wrap: wrap; }
        .status-filter label { display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; font-size: 0.95rem; }
        .status-filter input[type="radio"] { display: none; }
        .status-indicator { width: 14px; height: 14px; border-radius: 50%; transition: all 0.2s ease-in-out; }
        .status-filter input[type="radio"] + .status-indicator { background-color: #e5e7eb; box-shadow: inset 0 0 0 2px white; }
        .status-filter input[type="radio"]:checked + .status-indicator { background-color: var(--color); transform: scale(1.2); box-shadow: 0 0 0 2px white, 0 0 0 4px var(--color); }
        .status-indicator.all { --color: #c7d2fe; }
        .status-indicator.not-started { --color: var(--status-not-started); }
        .status-indicator.in-progress { --color: var(--status-in-progress); }
        .status-indicator.practicing { --color: var(--status-practicing); }
        .status-indicator.mastered { --color: var(--status-mastered); }
        
        .practice-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 30px; }
        .practice-card { background: var(--card-background); border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; overflow: visible; position: relative; }
        .practice-card:hover { transform: translateY(-8px); box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15); }
        .card-header { padding: 20px; color: white; position: relative; border-radius: 16px 16px 0 0; }
        
        /* Updated card headers for 4 categories */
        .card-header-g3Core { background: linear-gradient(135deg, #1e40af, #3b82f6); } /* G3 Core - Blue */
        .card-header-g3Satellite { background: linear-gradient(135deg, #047857, #10b981); } /* G3 Satellite - Green */
        .card-header-g4Core { background: linear-gradient(135deg, #6b21a8, #a855f7); } /* G4 Core - Purple */
        .card-header-g4Satellite { background: linear-gradient(135deg, #b91c1c, #ef4444); } /* G4 Satellite - Red */

        .topic-badge { display: inline-block; background: rgba(255,255,255,0.25); padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .card-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 5px; line-height: 1.3; }
        .card-meta { font-size: 0.85rem; opacity: 0.9; }
        .card-content { padding: 25px; }
        .archetype-label { font-size: 0.75rem; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .archetype-text { font-size: 0.9rem; color: var(--text-color); line-height: 1.5; margin-bottom: 15px; padding: 12px; background: #f9fafb; border-radius: 8px; border-left: 3px solid #3b82f6; }
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .info-item { background: #f8f9fa; border-radius: 8px; padding: 10px; text-align: center; }
        .info-label { font-size: 0.8rem; color: var(--text-light); }
        .info-value { font-weight: 500; }
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; display: inline-block; text-transform: capitalize;}
        .status-badge.not-started { background-color: var(--status-not-started); color: #374151; }
        .status-badge.in-progress { background-color: var(--status-in-progress); color: #374151; }
        .status-badge.practicing { background-color: var(--status-practicing); color: #374151; }
        .status-badge.mastered { background-color: var(--status-mastered); color: #374151; }
        .difficulty-badge { font-weight: 500; text-transform: capitalize; }
        .difficulty-beginner { color: #059669; }
        .difficulty-intermediate { color: #f59e0b; }
        .difficulty-advanced { color: #dc2626; }
        
        .card-actions-menu { position: absolute; top: 15px; right: 15px; width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(255, 255, 255, 0.2); color: white; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .card-actions-menu:hover { background: rgba(255, 255, 255, 0.4); }
        .card-menu { display: none; position: absolute; top: 55px; right: 15px; background: white; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); z-index: 10; overflow: hidden; }
        .card-menu.show { display: block; }
        .card-menu-item { display: flex; align-items: center; gap: 10px; padding: 12px 20px; border: none; background: none; width: 100%; text-align: left; cursor: pointer; font-size: 0.9rem; color: var(--text-color); }
        .card-menu-item:hover { background-color: #f1f3f5; }
        .card-menu-item.delete { color: #dc2626; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 600px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal-header { font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;}
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; font-family: inherit; }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px; }
    </style>
</head>
<body>

    <!-- ÊÅ¢Â§ç‰∫Ü Auth Container -->
    <div id="auth-container">
        <div class="auth-box">
            <div id="login-view">
                <h2>Login to E-Math Tracker</h2>
                <form id="login-form">
                    <input type="email" id="login-email" class="form-input" placeholder="Email" required>
                    <input type="password" id="login-password" class="form-input" placeholder="Password" required>
                    <p id="login-error" class="auth-error"></p>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>
                <p class="auth-toggle-link">Don't have an account? <span onclick="toggleAuthView()" style="text-decoration: underline;">Register</span></p>
            </div>
            <div id="register-view" class="hidden">
                <h2>Create New Account</h2>
                <form id="register-form">
                    <input type="email" id="register-email" class="form-input" placeholder="Email" required>
                    <input type="password" id="register-password" class="form-input" placeholder="Password (min 6 characters)" required>
                    <p id="register-error" class="auth-error"></p>
                    <button type="submit" class="btn btn-primary">Register</button>
                </form>
                <p class="auth-toggle-link">Already have an account? <span onclick="toggleAuthView()" style="text-decoration: underline;">Login</span></p>
            </div>
        </div>
    </div>
    
    <!-- ÊÅ¢Â§ç‰∫Ü 'hidden' Á±ª -->
    <div id="main-app-container" class="hidden">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">üìê E-Math Practice Tracker</div>
                    <div class="header-user-info">
                        <!-- ÊÅ¢Â§ç‰∫Ü user-email-display -->
                        <span id="user-email-display"></span>
                        <!-- ÊÅ¢Â§ç‰∫Ü Logout ÊåâÈíÆ -->
                        <button class="btn btn-danger" onclick="handleLogout()">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="container">
                <div class="content-header">
                    <!-- Ê†áÈ¢òÈªòËÆ§‰∏∫ G3 Core -->
                    <h1 class="section-title" id="sectionTitle">G3 Core Topics</h1>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openPracticeModal()">‚ûï Add Practice</button>
                        <button class="btn btn-secondary" onclick="exportProgress()">üìä Export Progress</button>
                    </div>
                </div>
                <div class="toolbar">
                    <div class="search-box">
                        <span>üîç</span>
                        <input type="text" placeholder="Search by name..." id="searchInput">
                    </div>
                    <div class="status-filter" id="statusFilterContainer">
                        <label><input type="radio" name="statusFilter" value="all" checked> <span class="status-indicator all"></span> All</label>
                        <label><input type="radio" name="statusFilter" value="not-started"> <span class="status-indicator not-started"></span> Not Started</label>
                        <label><input type="radio" name="statusFilter" value="in-progress"> <span class="status-indicator in-progress"></span> In Progress</label>
                        <label><input type="radio" name="statusFilter" value="practicing"> <span class="status-indicator practicing"></span> Practicing</label>
                        <label><input type="radio" name="statusFilter" value="mastered"> <span class="status-indicator mastered"></span> Mastered</label>
                    </div>
                    <!-- Updated G3/G4 select options -->
                    <select id="sectionSelect" class="form-select" style="max-width:200px;" onchange="changeSection()">
                            <option value="g3Core">G3 Core</option>
                            <option value="g3Satellite">G3 Satellite</option>
                            <option value="g4Core">G4 Core</option>
                            <option value="g4Satellite">G4 Satellite</option>
                            <option value="all-sections">All Topics</option>
                        </select>
                </div>
                <div class="practice-grid" id="practiceGrid"></div>
            </div>
        </main>
    </div>
    
    <div class="modal" id="practiceModal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Add New Practice</div>
            <form id="practiceForm">
                <div class="form-group">
                    <label class="form-label">Practice Name *</label>
                    <input type="text" class="form-input" id="practiceName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Topic Type</label>
                    <!-- This select is now populated dynamically based on topicTypes -->
                    <select class="form-select" id="practiceType"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Archetype (Problem Type)</label>
                    <input type="text" class="form-input" id="archetype" placeholder="e.g., Solving for sides/angles in 2D Bearing scenarios">
                </div>
                <div class="form-group">
                    <label class="form-label">Practice Content/Link *</label>
                    <textarea class="form-textarea" id="documentContent" rows="4" placeholder="Enter practice content or paste document link..." required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Drill Type</label>
                    <select class="form-select" id="drillType">
                        <option value="golden-drill">Golden Drill Package (ÈªÑÈáëÈ¢òÂ∫ì)</option>
                        <option value="prototype-deep-dive">Prototype Deep Dive & Variation Drills (ÊØçÈ¢òÁ≤æËÆ≤‰∏éÂèòÂºèËÆ≠ÁªÉ)</option>
                        <option value="mistake-rewind">"Mistake Rewind" Action Handbook (ÈîôÈ¢òÊó∂ÂÖâÊú∫Ë°åÂä®ÊâãÂÜå)</option>
                        <option value="sop-simulators">SOP Live Simulators (SOPÂÆûÊàòÊ®°ÊãüÂô®)</option>
                        <option value="final-sprint">Final Sprint Simulation Paper (A1ÂÜ≤Âà∫‰ªøÁúüËØïÂç∑)</option>
                        <option value="final-sprint">drill-BÔºàBreakthroughÔºâ</option>
                        <option value="final-sprint">drill-TÔºàTimedÔºâ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="practiceStatus">
                        <option value="not-started">Not Started</option>
                        <option value="in-progress">In Progress</option>
                        <option value="practicing">Practicing</option>
                        <option value="mastered">Mastered</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Difficulty Level</label>
                    <select class="form-select" id="difficultyLevel">
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Estimated Time (minutes)</label>
                    <input type="number" class="form-input" id="estimatedTime" min="5" value="30">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closePracticeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save to Cloud</button>
                </div>
            </form>
        </div>
    </div>

    <!-- System Modal for alerts and confirmations -->
    <div class="modal" id="systemModal">
        <div class="modal-content" style="max-width: 450px; text-align: center;">
            <h3 id="systemModalTitle" class="modal-header" style="justify-content: center; text-align: center;"></h3>
            <p id="systemModalMessage" style="margin: 20px 0; line-height: 1.6;"></p>
            <div id="systemModalActions" class="form-actions" style="justify-content: center;"></div>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyDdtQYfOC87IvpTZPFoDyb6ZgpEISzqw_I",
                authDomain: "emath-study-plan.firebaseapp.com",
                projectId: "emath-study-plan",
                storageBucket: "emath-study-plan.appspot.com",
                messagingSenderId: "589299697460",
                appId: "1:589299697460:web:df1e0bb0586b3740c04761"
            };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // NEW: Added the 27 topics grouped by the 4 categories
        const topicTypes = {
            'g3Core': [
                'Trigonometry (Foundation)', 'Similarity & Congruency', 'Circle Properties (Intro)', 
                'Algebraic Manipulation', 'Equations & Inequalities', 'Functions & Graphs', 
                'Number Theory', 'Ratio/Proportion/Rate', 'Percentages & Simple Interest', 
                'Data Analysis & Representation'
            ],
            'g3Satellite': [
                'Coordinate Geometry (basic)', 'Mensuration (prisms & cylinders)'
            ],
            'g4Core': [
                'Full Trigonometry (Sine/Cosine Rules)', 'Mensuration Extension (cones/pyramids/spheres)', 'Circle Theorems', 
                'Advanced Quadratics', 'Algebraic Fractions', 'Quadratic Inequalities & Functions (Transformations)', 
                'Compound Interest & Depreciation', 'Direct/Inverse Proportions', 
                'Grouped Data & Measures of Spread, Probability'
            ],
            'g4Satellite': [
                'Advanced Mensuration (composite solids)', 'Coordinate Geometry (intersection, locus)', 
                'Sequences, Surds', 'Simultaneous Quad-Linear Systems', 
                'Exchange Rate, Speed/Time/Distance in Complex Contexts', 'Probability Trees & Compound Events'
            ]
        };

        // Updated practicesData structure
        let practicesData = {
                g3Core: [],
                g3Satellite: [],
                g4Core: [],
                g4Satellite: []
            };
        // Default section changed to g3Core
        let currentSection = 'g3Core';
        let currentStatusFilter = 'all';
        let user = null;
        let userDocRef = null;
        let unsubscribe; // To store the onSnapshot listener

        // --- MODAL & UI FUNCTIONS ---

        function showSystemModal({ title, message, buttons }) {
            const modal = document.getElementById('systemModal');
            document.getElementById('systemModalTitle').textContent = title;
            document.getElementById('systemModalMessage').innerHTML = message;
            const actionsContainer = document.getElementById('systemModalActions');
            actionsContainer.innerHTML = '';

            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `btn ${btnInfo.class || 'btn-secondary'}`;
                button.onclick = () => {
                    if (btnInfo.onClick) btnInfo.onClick();
                    modal.style.display = 'none';
                };
                actionsContainer.appendChild(button);
            });
            modal.style.display = 'flex';
        }

        // ÊÅ¢Â§ç‰∫Ü toggleAuthView
        window.toggleAuthView = function() {
            document.getElementById('login-view').classList.toggle('hidden');
            document.getElementById('register-view').classList.toggle('hidden');
            document.getElementById('login-error').textContent = '';
            document.getElementById('register-error').textContent = '';
        };

        // --- AUTHENTICATION (ÊÅ¢Â§ç) ---

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            signInWithEmailAndPassword(auth, email, password).catch(error => {
                document.getElementById('login-error').textContent = error.message;
            });
        });

        document.getElementById('register-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            createUserWithEmailAndPassword(auth, email, password).catch(error => {
                document.getElementById('register-error').textContent = error.message;
            });
        });

        // ÊÅ¢Â§ç‰∫Ü handleLogout
        window.handleLogout = function() {
             showSystemModal({
                title: 'Confirm Logout',
                message: 'Are you sure you want to log out?',
                buttons: [
                    { text: 'Cancel' },
                    { text: 'Logout', class: 'btn-danger', onClick: () => signOut(auth) }
                ]
            });
        };

        // ÊÅ¢Â§ç‰∫ÜÂéüÂßãÁöÑ onAuthStateChanged ÈÄªËæëÔºåÂπ∂‰øÆÂ§ç‰∫ÜÁôªÂá∫ bug
        onAuthStateChanged(auth, async (firebaseUser) => {
            if (unsubscribe) unsubscribe(); // Detach old listener

            if (firebaseUser) {
                user = firebaseUser;
                // ‰ΩøÁî® firebaseUser.uid ‰Ωú‰∏∫ userId
                const userId = firebaseUser.uid;
                userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'user_data', 'emath-practices');
                
                // ÊòæÁ§∫‰∏ªÂ∫îÁî®, ÈöêËóèÁôªÂΩïÊ°Ü
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('main-app-container').classList.remove('hidden');
                document.getElementById('user-email-display').textContent = user.email || 'Authenticated User';

                // Firestore Âä†ËΩΩÈÄªËæë (‰ΩøÁî® G3/G4 ÁªìÊûÑ)
                const docSnap = await getDoc(userDocRef);
                if (!docSnap.exists()) {
                    await setDoc(userDocRef, { g3Core: [], g3Satellite: [], g4Core: [], g4Satellite: [] });
                }

                // Listen for real-time updates
                unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        // Load data for all 4 categories, providing empty array fallbacks
                        practicesData = { 
                            g3Core: data.g3Core || [], 
                            g3Satellite: data.g3Satellite || [],
                            g4Core: data.g4Core || [],
                            g4Satellite: data.g4Satellite || []
                        };
                    }
                    renderPractices();
                });
            } else {
                // ËøôÊòØ‰øÆÂ§çÁôªÂá∫ bug ÁöÑÂÖ≥ÈîÆ:
                // Áî®Êà∑Êú™ÁôªÂΩïÔºåÊòæÁ§∫ÁôªÂΩïÊ°Ü, ÈöêËóè‰∏ªÂ∫îÁî®
                user = null;
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('main-app-container').classList.add('hidden');
                document.getElementById('user-email-display').textContent = '';
            }
        });

        // --- RENDERING & DATA DISPLAY ---

        function renderPractices() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let sourceItems = [];
            if (currentSection === 'all-sections') {
                // Combine all 4 arrays, adding a _section property to each item
                sourceItems = [
                    ...practicesData.g3Core.map(p => ({ ...p, _section: 'g3Core' })),
                    ...practicesData.g3Satellite.map(p => ({ ...p, _section: 'g3Satellite' })),
                    ...practicesData.g4Core.map(p => ({ ...p, _section: 'g4Core' })),
                    ...practicesData.g4Satellite.map(p => ({ ...p, _section: 'g4Satellite' }))
                ];
            } else {
                // Get items from the currently selected section
                sourceItems = (practicesData[currentSection] || []).map(p => ({ ...p, _section: currentSection }));
            }

            let filteredItems = sourceItems;
            if (currentStatusFilter !== 'all') {
                filteredItems = filteredItems.filter(p => p.status === currentStatusFilter);
            }
            if (searchTerm) {
                filteredItems = filteredItems.filter(p => p.name.toLowerCase().includes(searchTerm));
            }

            const grid = document.getElementById('practiceGrid');
            grid.innerHTML = filteredItems.length ? filteredItems.map(p => {
                // Updated badge logic for 4 categories
                const badgeText = {
                    g3Core: 'G3 Core',
                    g3Satellite: 'G3 Satellite',
                    g4Core: 'G4 Core',
                    g4Satellite: 'G4 Satellite'
                };
                const badge = badgeText[p._section] || 'Topic';
                
                const isLink = p.documentContent && (p.documentContent.trim().startsWith('http://') || p.documentContent.trim().startsWith('https://'));
                const btn = isLink 
                    ? `<a href="${p.documentContent}" target="_blank" class="btn btn-primary" style="width:100%">Open Document</a>`
                    : `<button class="btn btn-primary" onclick="viewContent(${p.id})" style="width:100%">View Content</button>`;
                const arch = p.archetype ? `<div class="archetype-label">Problem Archetype</div><div class="archetype-text">${p.archetype}</div>` : '';
                
                return `<div class="practice-card">
                    <!-- Updated header class to use p._section -->
                    <div class="card-header card-header-${p._section}">
                        <div class="topic-badge">${badge}</div>
                        <h3 class="card-title">${p.name}</h3>
                        <p class="card-meta">${p.type}</p>
                        <button class="card-actions-menu" onclick="event.stopPropagation();this.nextElementSibling.classList.toggle('show')">‚ãÆ</button>
                        <div class="card-menu">
                            <button class="card-menu-item" onclick="openPracticeModal(${p.id})">‚úèÔ∏è Edit</button>
                            <button class="card-menu-item delete" onclick="handleDeletePractice(${p.id})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    <div class="card-content">
                        ${arch}
                        <div class="info-grid">
                            <div class="info-item"><div class="info-label">Status</div><div class="info-value"><span class="status-badge status-${p.status}">${p.status.replace('-', ' ')}</span></div></div>
                            <div class="info-item"><div class="info-label">Difficulty</div><div class="info-value difficulty-badge difficulty-${p.difficulty}">${p.difficulty}</div></div>
                            <div class="info-item"><div class="info-label">Date Added</div><div class="info-value">${p.dateAdded}</div></div>
                            <div class="info-item"><div class="info-label">Est. Time</div><div class="info-value">${p.estimatedTime} min</div></div>
                        </div>
                        ${btn}
                    </div>
                </div>`;
            }).join('') : '<p style="text-align:center;grid-column:1/-1;padding:50px;color:white;font-size:1.1rem;">No practices found for the current filter.</p>';
        }
        
        // --- CRUD & ACTIONS ---

        window.openPracticeModal = function(id = null) {
            const modal = document.getElementById('practiceModal');
            const form = document.getElementById('practiceForm');
            form.reset();
            form.dataset.editingId = id || '';
            
            // --- UPDATED LOGIC ---
            // Populate dropdown with all 27 topics, grouped by category
            const practiceTypeSelect = document.getElementById('practiceType');
            let optionsHtml = '';
            optionsHtml += '<optgroup label="G3 Core Topics">';
            optionsHtml += topicTypes.g3Core.map(t => `<option value="${t}">${t}</option>`).join('');
            optionsHtml += '</optgroup>';
            optionsHtml += '<optgroup label="G3 Satellite Topics">';
            optionsHtml += topicTypes.g3Satellite.map(t => `<option value="${t}">${t}</option>`).join('');
            optionsHtml += '</optgroup>';
            optionsHtml += '<optgroup label="G4 Core Topics">';
            optionsHtml += topicTypes.g4Core.map(t => `<option value="${t}">${t}</option>`).join('');
            optionsHtml += '</optgroup>';
            optionsHtml += '<optgroup label="G4 Satellite Topics">';
            optionsHtml += topicTypes.g4Satellite.map(t => `<option value="${t}">${t}</option>`).join('');
            optionsHtml += '</optgroup>';
            practiceTypeSelect.innerHTML = optionsHtml;
            // --- END OF UPDATE ---
            
            if (id) {
                document.getElementById('modalTitle').textContent = 'Edit Practice';
                // Search all 4 arrays for the practice item
                const p = [
                    ...practicesData.g3Core, 
                    ...practicesData.g3Satellite,
                    ...practicesData.g4Core,
                    ...practicesData.g4Satellite
                ].find(pr => pr.id == id);
                
                if (p) {
                    document.getElementById('practiceName').value = p.name;
                    document.getElementById('practiceType').value = p.type;
                    document.getElementById('archetype').value = p.archetype || '';
                    document.getElementById('documentContent').value = p.documentContent;
                    document.getElementById('drillType').value = p.drillType;
                    document.getElementById('practiceStatus').value = p.status;
                    document.getElementById('difficultyLevel').value = p.difficulty;
                    document.getElementById('estimatedTime').value = p.estimatedTime;
                }
            } else {
                 document.getElementById('modalTitle').textContent = 'Add New Practice';
                 // When adding new, pre-select the first item of the current section if it's not 'all-sections'
                 if(currentSection !== 'all-sections' && topicTypes[currentSection].length > 0){
                     practiceTypeSelect.value = topicTypes[currentSection][0];
                 } else if (topicTypes.g3Core.length > 0) {
                     // Default to first G3 Core topic
                     practiceTypeSelect.value = topicTypes.g3Core[0];
                 }
            }
            modal.style.display = 'flex';
        };

        window.closePracticeModal = function() {
            document.getElementById('practiceModal').style.display = 'none';
        };

        document.getElementById('practiceForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('practiceForm').dataset.editingId ? Number(document.getElementById('practiceForm').dataset.editingId) : null;
            const data = {
                name: document.getElementById('practiceName').value,
                type: document.getElementById('practiceType').value,
                archetype: document.getElementById('archetype').value,
                documentContent: document.getElementById('documentContent').value,
                drillType: document.getElementById('drillType').value,
                status: document.getElementById('practiceStatus').value,
                difficulty: document.getElementById('difficultyLevel').value,
                estimatedTime: parseInt(document.getElementById('estimatedTime').value) || 30
            };

            // NEW: Determine the correct section (g3Core, g3Satellite, etc.) based on the selected topic type
            let newSection = 'g3Core'; // Default
            if (topicTypes.g3Satellite.includes(data.type)) newSection = 'g3Satellite';
            else if (topicTypes.g4Core.includes(data.type)) newSection = 'g4Core';
            else if (topicTypes.g4Satellite.includes(data.type)) newSection = 'g4Satellite';
            // else it remains 'g3Core'

            if (id) { // Editing
                let oldSection = null;
                let practiceIndex = -1;
                
                // Find which array the practice item is currently in
                if (practiceIndex === -1) { practiceIndex = practicesData.g3Core.findIndex(p => p.id === id); if (practiceIndex !== -1) oldSection = 'g3Core'; }
                if (practiceIndex === -1) { practiceIndex = practicesData.g3Satellite.findIndex(p => p.id === id); if (practiceIndex !== -1) oldSection = 'g3Satellite'; }
                if (practiceIndex === -1) { practiceIndex = practicesData.g4Core.findIndex(p => p.id === id); if (practiceIndex !== -1) oldSection = 'g4Core'; }
                if (practiceIndex === -1) { practiceIndex = practicesData.g4Satellite.findIndex(p => p.id === id); if (practiceIndex !== -1) oldSection = 'g4Satellite'; }

                if (oldSection) {
                    const originalPractice = practicesData[oldSection][practiceIndex];
                    const updatedPractice = { ...originalPractice, ...data };
                    
                    if (oldSection === newSection) {
                        // Category hasn't changed, just update it
                        practicesData[oldSection][practiceIndex] = updatedPractice;
                    } else {
                        // Category changed, remove from old array and add to new one
                        practicesData[oldSection].splice(practiceIndex, 1);
                        practicesData[newSection].push(updatedPractice);
                    }
                }
            } else { // Adding new
                const newPractice = {
                    ...data,
                    id: Date.now(),
                    dateAdded: new Date().toISOString().split('T')[0]
                };
                practicesData[newSection].push(newPractice);
            }

            // Save the entire practicesData object back to Firestore
            await setDoc(userDocRef, practicesData);
            closePracticeModal();
        });

        window.handleDeletePractice = function(id) {
            showSystemModal({
                title: 'Confirm Deletion',
                message: 'Are you sure you want to delete this practice item? This cannot be undone.',
                buttons: [
                    { text: 'Cancel' },
                    { text: 'Delete', class: 'btn-danger', onClick: async () => {
                        // Filter all 4 arrays
                        practicesData.g3Core = practicesData.g3Core.filter(p => p.id != id);
                        practicesData.g3Satellite = practicesData.g3Satellite.filter(p => p.id != id);
                        practicesData.g4Core = practicesData.g4Core.filter(p => p.id != id);
                        practicesData.g4Satellite = practicesData.g4Satellite.filter(p => p.id != id);
                        await setDoc(userDocRef, practicesData);
                    }}
                ]
            });
        };

        window.markAsCompleted = async function(id) {
            // Find the practice item in any of the 4 arrays
            const p = [
                ...practicesData.g3Core, 
                ...practicesData.g3Satellite,
                ...practicesData.g4Core,
                ...practicesData.g4Satellite
            ].find(pr => pr.id == id);
            
            if (p) {
                p.status = 'mastered';
                p.completedDate = new Date().toISOString().split('T')[0];
                await setDoc(userDocRef, practicesData);
            }
        };

        window.viewContent = function(id) {
            // Find the practice item in any of the 4 arrays
            const p = [
                ...practicesData.g3Core, 
                ...practicesData.g3Satellite,
                ...practicesData.g4Core,
                ...practicesData.g4Satellite
            ].find(pr => pr.id == id);

            if (!p) return;
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">${p.name}</div>
                    <div style="margin-bottom:20px">
                        <strong>Type:</strong> ${p.type}<br>
                        ${p.archetype ? `<strong>Archetype:</strong> ${p.archetype}<br>` : ''}
                        <strong>Difficulty:</strong> ${p.difficulty}<br>
                        <strong>Time:</strong> ${p.estimatedTime} min
                    </div>
                    <div style="background:#f8f9fa;padding:20px;border-radius:8px;white-space:pre-wrap;line-height:1.6; max-height: 30vh; overflow-y: auto;">
                        ${p.documentContent}
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                        <button class="btn btn-primary" onclick="markAsCompleted(${p.id}); this.closest('.modal').remove()">Mark as Mastered</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };
        
        window.exportProgress = function() {
            // Combine all 4 arrays
            const all = [
                ...practicesData.g3Core, 
                ...practicesData.g3Satellite,
                ...practicesData.g4Core,
                ...practicesData.g4Satellite
            ];
            
            if (all.length === 0) {
                showSystemModal({ title: 'Export', message: 'There is no data to export.', buttons: [{text: 'OK', class: 'btn-primary'}] });
                return;
            }
            const stats = {
                total: all.length,
                notStarted: all.filter(p => p.status === 'not-started').length,
                inProgress: all.filter(p => p.status === 'in-progress').length,
                practicing: all.filter(p => p.status === 'practicing').length,
                mastered: all.filter(p => p.status === 'mastered').length
            };

            let csv = "Category,Topic,Name,Archetype,Difficulty,Status,Time,Date\n";
            // Export rows for all 4 categories
            practicesData.g3Core.forEach(p => { csv += `"G3 Core","${p.type}","${p.name}","${p.archetype||''}","${p.difficulty}","${p.status}","${p.estimatedTime}","${p.dateAdded}"\n`; });
            practicesData.g3Satellite.forEach(p => { csv += `"G3 Satellite","${p.type}","${p.name}","${p.archetype||''}","${p.difficulty}","${p.status}","${p.estimatedTime}","${p.dateAdded}"\n`; });
            practicesData.g4Core.forEach(p => { csv += `"G4 Core","${p.type}","${p.name}","${p.archetype||''}","${p.difficulty}","${p.status}","${p.estimatedTime}","${p.dateAdded}"\n`; });
            practicesData.g4Satellite.forEach(p => { csv += `"G4 Satellite","${p.type}","${p.name}","${p.archetype||''}","${p.difficulty}","${p.status}","${p.estimatedTime}","${p.dateAdded}"\N`; });

            const link = document.createElement("a");
            link.setAttribute("href", 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv));
            link.setAttribute("download", `emath_progress_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSystemModal({
                title: 'Export Complete',
                message: `<b>Progress exported successfully!</b><br><br>Total: ${stats.total}<br>Not Started: ${stats.notStarted}<br>In Progress: ${stats.inProgress}<br>Practicing: ${stats.practicing}<br>Mastered: ${stats.mastered}`,
                buttons: [{ text: 'OK', class: 'btn-primary' }]
            });
        };

        // --- EVENT LISTENERS ---

        window.changeSection = function() {
            currentSection = document.getElementById('sectionSelect').value;
            // Updated titles object for 4 categories + all
            const titles = { 
                'g3Core': 'G3 Core Topics', 
                'g3Satellite': 'G3 Satellite Topics', 
                'g4Core': 'G4 Core Topics', 
                'g4Satellite': 'G4 Satellite Topics', 
                'all-sections': 'All Topics Overview' 
            };
            document.getElementById('sectionTitle').textContent = titles[currentSection];
            renderPractices();
        };

        document.getElementById('searchInput').addEventListener('input', renderPractices);
        
        document.getElementById('statusFilterContainer').addEventListener('change', (e) => {
            if (e.target.name === 'statusFilter') {
                currentStatusFilter = e.target.value;
                renderPractices();
            }
        });

        document.getElementById('practiceModal').addEventListener('click', (e) => {
            if (e.target.id === 'practiceModal') closePracticeModal();
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.practice-card')) {
                document.querySelectorAll('.card-menu.show').forEach(m => m.classList.remove('show'));
            }
        });

        // ÁßªÈô§‰∫Ü initializeAppAuth() ÂáΩÊï∞
        // onAuthStateChanged ‰ºöËá™Âä®Â§ÑÁêÜÂàùÂßãÁä∂ÊÄÅ

    </script>
</body>
</html>

