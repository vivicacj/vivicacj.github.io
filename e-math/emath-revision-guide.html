<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Math A1 Sprint Study Plan</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 30px auto 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .title {
            color: #2c3e50;
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
            font-weight: 500;
        }
        
        .back-link {
            display: block;
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
            margin-top: 10px;
            transition: color 0.3s ease;
        }

        .back-link:hover {
            color: #2980b9;
            text-decoration: underline;
        }

        .countdown-section {
            padding: 30px 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }

        .countdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .countdown-card {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .countdown-card.paper2 {
            background: linear-gradient(135deg, #4834d4, #686de0);
        }

        .countdown-title {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .countdown-display {
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .countdown-unit {
            font-size: 0.8em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .progress-overview {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #ecf0f1;
            border-radius: 6px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00b894, #00cec9);
            transition: width 0.5s ease;
            border-radius: 6px;
        }

        .week-section {
            background: rgba(255, 255, 255, 0.95);
            margin-bottom: 30px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .week-header {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px 25px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .week-content {
            display: none;
            padding: 25px;
        }

        .week-content.active {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        .week-goal {
            background-color: #f8f9fa;
            border-left: 4px solid #0984e3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: #2c3e50;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .task-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }
        
        .task-table th, .task-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: middle;
        }
        
        .task-table th {
            background-color: #f1f3f5;
            font-weight: 600;
        }

        .task-row:hover {
            background: #f8f9fa;
        }
        
        .day-cell { width: 8%; font-weight: 700; color: #2c3e50; }
        .mission-cell { width: 22%; font-weight: 600; }
        .details-cell { width: 50%; }
        .status-cell {
            width: 20%;
            text-align: center;
        }

        .status-content {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
        }
        
        .task-checkbox {
            transform: scale(1.3);
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .task-completed .details-cell, 
        .task-completed .mission-cell,
        .task-completed .day-cell {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .task-row.task-completed {
            background-color: #f7fdfb;
        }
        
        .details-cell code {
            background-color: #e9ecef;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', 'Consolas', monospace;
            color: #c7254e;
        }
        
        .link-area {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
        }

        .link-pill, .add-link-btn {
            padding: 4px 10px;
            font-size: 0.8em;
            font-weight: 600;
            border-radius: 20px;
            border: 1px solid #3498db;
            background-color: #eaf2f8;
            color: #2980b9;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }

        .link-pill:hover, .add-link-btn:hover {
            background-color: #d4e6f1;
            border-color: #2980b9;
        }

        .add-link-btn {
            border-style: dashed;
            background-color: transparent;
            color: #3498db;
        }

        .expand-icon {
            transition: transform 0.3s ease;
        }

        .expand-icon.rotated { transform: rotate(180deg); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .stat-number { font-size: 2em; font-weight: 700; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }

        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #ff7675, #d63031);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .floating-action:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0,0,0,0.4);
        }

        @media (max-width: 992px) {
             .details-cell { width: 45%; }
             .status-cell { width: 25%; }
        }

        @media (max-width: 768px) {
            .task-table, .task-table th, .task-table td {
                display: block;
                width: 100% !important;
                text-align: left !important;
            }
            .task-table thead { display: none; }
            .task-table tr {
                margin-bottom: 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
                overflow: hidden;
            }
            .task-table td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 40%;
            }
            .task-table td:before {
                position: absolute;
                left: 15px;
                width: 35%;
                font-weight: bold;
                content: attr(data-label);
            }
            .status-cell { display: flex; align-items: center; }
        }
    </style>
    <!-- 引入 Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">🎯 E-Math A1 Sprint Study Plan</h1>
            <p class="subtitle">3-Week Comprehensive Review Plan - Dynamic Tracking System</p>
            <a href="index.html" class="back-link">❮ 返回学习仪表盘</a>
        </div>
        <div class="countdown-section">
            <h2 style="color: white; margin-bottom: 20px; font-size: 1.5em;">⏰ Exam Countdown</h2>
            <div class="countdown-grid">
                <div class="countdown-card">
                    <div class="countdown-title">📝 Paper 1</div>
                    <div class="countdown-display" id="paper1-countdown">--</div>
                    <div class="countdown-unit">days to exam</div>
                </div>
                <div class="countdown-card paper2">
                    <div class="countdown-title">📋 Paper 2</div>
                    <div class="countdown-display" id="paper2-countdown">--</div>
                    <div class="countdown-unit">days to exam</div>
                </div>
            </div>
        </div>
        <div class="progress-overview">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">📊 Overall Progress Overview</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-tasks">0</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completed-tasks">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completion-rate">0%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="days-remaining">--</div>
                    <div class="stat-label">Days Left</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="overall-progress" style="width: 0%"></div>
            </div>
        </div>

        <!-- Week 1 -->
        <div class="week-section">
            <div class="week-header" onclick="toggleWeek(1)">
                <span>🔥 Week 1: Clear All Deficits (Sep 22 - Sep 28)</span>
                <span class="expand-icon" id="icon-1">▼</span>
            </div>
            <div class="week-content" id="week-1">
                <p class="week-goal"><strong>Core Goal:</strong> Complete the first run of all drill packages to identify all weaknesses.</p>
                <table class="task-table">
                    <thead>
                        <tr>
                            <th class="day-cell">Day</th>
                            <th class="mission-cell">Core Mission</th>
                            <th class="details-cell">Specific Asset/Practice List</th>
                            <th class="status-cell">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="task-row" data-task-index="0">
                            <td class="day-cell" data-label="Day" rowspan="2"><strong>Mon</strong></td>
                            <td class="mission-cell" data-label="Mission" rowspan="2"><strong>Algebraic Manipulation</strong></td>
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> Complete the <code>G3 EOY|Comprehensive Algebraic Manipulation</code> drill package.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="1">
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> Fill out "Mistake Analysis Cards" for all your errors.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="2">
                            <td class="day-cell" data-label="Day"><strong>Tue</strong></td>
                            <td class="mission-cell" data-label="Mission"><strong>Satellite Topics (Batch 1)</strong></td>
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> Complete <code>G3 EOY|Indices & Standard Form</code> and <code>G3 EOY|Inequalities</code> drill packages.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="3">
                            <td class="day-cell" data-label="Day" rowspan="2"><strong>Wed</strong></td>
                            <td class="mission-cell" data-label="Mission" rowspan="2"><strong>Quadratic Functions</strong></td>
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> Complete the <code>G3 EOY|Quadratic Functions & Graphs</code> drill package.</td>
                             <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="4">
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> Fill out "Mistake Analysis Cards" for all your errors.</td>
                             <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="5">
                            <td class="day-cell" data-label="Day"><strong>Thu</strong></td>
                            <td class="mission-cell" data-label="Mission"><strong>Satellite Topics (Batch 2)</strong></td>
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> Complete <code>G3 EOY|Ratio & Percentage in Context</code> and <code>G3 EOY|Statistics & Probability</code> drill packages.</td>
                             <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="6">
                            <td class="day-cell" data-label="Day" rowspan="2"><strong>Fri</strong></td>
                            <td class="mission-cell" data-label="Mission" rowspan="2"><strong>Geometric Proofs</strong></td>
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> Complete the <code>G3 EOY|Geometric Proofs & Similarity/Congruency</code> drill package.</td>
                             <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="7">
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> Fill out "Mistake Analysis Cards" for all your errors.</td>
                             <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="8">
                            <td class="day-cell" data-label="Day"><strong>Sat</strong></td>
                            <td class="mission-cell" data-label="Mission"><strong>Satellite Topics (Batch 3)</strong></td>
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> Complete <code>G3 EOY|Coordinate Geometry</code> and <code>G3 EOY|Mensuration</code> drill packages.</td>
                             <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="9">
                            <td class="day-cell" data-label="Day"><strong>Sun</strong></td>
                            <td class="mission-cell" data-label="Mission"><strong>Weekly Review</strong></td>
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> <strong>Update your personal Competency Radar Chart</strong>. Identify the top 3 weaknesses from this week.</td>
                             <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Week 2 -->
        <div class="week-section">
            <div class="week-header" onclick="toggleWeek(2)">
                <span>⚡ Week 2: Core Reinforcement & Speed Training (Sep 29 - Oct 5)</span>
                <span class="expand-icon" id="icon-2">▼</span>
            </div>
            <div class="week-content" id="week-2">
                <p class="week-goal"><strong>Core Goal:</strong> Reinforce weak areas in Core Topics and improve your problem-solving speed.</p>
                <table class="task-table">
                    <thead>
                        <tr>
                            <th class="day-cell">Day</th>
                            <th class="mission-cell">Core Mission</th>
                            <th class="details-cell">Specific Asset/Practice List</th>
                            <th class="status-cell">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="task-row" data-task-index="10">
                            <td class="day-cell" data-label="Day"><strong>Mon</strong></td>
                            <td class="mission-cell" data-label="Mission"><strong>Trigonometry SOP Reinforcement</strong></td>
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> <strong>Timed Re-do.</strong> Complete all high-mark and incorrect questions from <code>G3 EOY|Trigonometry Application in Context</code>.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="11">
                            <td class="day-cell" data-label="Day"><strong>Tue</strong></td>
                            <td class="mission-cell" data-label="Mission"><strong>Paper 1 Simulation</strong></td>
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> Complete a full 2023 Paper 1 under timed conditions.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="12">
                            <td class="day-cell" data-label="Day"><strong>Wed</strong></td>
                            <td class="mission-cell" data-label="Mission"><strong>Paper 1 Exam Day</strong></td>
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> Sit for the official exam.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="13">
                            <td class="day-cell" data-label="Day"><strong>Thu</strong></td>
                            <td class="mission-cell" data-label="Mission"><strong>Geometry & Quadratics SOP Reinforcement</strong></td>
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> <strong>Timed Re-do.</strong> Complete all incorrect questions from <code>G3 EOY|Geometric Proofs...</code> and <code>G3 EOY|Quadratic Functions...</code>.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="14">
                            <td class="day-cell" data-label="Day"><strong>Fri</strong></td>
                            <td class="mission-cell" data-label="Mission"><strong>Advanced Variation Training</strong></td>
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> Complete the new Variation Drills package.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="15">
                            <td class="day-cell" data-label="Day"><strong>Sat</strong></td>
                            <td class="mission-cell" data-label="Mission"><strong>Final Boss Timed Drill</strong></td>
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> Complete the Final Boss drill under timed conditions.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="16">
                            <td class="day-cell" data-label="Day"><strong>Sun</strong></td>
                            <td class="mission-cell" data-label="Mission"><strong>Weekly Review</strong></td>
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> <strong>Final update</strong> of your Competency Radar Chart. Acknowledge your strengths and final points to watch out for.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Week 3 -->
        <div class="week-section">
            <div class="week-header" onclick="toggleWeek(3)">
                <span>🚀 Week 3: Simulation & Mental Prep (Oct 6 - Oct 7)</span>
                <span class="expand-icon" id="icon-3">▼</span>
            </div>
            <div class="week-content" id="week-3">
                 <table class="task-table">
                    <thead>
                        <tr>
                            <th class="day-cell">Day</th>
                            <th class="mission-cell">Core Mission</th>
                            <th class="details-cell">Specific Asset/Practice List</th>
                            <th class="status-cell">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="task-row" data-task-index="17">
                            <td class="day-cell" data-label="Day"><strong>Mon</strong></td>
                            <td class="mission-cell" data-label="Mission"><strong>Paper 2 Simulation</strong></td>
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> Complete a full 2023 Paper 2 under timed conditions.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                        <tr class="task-row" data-task-index="18">
                            <td class="day-cell" data-label="Day"><strong>Tue</strong></td>
                            <td class="mission-cell" data-label="Mission"><strong>Paper 2 Exam Day</strong></td>
                            <td class="details-cell" data-label="Task">👨‍🎓 <strong>Task:</strong> Sit for the official exam.</td>
                            <td class="status-cell" data-label="Status"><div class="status-content"><input type="checkbox" class="task-checkbox"><div class="link-area"></div></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <button class="floating-action" onclick="resetProgress()" title="Reset Progress">
        🔄
    </button>
    
    <script>
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDdtQYfOC87IvpTZPFoDyb6ZgpEISzqw_I",
            authDomain: "emath-study-plan.firebaseapp.com",
            projectId: "emath-study-plan",
            storageBucket: "emath-study-plan.firebasestorage.app",
            messagingSenderId: "589299697460",
            appId: "1:589299697460:web:df1e0bb0586b3740c04761",
            measurementId: "G-09QVE4GLS0"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const docRef = db.collection("sprintPlan").doc("tasks_v4");

        // --- 2. LOCAL CONFIGURATION ---
        const paper1Date = new Date('2025-10-01');
        const paper2Date = new Date('2025-10-07');
        const MAX_LINKS_PER_TASK = 3;

        // --- 3. CORE DATA FUNCTIONS ---
        function getProgressData() {
            const savedData = sessionStorage.getItem('localDataCache');
            if (savedData) {
                try {
                    return JSON.parse(savedData);
                } catch(e) { /* Fallback */ }
            }
            const totalTasks = document.querySelectorAll('.task-row[data-task-index]').length;
            return Array(totalTasks).fill().map(() => ({ checked: false, links: [] }));
        }

        function saveProgressData(data) {
            sessionStorage.setItem('localDataCache', JSON.stringify(data));
            // --- DIAGNOSTIC ALERT 2 ---
            // alert("SAVING TO FIREBASE:\n" + JSON.stringify(data));
            docRef.set({ allTasks: data }).catch(error => {
                console.error("Error writing document to Firebase: ", error);
            });
        }

        // --- 4. UI RENDERING & EVENT HANDLING ---
        function renderLinksForTask(taskIndex, links) {
            const linkArea = document.querySelector(`.task-row[data-task-index="${taskIndex}"] .link-area`);
            if (!linkArea) return;
            linkArea.innerHTML = '';
            links.forEach((link, linkIndex) => {
                const pill = document.createElement('a');
                pill.className = 'link-pill';
                pill.textContent = `Link ${linkIndex + 1}`;
                pill.href = link;
                pill.dataset.linkIndex = linkIndex;
                linkArea.appendChild(pill);
            });
            if (links.length < MAX_LINKS_PER_TASK) {
                const addButton = document.createElement('button');
                addButton.className = 'add-link-btn';
                addButton.textContent = '➕ Add';
                linkArea.appendChild(addButton);
            }
        }

        function loadProgress(data) {
            const trackableRows = document.querySelectorAll('.task-row[data-task-index]');
            if (data && data.length > 0 && data.length !== trackableRows.length) {
                resetProgress(true);
                return;
            }
            trackableRows.forEach((row) => {
                const taskIndex = parseInt(row.dataset.taskIndex, 10);
                const taskData = data[taskIndex] || { checked: false, links: [] };
                const checkbox = row.querySelector('.task-checkbox');
                if (checkbox) checkbox.checked = taskData.checked;
                renderLinksForTask(taskIndex, taskData.links);
            });
            sessionStorage.setItem('localDataCache', JSON.stringify(data));
            updateOverallProgress();
        }

        function handleTableClick(event) {
            const target = event.target;
            const row = target.closest('.task-row[data-task-index]');
            if (!row) return;

            const taskIndex = parseInt(row.dataset.taskIndex, 10);
            let data = getProgressData();
            let taskData = data[taskIndex];

            if (target.matches('.task-checkbox')) {
                taskData.checked = target.checked;
                saveProgressData(data);
                return;
            }

            if (target.matches('.add-link-btn')) {
                const newLink = prompt("Enter the new link URL (e.g., a Google Doc):");
                if (newLink && newLink.trim() !== '') {
                    if (taskData.links.length < MAX_LINKS_PER_TASK) {
                        taskData.links.push(newLink.trim());
                        saveProgressData(data);
                    } else {
                        alert(`You can only add a maximum of ${MAX_LINKS_PER_TASK} links.`);
                    }
                }
                return;
            }

            if (target.matches('.link-pill')) {
                event.preventDefault();
                const linkIndex = parseInt(target.dataset.linkIndex, 10);
                const currentLink = taskData.links[linkIndex];
                
                const actionResult = prompt(`Link ${linkIndex + 1}:\n\n- To OPEN, click OK.\n- To EDIT, change the URL below.\n- To DELETE, clear the text and click OK.`, currentLink);

                // --- DIAGNOSTIC ALERT 1 ---
                alert("Dialog box returned this text:\n\n'" + actionResult + "'");

                if (actionResult === null) return;
                
                const newLinkValue = actionResult.trim();

                if (newLinkValue === '') {
                    taskData.links.splice(linkIndex, 1);
                } else {
                    taskData.links[linkIndex] = newLinkValue;
                    window.open(newLinkValue, '_blank');
                }
                saveProgressData(data);
            }
        }
        
        function listenForProgressChanges() {
            docRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data().allTasks || [];
                    // --- DIAGNOSTIC ALERT 3 ---
                    // alert("RECEIVED FROM FIREBASE:\n" + JSON.stringify(data));
                    loadProgress(data);
                } else {
                    const totalTasks = document.querySelectorAll('.task-row[data-task-index]').length;
                    const initialData = Array(totalTasks).fill().map(() => ({ checked: false, links: [] }));
                    saveProgressData(initialData);
                }
            }, (error) => {
                console.error("Error listening to Firebase:", error);
                alert("Could not connect to the cloud database. Check your connection and Firebase setup.");
            });
        }

        // --- UTILITY & UI FUNCTIONS ---
        function updateOverallProgress() {
            const checkableTasks = document.querySelectorAll('.task-checkbox');
            const totalTasks = checkableTasks.length;
            const completedTasks = document.querySelectorAll('.task-checkbox:checked').length;
            document.querySelectorAll('.task-row[data-task-index]').forEach(row => {
                 const checkbox = row.querySelector('.task-checkbox');
                 if (checkbox && checkbox.checked) {
                     row.classList.add('task-completed');
                 } else {
                     row.classList.remove('task-completed');
                 }
            });
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('completion-rate').textContent = `${completionRate}%`;
            document.getElementById('overall-progress').style.width = `${completionRate}%`;
        }
        
        function updateCountdown() {
            const now = new Date();
            const paper1Diff = paper1Date - now;
            const paper1Days = Math.ceil(paper1Diff / (1000 * 60 * 60 * 24));
            const paper2Diff = paper2Date - now;
            const paper2Days = Math.ceil(paper2Diff / (1000 * 60 * 60 * 24));
            document.getElementById('paper1-countdown').textContent = paper1Days > 0 ? `${paper1Days}` : 'Done';
            document.getElementById('paper2-countdown').textContent = paper2Days > 0 ? `${paper2Days}` : 'Done';
            const daysRemaining = Math.max(0, Math.min(paper1Days > 0 ? paper1Days : Infinity, paper2Days > 0 ? paper2Days : Infinity));
            document.getElementById('days-remaining').textContent = daysRemaining === Infinity ? '0' : daysRemaining;
        }

        function toggleWeek(weekNum) {
            const content = document.getElementById(`week-${weekNum}`);
            const icon = document.getElementById(`icon-${weekNum}`);
            content.classList.toggle('active');
            icon.classList.toggle('rotated');
        }

        function resetProgress(force = false) {
            if (force || confirm('Are you sure you want to reset all progress and links FOR EVERYONE? This will clear the cloud data.')) {
                const totalTasks = document.querySelectorAll('.task-row[data-task-index]').length;
                const initialData = Array(totalTasks).fill().map(() => ({ checked: false, links: [] }));
                saveProgressData(initialData);
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            updateCountdown();
            setInterval(updateCountdown, 60000);
            listenForProgressChanges();
            const container = document.querySelector('.container');
            if (container) container.addEventListener('click', handleTableClick);
            toggleWeek(1);
        });
    </script>
</body>
</html>
