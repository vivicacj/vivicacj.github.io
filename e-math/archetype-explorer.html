<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archetype Explorer | E-Math O-Level</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: slideIn 0.6s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            padding: 28px 36px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 32px;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header-left p {
            font-size: 14px;
            opacity: 0.8;
        }

        .manage-drills-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .manage-drills-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(245, 87, 108, 0.4);
        }

        .filter-bar {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            padding: 20px 36px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-label {
            color: #e2e8f0;
            font-weight: 600;
            font-size: 13px;
        }

        select {
            padding: 8px 14px;
            border: none;
            border-radius: 10px;
            background: white;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }

        .strand-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .strand-btn {
            padding: 8px 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            background: transparent;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .strand-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .strand-btn.active {
            background: white;
            color: #4a5568;
        }

        .view-toggle {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .view-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .view-btn.active {
            background: white;
            color: #4a5568;
        }

        .stats-bar {
            background: #f7fafc;
            padding: 14px 36px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e2e8f0;
        }

        .stats-item {
            font-size: 13px;
            color: #4a5568;
        }

        .stats-item strong {
            color: #667eea;
            font-size: 20px;
        }

        .main-content {
            display: flex;
            min-height: 700px;
        }

        .archetype-grid {
            flex: 1;
            padding: 32px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            max-height: 800px;
            overflow-y: auto;
            background: #f7fafc;
        }

        .archetype-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .archetype-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .archetype-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%);
        }

        .card-header {
            margin-bottom: 12px;
        }

        .archetype-name {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .card-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .grade-tag {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 10px;
            font-weight: 700;
            border: 2px solid;
        }

        .grade-tag.G3 {
            background: #fff5f5;
            color: #e53e3e;
            border-color: #fc8181;
        }

        .grade-tag.G4 {
            background: #f0fff4;
            color: #38a169;
            border-color: #68d391;
        }

        .archetype-badge {
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 700;
            color: white;
        }

        .archetype-badge.CORE {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .archetype-badge.SAT {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .card-description {
            font-size: 14px;
            color: #718096;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .card-concepts {
            background: #f7fafc;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .concepts-title {
            font-size: 11px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .concepts-list {
            font-size: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .concept-tag {
            background: white;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            color: #4a5568;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .view-sop-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .view-sop-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 14px rgba(102, 126, 234, 0.4);
        }

        .view-drills-btn {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .view-drills-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 14px rgba(250, 112, 154, 0.4);
        }

        .content-panel {
            width: 480px;
            background: white;
            border-left: 2px solid #e2e8f0;
            padding: 32px;
            overflow-y: auto;
            transition: all 0.4s;
        }

        .content-panel.hidden {
            width: 0;
            padding: 0;
            opacity: 0;
        }

        .panel-welcome {
            text-align: center;
            color: #a0aec0;
            padding: 100px 20px;
        }

        .panel-welcome h3 {
            font-size: 24px;
            margin: 20px 0 12px;
            color: #4a5568;
        }

        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 24px;
        }

        .panel-header h2 {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .panel-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .panel-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: #718096;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .panel-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 16px;
        }

        .sop-steps {
            background: #f7fafc;
            border-radius: 14px;
            padding: 20px;
        }

        .sop-step {
            margin-bottom: 18px;
            padding-bottom: 18px;
            border-bottom: 1px solid #e2e8f0;
        }

        .sop-step:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .step-title {
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .step-content {
            font-size: 13px;
            color: #4a5568;
            line-height: 1.7;
        }

        .pitfalls-section, .tips-section {
            margin-top: 20px;
        }

        .pitfall-item, .tip-item {
            background: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }

        .pitfall-item {
            border-color: #f56565;
            background: #fff5f5;
        }

        .tip-item {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .pitfall-type, .tip-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .pitfall-type {
            color: #f56565;
        }

        .tip-label {
            color: #48bb78;
        }

        .drill-link-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
            color: inherit;
        }

        .drill-link-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateX(4px);
        }

        .drill-platform-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .drill-platform-icon.google {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
        }

        .drill-platform-icon.notion {
            background: linear-gradient(135deg, #000000 0%, #2d2d2d 100%);
        }

        .drill-link-content {
            flex: 1;
        }

        .drill-link-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .drill-link-desc {
            font-size: 12px;
            color: #718096;
        }

        .external-link-icon {
            font-size: 20px;
            color: #a0aec0;
        }

        .no-drills-message {
            text-align: center;
            padding: 40px 20px;
            color: #a0aec0;
        }

        .add-drill-btn {
            margin-top: 16px;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .loading-sop {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #2d3748;
        }

        .modal-close {
            font-size: 28px;
            cursor: pointer;
            color: #a0aec0;
            background: none;
            border: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-cancel {
            padding: 12px 24px;
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-submit {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .error-message {
            background: #fff5f5;
            border: 2px solid #fc8181;
            border-radius: 12px;
            padding: 20px;
            margin: 20px;
            color: #c53030;
        }

        .error-message h3 {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>Loading Archetypes...</h2>
            <p id="loadingStatus">Initializing...</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>🗺️ Archetype Explorer</h1>
                <p>O-Level E-Math • Problem Pattern Library</p>
            </div>
            <button class="manage-drills-btn" onclick="openDrillManager()">
                ⚙️ Manage Drill Links
            </button>
        </div>

        <div class="filter-bar">
            <div class="filter-group">
                <span class="filter-label">Grade:</span>
                <select id="gradeSelect">
                    <option value="all">All Grades</option>
                    <option value="G3" selected>G3 Only</option>
                    <option value="G4">G4 Only</option>
                </select>
            </div>

            <div class="filter-group">
                <span class="filter-label">Category:</span>
                <select id="categorySelect">
                    <option value="all">All Categories</option>
                    <option value="CORE">Core Topics Only</option>
                    <option value="SAT">Satellite Topics Only</option>
                </select>
            </div>

            <div class="filter-group">
                <span class="filter-label">Topic:</span>
                <div class="strand-buttons">
                    <button class="strand-btn active" data-topic="all">All</button>
                    <button class="strand-btn" data-topic="trigonometry">Trigonometry</button>
                    <button class="strand-btn" data-topic="algebra">Algebra</button>
                    <button class="strand-btn" data-topic="geometry">Geometry</button>
                    <button class="strand-btn" data-topic="numbers">Numbers</button>
                    <button class="strand-btn" data-topic="mensuration">Mensuration</button>
                    <button class="strand-btn" data-topic="statistics">Statistics</button>
                </div>
            </div>

            <div class="view-toggle">
                <button class="view-btn active" data-view="grid">⊞</button>
                <button class="view-btn" data-view="list">☰</button>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stats-item">
                <strong id="displayCount">0</strong> archetypes displayed
            </div>
            <div class="stats-item">
                <span style="color: #e53e3e;">●</span> G3: <strong id="g3Count">0</strong> | 
                <span style="color: #38a169;">●</span> G4: <strong id="g4Count">0</strong>
            </div>
            <div class="stats-item">
                <span style="color: #f5576c;">●</span> CORE: <strong id="coreCount">0</strong> | 
                <span style="color: #00f2fe;">●</span> SAT: <strong id="satCount">0</strong>
            </div>
        </div>

        <div class="main-content">
            <div class="archetype-grid" id="archetypeGrid"></div>

            <div class="content-panel hidden" id="contentPanel">
                <div class="panel-welcome">
                    <div style="font-size:72px">🎯</div>
                    <h3>Welcome!</h3>
                    <p>Select any archetype to view its SOP and practice drills</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="drillModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Drill Link</h2>
                <button class="modal-close" onclick="closeDrillManager()">×</button>
            </div>
            <form id="drillForm">
                <div class="form-group">
                    <label>Archetype</label>
                    <select id="drillArchetype" required></select>
                </div>
                <div class="form-group">
                    <label>Drill Name</label>
                    <input type="text" id="drillName" placeholder="e.g., Bearing Problems - Prototype Set" required>
                </div>
                <div class="form-group">
                    <label>Platform</label>
                    <select id="drillPlatform" required>
                        <option value="google">Google Drive</option>
                        <option value="notion">Notion</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>URL</label>
                    <input type="url" id="drillUrl" placeholder="https://..." required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="drillDescription" rows="3" placeholder="Brief description"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeDrillManager()">Cancel</button>
                    <button type="submit" class="btn-submit">Add Drill</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global state
        let ARCHETYPES = [];
        let ARCHETYPE_CONFIG = null;
        let LOADED_GRADES = {};
        let drillLinks = JSON.parse(localStorage.getItem('drillLinks') || '{}');
        let currentFilter = {grade: 'G3', category: 'all', topic: 'all', view: 'grid'};
        let selectedArchetype = null;
        let sopCache = {};

        // Update loading status
        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loadingStatus');
            if (statusEl) {
                statusEl.textContent = message;
            }
            console.log(`📊 ${message}`);
        }

        // Load configuration file
        async function loadConfig() {
            try {
                updateLoadingStatus('Loading configuration...');
                const response = await fetch('./data/archetypes/archetypes-config.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                ARCHETYPE_CONFIG = await response.json();
                console.log(`✅ Loaded config v${ARCHETYPE_CONFIG.version}`);
                updateLoadingStatus(`Config v${ARCHETYPE_CONFIG.version} loaded`);
                return true;
            } catch (error) {
                console.error('❌ Failed to load config:', error);
                updateLoadingStatus('Config load failed');
                return false;
            }
        }

        // Load archetypes for a specific grade
        async function loadGradeData(grade) {
            if (LOADED_GRADES[grade]) {
                console.log(`✅ Using cached data for ${grade}`);
                return LOADED_GRADES[grade];
            }

            if (!ARCHETYPE_CONFIG || !ARCHETYPE_CONFIG.data_sources || !ARCHETYPE_CONFIG.data_sources[grade]) {
                console.warn(`⚠️ Grade ${grade} not configured`);
                return [];
            }

            const gradeConfig = ARCHETYPE_CONFIG.data_sources[grade];
            if (!gradeConfig.enabled) {
                console.warn(`⚠️ Grade ${grade} is disabled`);
                return [];
            }

            try {
                const filename = gradeConfig.file;
                updateLoadingStatus(`Loading ${grade} data...`);
                
                const response = await fetch(`./data/archetypes/${filename}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                let data = await response.json();
                
                // Handle the data structure - the file might have archetypes directly or nested
                let archetypes = [];
                if (Array.isArray(data)) {
                    archetypes = data;
                } else if (data.archetypes && Array.isArray(data.archetypes)) {
                    archetypes = data.archetypes;
                } else {
                    console.error('Unexpected data structure:', data);
                    return [];
                }
                
                console.log(`✅ Loaded ${archetypes.length} archetypes for ${grade}`);
                updateLoadingStatus(`${archetypes.length} ${grade} archetypes loaded`);
                
                LOADED_GRADES[grade] = archetypes;
                return archetypes;
            } catch (error) {
                console.error(`❌ Failed to load ${grade} data:`, error);
                updateLoadingStatus(`Failed to load ${grade} data`);
                return [];
            }
        }

        // Initialize and load default grade
        async function init() {
            try {
                const configLoaded = await loadConfig();
                if (!configLoaded) {
                    showError('Failed to load configuration file. Please check that data/archetypes/archetypes-config.json exists.');
                    return;
                }

                // Load default grade data
                const defaultGrade = ARCHETYPE_CONFIG.default_grade || 'G3';
                ARCHETYPES = await loadGradeData(defaultGrade);
                
                if (ARCHETYPES.length === 0) {
                    showError(`No archetypes loaded for ${defaultGrade}. Please check that data files exist.`);
                    return;
                }
                
                // Hide loading screen
                document.getElementById('loadingScreen').style.display = 'none';
                
                renderArchetypes();
                updateStats();
                setupEventListeners();
                
                console.log(`✅ Initialization complete - ${ARCHETYPES.length} archetypes loaded`);
            } catch (error) {
                console.error('❌ Initialization failed:', error);
                showError(`Initialization failed: ${error.message}`);
            }
        }

        // Show error message
        function showError(message) {
            document.getElementById('loadingScreen').style.display = 'none';
            const grid = document.getElementById('archetypeGrid');
            grid.innerHTML = `
                <div class="error-message" style="grid-column: 1/-1;">
                    <h3>⚠️ Error Loading Data</h3>
                    <p>${message}</p>
                    <p style="margin-top: 10px; font-size: 14px;">
                        Expected file structure:<br>
                        <code>data/archetypes/archetypes-config.json</code><br>
                        <code>data/archetypes/archetypes-g3.json</code><br>
                        <code>data/archetypes/archetypes-g4.json</code>
                    </p>
                </div>
            `;
        }

        // Update statistics display
        function updateStats() {
            let g3Count = 0, g4Count = 0, coreCount = 0, satCount = 0;
            
            if (ARCHETYPE_CONFIG && ARCHETYPE_CONFIG.data_sources) {
                if (LOADED_GRADES['G3']) {
                    g3Count = LOADED_GRADES['G3'].length;
                } else if (ARCHETYPE_CONFIG.data_sources['G3']) {
                    g3Count = ARCHETYPE_CONFIG.data_sources['G3'].total_archetypes;
                }

                if (LOADED_GRADES['G4']) {
                    g4Count = LOADED_GRADES['G4'].length;
                } else if (ARCHETYPE_CONFIG.data_sources['G4']) {
                    g4Count = ARCHETYPE_CONFIG.data_sources['G4'].total_archetypes;
                }
            } else {
                g3Count = ARCHETYPES.filter(a => a.grade === 'G3').length;
                g4Count = ARCHETYPES.filter(a => a.grade === 'G4').length;
            }

            coreCount = ARCHETYPES.filter(a => a.badge === 'CORE').length;
            satCount = ARCHETYPES.filter(a => a.badge === 'SAT').length;

            document.getElementById('g3Count').textContent = g3Count;
            document.getElementById('g4Count').textContent = g4Count;
            document.getElementById('coreCount').textContent = coreCount;
            document.getElementById('satCount').textContent = satCount;
        }

        function renderArchetypes() {
            const grid = document.getElementById('archetypeGrid');
            const filtered = ARCHETYPES.filter(arch => {
                const gradeMatch = currentFilter.grade === 'all' || arch.grade === currentFilter.grade;
                const categoryMatch = currentFilter.category === 'all' || arch.badge === currentFilter.category;
                const topicMatch = currentFilter.topic === 'all' || arch.topic === currentFilter.topic;
                return gradeMatch && categoryMatch && topicMatch;
            });

            document.getElementById('displayCount').textContent = filtered.length;

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align:center; padding:60px 20px; color:#a0aec0;">
                        <p style="font-size:48px; margin-bottom:16px;">🔍</p>
                        <p style="font-size:18px; font-weight:600;">No archetypes match your filters</p>
                        <p style="font-size:14px; margin-top:12px;">Try adjusting your filter selection</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(arch => {
                const concepts = arch.key_concepts || arch.concepts || [];
                return `
                    <div class="archetype-card" data-id="${arch.id}">
                        <div class="card-header">
                            <div class="archetype-name">${arch.name}</div>
                            <div class="card-badges">
                                <span class="grade-tag ${arch.grade}">${arch.grade}</span>
                                <span class="archetype-badge ${arch.badge}">${arch.badge}</span>
                            </div>
                        </div>
                        <p class="card-description">${arch.description}</p>
                        <div class="card-concepts">
                            <div class="concepts-title">Key Concepts</div>
                            <div class="concepts-list">
                                ${concepts.map(c => `<span class="concept-tag">${c}</span>`).join('')}
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="action-btn view-sop-btn" onclick="viewSOP('${arch.id}')">📋 View SOP</button>
                            <button class="action-btn view-drills-btn" onclick="viewDrills('${arch.id}')">🎯 Drills</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadSOP(archId) {
            const arch = ARCHETYPES.find(a => a.id === archId);
            if (!arch) return null;

            if (arch.sop) {
                return arch.sop;
            }

            if (!arch.sop_reference || arch.sop_reference.index === null) {
                return null;
            }

            const cacheKey = `${arch.sop_reference.file}-${arch.sop_reference.index}`;
            if (sopCache[cacheKey]) return sopCache[cacheKey];

            try {
                const response = await fetch(`./data/topics/${arch.sop_reference.file}`);
                if (!response.ok) throw new Error('File not found');
                const data = await response.json();
                const sop = data.sops[arch.sop_reference.index];
                sopCache[cacheKey] = sop;
                return sop;
            } catch (error) {
                console.error(`Failed to load SOP for ${archId}:`, error);
                return null;
            }
        }

        async function viewSOP(archId) {
            selectedArchetype = archId;
            const arch = ARCHETYPES.find(a => a.id === archId);
            const panel = document.getElementById('contentPanel');
            
            document.querySelectorAll('.archetype-card').forEach(card => {
                card.classList.remove('selected');
                if (card.dataset.id === archId) {
                    card.classList.add('selected');
                    card.scrollIntoView({behavior: 'smooth', block: 'nearest'});
                }
            });

            panel.classList.remove('hidden');
            panel.innerHTML = `
                <div class="panel-content">
                    <div class="panel-header">
                        <h2>${arch.name}</h2>
                        <p>${arch.grade} • ${arch.badge}</p>
                    </div>
                    <div class="panel-tabs">
                        <button class="panel-tab active" onclick="switchTab('sop')">📋 SOP</button>
                        <button class="panel-tab" onclick="switchTab('drills')">🎯 Drills</button>
                    </div>
                    <div class="loading-sop"><p>⏳ Loading SOP...</p></div>
                </div>
            `;

            const sop = await loadSOP(archId);

            if (!sop) {
                panel.innerHTML = `
                    <div class="panel-content">
                        <div class="panel-header"><h2>${arch.name}</h2><p>${arch.grade} • ${arch.badge}</p></div>
                        <div class="panel-tabs">
                            <button class="panel-tab active" onclick="switchTab('sop')">📋 SOP</button>
                            <button class="panel-tab" onclick="switchTab('drills')">🎯 Drills</button>
                        </div>
                        <div class="tab-content active" id="sopTab">
                            <div class="no-drills-message">
                                <p>📝</p>
                                <p>SOP not available yet</p>
                                <p style="font-size:12px; margin-top:10px;">Check data/topics/${arch.sop_reference?.file || 'unknown'}</p>
                            </div>
                        </div>
                        <div class="tab-content" id="drillsTab">${renderDrillsContent(archId)}</div>
                    </div>
                `;
                return;
            }

            panel.innerHTML = `
                <div class="panel-content">
                    <div class="panel-header"><h2>${arch.name}</h2><p>${arch.grade} • ${arch.badge}</p></div>
                    <div class="panel-tabs">
                        <button class="panel-tab active" onclick="switchTab('sop')">📋 SOP</button>
                        <button class="panel-tab" onclick="switchTab('drills')">🎯 Drills</button>
                    </div>
                    <div class="tab-content active" id="sopTab">
                        <div class="section-title">🎯 Goal</div>
                        <p style="color:#4a5568;margin-bottom:20px;line-height:1.6;">${sop.goal}</p>
                        <div class="section-title">📝 Steps</div>
                        <div class="sop-steps">
                            ${sop.steps.map((step, i) => `
                                <div class="sop-step">
                                    <div class="step-title">STEP ${i + 1}</div>
                                    <div class="step-content">${step}</div>
                                </div>
                            `).join('')}
                        </div>
                        ${sop.pitfalls && sop.pitfalls.length > 0 ? `
                            <div class="pitfalls-section">
                                <div class="section-title">⚠️ Common Pitfalls</div>
                                ${sop.pitfalls.map(p => `
                                    <div class="pitfall-item">
                                        <div class="pitfall-type">${p.type}</div>
                                        <div style="font-size:13px;color:#2d3748;">${p.text}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${sop.pro_tips && sop.pro_tips.length > 0 ? `
                            <div class="tips-section">
                                <div class="section-title">💡 Pro Tips</div>
                                ${sop.pro_tips.map(tip => `
                                    <div class="tip-item">
                                        <div class="tip-label">PRO TIP</div>
                                        <div style="font-size:13px;color:#2d3748;">${tip}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div class="tab-content" id="drillsTab">${renderDrillsContent(archId)}</div>
                </div>
            `;
        }

        function viewDrills(archId) {
            viewSOP(archId);
            setTimeout(() => switchTab('drills'), 100);
        }

        function switchTab(tab) {
            document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'sop') {
                document.querySelectorAll('.panel-tab')[0].classList.add('active');
                document.getElementById('sopTab').classList.add('active');
            } else {
                document.querySelectorAll('.panel-tab')[1].classList.add('active');
                document.getElementById('drillsTab').classList.add('active');
            }
        }

        function renderDrillsContent(archId) {
            const drills = drillLinks[archId] || [];
            
            if (drills.length === 0) {
                return `
                    <div class="no-drills-message">
                        <p>📚</p><p>No practice drills added yet</p>
                        <button class="add-drill-btn" onclick="openDrillManager('${archId}')">➕ Add First Drill</button>
                    </div>
                `;
            }

            return `
                <div class="section-title">🎯 Practice Drills</div>
                ${drills.map(drill => `
                    <a href="${drill.url}" target="_blank" rel="noopener noreferrer" class="drill-link-item">
                        <div class="drill-platform-icon ${drill.platform}">${drill.platform === 'google' ? '📁' : '📝'}</div>
                        <div class="drill-link-content">
                            <div class="drill-link-title">${drill.name}</div>
                            <div class="drill-link-desc">${drill.description || 'Practice exercises'}</div>
                        </div>
                        <div class="external-link-icon">↗</div>
                    </a>
                `).join('')}
                <button class="add-drill-btn" onclick="openDrillManager('${archId}')" style="width:100%;">➕ Add More Drills</button>
            `;
        }

        function openDrillManager(archId = null) {
            const modal = document.getElementById('drillModal');
            const select = document.getElementById('drillArchetype');
            
            select.innerHTML = ARCHETYPES.map(arch => 
                `<option value="${arch.id}" ${arch.id === archId ? 'selected' : ''}>${arch.name} (${arch.grade} • ${arch.badge})</option>`
            ).join('');

            modal.classList.add('active');
            document.getElementById('drillForm').reset();
            if (archId) {
                document.getElementById('drillArchetype').value = archId;
            }
        }

        function closeDrillManager() {
            document.getElementById('drillModal').classList.remove('active');
        }

        document.getElementById('drillForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const archId = document.getElementById('drillArchetype').value;
            const drill = {
                name: document.getElementById('drillName').value,
                platform: document.getElementById('drillPlatform').value,
                url: document.getElementById('drillUrl').value,
                description: document.getElementById('drillDescription').value
            };

            if (!drillLinks[archId]) drillLinks[archId] = [];
            drillLinks[archId].push(drill);
            
            localStorage.setItem('drillLinks', JSON.stringify(drillLinks));
            closeDrillManager();
            
            if (selectedArchetype === archId) viewDrills(archId);

            alert('✅ Drill link added successfully!');
        });

        async function setupEventListeners() {
            document.getElementById('gradeSelect').addEventListener('change', async (e) => {
                const newGrade = e.target.value;
                currentFilter.grade = newGrade;
                
                if (newGrade === 'all') {
                    const allArchetypes = [];
                    if (ARCHETYPE_CONFIG && ARCHETYPE_CONFIG.available_grades) {
                        for (const grade of ARCHETYPE_CONFIG.available_grades) {
                            const gradeData = await loadGradeData(grade);
                            allArchetypes.push(...gradeData);
                        }
                        ARCHETYPES = allArchetypes;
                    }
                } else {
                    ARCHETYPES = await loadGradeData(newGrade);
                }
                
                renderArchetypes();
                updateStats();
            });

            document.getElementById('categorySelect').addEventListener('change', (e) => {
                currentFilter.category = e.target.value;
                renderArchetypes();
            });

            document.querySelectorAll('.strand-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.strand-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilter.topic = e.target.dataset.topic;
                    renderArchetypes();
                });
            });

            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilter.view = e.target.dataset.view;
                });
            });

            document.getElementById('drillModal').addEventListener('click', (e) => {
                if (e.target.id === 'drillModal') closeDrillManager();
            });
        }

        // Start initialization
        init();
    </script>
</body>
</html>
