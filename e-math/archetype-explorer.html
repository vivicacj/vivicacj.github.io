<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOP Relationship Map</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            animation: fadeIn 0.6s ease-out;
        }

        .header h1 {
            font-size: 48px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 18px;
            color: #a0aec0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            max-width: 1100px;
            margin: 40px auto;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideUp 0.6s ease-out forwards;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.1);
            border-color: #667eea;
        }

        .stat-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 40px;
            font-weight: 700;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 14px;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 8px;
        }
        
        .controls-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 100;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-btn, select, #searchBox {
            padding: 10px 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            outline: none;
        }
        
        #searchBox {
            -webkit-appearance: none;
            min-width: 450px;
        }
        
        #searchBox::placeholder {
            color: #a0aec0;
            opacity: 0.7;
            font-weight: 500;
        }
        
        #searchBox.highlight-search {
            border-color: #48bb78;
            background: rgba(72, 187, 120, 0.15);
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.2);
        }
        
        .search-results-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 30, 50, 0.98);
            border: 2px solid rgba(102, 126, 234, 0.5);
            border-radius: 12px;
            margin-top: 8px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 9999;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            display: none;
        }
        
        .search-results-dropdown.show {
            display: block;
        }
        
        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .search-result-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-id {
            font-size: 11px;
            color: #a0aec0;
            font-family: 'Courier New', monospace;
        }
        
        .search-result-name {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            margin: 4px 0;
        }
        
        .search-result-desc {
            font-size: 12px;
            color: #cbd5e0;
            line-height: 1.4;
        }
        
        .search-result-meta {
            display: flex;
            gap: 8px;
            margin-top: 6px;
        }
        
        .search-result-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 8px;
            font-weight: 700;
        }
        
        .search-wrapper {
            position: relative;
            flex-grow: 1;
            max-width: 600px;
            z-index: 10000;
        }
        
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-right: 35px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='white' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }
        
        select option {
            background: #2d3748;
            color: white;
        }

        .control-btn:hover, select:hover, #searchBox:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        #searchBox:focus {
            border-color: #667eea;
        }

        .control-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }

        .reset-btn {
            padding: 10px 20px;
            border: 2px solid rgba(255, 87, 108, 0.5);
            border-radius: 20px;
            background: rgba(255, 87, 108, 0.2);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
        }

        .reset-btn.visible { display: inline-block; }
        .reset-btn:hover { background: rgba(255, 87, 108, 0.4); transform: translateY(-2px); }

        .map-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            padding: 40px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: auto;
        }
        
        #connection-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        #connection-lines path {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: draw-line 0.8s ease-out forwards;
        }

        @keyframes draw-line { to { stroke-dashoffset: 0; } }

        .level-section { margin-bottom: 60px; animation: slideUp 0.6s ease-out; transition: opacity 0.3s; }
        .level-section:last-child { margin-bottom: 0; }
        .level-header { display: flex; align-items: center; gap: 16px; margin-bottom: 30px; }
        .level-badge { padding: 8px 20px; border-radius: 20px; font-size: 16px; font-weight: 800; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .level-badge.L1 { background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); }
        .level-badge.L2 { background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%); }
        .level-badge.L3 { background: linear-gradient(135deg, #cb2d3e 0%, #ef473a 100%); }
        .level-title { font-size: 28px; font-weight: 700; }
        .level-desc { color: #a0aec0; font-size: 14px; margin-left: auto; }
        .nodes-container { display: flex; flex-wrap: wrap; gap: 20px; min-height: 150px; }

        .node {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            width: 300px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
        }

        .node-content {
            flex-grow: 1;
        }

        .node:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4); border-color: #667eea; background: rgba(102, 126, 234, 0.2); }
        .node.dimmed { opacity: 0.25; filter: grayscale(0.5); }
        .node.highlighted { border-color: #f093fb; background: rgba(240, 147, 251, 0.2); box-shadow: 0 8px 24px rgba(240, 147, 251, 0.5); transform: scale(1.02); z-index: 10; }
        .node.in-chain { border-color: #667eea; background: rgba(102, 126, 234, 0.25); box-shadow: 0 8px 24px rgba(102, 126, 234, 0.6); transform: translateY(-2px); z-index: 5; }
        .node.search-match { 
            border-color: #48bb78; 
            background: rgba(72, 187, 120, 0.2); 
            box-shadow: 0 8px 24px rgba(72, 187, 120, 0.5);
            animation: pulse-match 1.5s ease-in-out;
        }
        
        @keyframes pulse-match {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .node-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .node-name { font-size: 16px; font-weight: 700; color: #fff; margin-right: 10px; }
        .node-badges { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; }
        .grade-tag, .archetype-badge { font-size: 10px; padding: 3px 8px; border-radius: 8px; font-weight: 700; }
        .grade-tag { border: 1px solid; }
        .grade-tag.G3 { background: #fff5f5; color: #e53e3e; border-color: #fc8181; }
        .grade-tag.G4 { background: #f0fff4; color: #38a169; border-color: #68d391; }
        .archetype-badge.CORE { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .archetype-badge.SAT { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .node-topic { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: rgba(255, 255, 255, 0.2); margin-bottom: 12px; }
        .node-desc { font-size: 13px; color: #cbd5e0; line-height: 1.5; margin-bottom: 12px; }
        .node-connections { margin-top: auto; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .connection-label { font-size: 11px; color: #a0aec0; font-weight: 600; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center;}
        .connection-links { display: flex; flex-wrap: wrap; gap: 6px; }
        .connection-link { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 600; background: rgba(102, 126, 234, 0.3); border: 1px solid rgba(102, 126, 234, 0.5); cursor: pointer; transition: all 0.2s; }
        .connection-link:hover { background: rgba(102, 126, 234, 0.5); transform: scale(1.05); }
        .connection-link.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5); }
        .visualize-btn { background: none; border: none; color: #a0aec0; font-size: 11px; font-weight: 600; cursor: pointer; transition: color .3s; padding: 4px 8px; border-radius: 6px; }
        .visualize-btn:hover { color: white; background: rgba(255,255,255,0.1); }
        
        .info-panel { position: fixed; top: 50%; right: 20px; transform: translate(calc(100% + 20px), -50%); width: 400px; background: rgba(255, 255, 255, 0.98); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); color: #2d3748; max-height: 90vh; overflow-y: auto; transition: transform 0.4s ease-in-out; z-index: 1000; backdrop-filter: blur(10px); }
        .info-panel.visible { transform: translate(0, -50%); }
        .info-panel .panel-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .info-panel .panel-header h2 { font-size: 20px; margin-bottom: 4px;}
        .info-panel .close-btn { position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; border-radius: 50%; background: #e2e8f0; border: none; cursor: pointer; font-size: 20px; line-height: 1; color: #4a5568; }
        .sop-step { background: #f7fafc; border-radius: 10px; padding: 12px; margin-bottom: 10px; border-left: 4px solid #667eea; }
        .sop-step-interactive { background: #f0f5ff; border-left: 4px solid #818cf8; cursor: pointer; transition: background-color 0.2s; }
        .sop-step-interactive:hover { background: #e0e7ff; }
        .sop-link { font-weight: bold; color: #667eea; text-decoration: underline; cursor: pointer; }
        .section-title { font-size: 16px; font-weight: 700; color: #2d3748; margin: 20px 0 16px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0; }
        .panel-tabs { display: flex; border-bottom: 1px solid #e2e8f0; margin-bottom: 20px;}
        .panel-tab { padding: 10px 16px; cursor: pointer; color: #718096; font-weight: 600; border-bottom: 3px solid transparent; background: none; border-top: none; border-left: none; border-right: none; font-family: inherit; font-size: inherit; }
        .panel-tab.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .no-drills-message { text-align: center; padding: 40px 20px; color: #a0aec0; }
        .no-drills-message p:first-child { font-size: 48px; margin-bottom: 16px; }
        .add-drill-btn { padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 10px; color: white; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s; margin-top: 16px; }
        .add-drill-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 14px rgba(102, 126, 234, 0.4); }
        .drill-link-item { display: flex; align-items: center; gap: 12px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px 16px; margin-bottom: 8px; text-decoration: none; color: #2d3748; transition: all 0.3s; }
        .drill-link-item:hover { border-color: #667eea; background: #f0f4ff; transform: translateX(4px); }
        .drill-platform-icon { font-size: 24px; }
        .drill-link-content { flex: 1; }
        .drill-link-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .drill-link-desc { font-size: 12px; color: #718096; }
        .external-link-icon { font-size: 18px; color: #a0aec0; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: #fefefe; padding: 32px; border-radius: 20px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; color: #333; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-header h2 { font-size: 24px; color: #2d3748; }
        .modal-close { font-size: 28px; cursor: pointer; color: #a0aec0; background: none; border: none; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; color: #4a5568; margin-bottom: 8px; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; }
        .form-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
        .btn-cancel { padding: 12px 24px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .btn-submit { padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .pitfall-item, .tip-item { background: white; padding: 14px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid; }
        .pitfall-item { border-color: #f56565; background: #fff5f5; }
        .tip-item { border-color: #48bb78; background: #f0fff4; }
        .pitfall-type { font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; color: #c53030; }


        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è SOP Relationship Map</h1>
            <p>O-Level E-Math Learning Pathway</p>
        </div>

        <div class="stats-grid" id="stats-grid-container">
            <!-- Stats will be rendered here by JS -->
        </div>

        <div class="controls-container">
            <div class="controls">
                <div class="search-wrapper">
                    <input type="search" id="searchBox" placeholder="üîé Search by ID, Name, or Topic..." autocomplete="off">
                    <div class="search-results-dropdown" id="searchDropdown"></div>
                </div>
                <select id="topicSelect"></select>
                <select id="gradeSelect">
                    <option value="all">All Grades</option>
                    <option value="G3">G3</option>
                    <option value="G4">G4</option>
                </select>
                <select id="categorySelect">
                    <option value="all">All Categories</option>
                    <option value="CORE">CORE</option>
                    <option value="SAT">SAT</option>
                </select>
                 <button class="control-btn" onclick="openDrillManager()">‚öôÔ∏è Manage Drills</button>
                <button class="reset-btn" id="resetBtn" onclick="resetHighlight()">üîÑ Reset View</button>
            </div>
        </div>

        <div class="map-container" id="mapContainer">
            <svg id="connection-lines"></svg>
            <div id="nodes-wrapper">
                <!-- Content will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <div class="info-panel" id="infoPanel">
        <button class="close-btn" onclick="closeInfoPanel()">√ó</button>
        <div id="infoPanelContent"></div>
    </div>

    <div id="drillModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Drill Link</h2>
                <button class="modal-close" onclick="closeDrillManager()">&times;</button>
            </div>
            <form id="drillForm">
                <div class="form-group">
                    <label>Archetype</label>
                    <select id="drillArchetype" required></select>
                </div>
                <div class="form-group">
                    <label>Drill Name</label>
                    <input type="text" id="drillName" placeholder="e.g., Bearing Problems - Set A" required>
                </div>
                <div class="form-group">
                    <label>Platform</label>
                    <select id="drillPlatform" required>
                        <option value="google">Google Drive</option>
                        <option value="notion">Notion</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>URL</label>
                    <input type="url" id="drillUrl" placeholder="https://..." required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="drillDescription" rows="2" placeholder="Brief description of the drill set"></textarea>
                </div>
                 <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeDrillManager()">Cancel</button>
                    <button type="submit" class="btn-submit">Add Drill</button>
                </div>
            </form>
        </div>
    </div>

    <!-- External Data Source -->
    <script src="archetypes-l123-data.js"></script>
    
    <script>
        // Global state - declared in the script's top scope
        let drillLinks = {};
        let currentFilters = { search: '', topic: 'all', grade: 'all', category: 'all' };
        let selectedNodeId = null;
        let highlightedChain = [];
        let searchTimeout = null;

        // Wait for both DOM and external script to load
        window.addEventListener('load', () => {
            // Check if data is loaded
            if (typeof ARCHETYPES_DATA === 'undefined') {
                console.error('ARCHETYPES_DATA not loaded!');
                document.getElementById('nodes-wrapper').innerHTML = 
                    '<p style="text-align:center; width: 100%; color: #ff6b6b; padding: 40px;">Error: Data file not loaded. Please ensure archetypes-l123-data.js is in the same directory.</p>';
                return;
            }
            
            console.log('‚úÖ Data loaded:', ARCHETYPES_DATA.length, 'archetypes');
            
            // Initialization logic
            loadDrillLinks();
            renderStats();
            populateTopicFilter();
            renderMap();
            setupEventListeners();
        });

        function renderStats() {
            const container = document.getElementById('stats-grid-container');
            if (!container || typeof ARCHETYPES_DATA === 'undefined') return;

            // --- FIX: Filter for parent archetypes only ---
            const parentArchetypes = ARCHETYPES_DATA.filter(a => !a.parent_id);

            const stats = {
                topics: new Set(parentArchetypes.map(a => a.topic)).size,
                archetypes: parentArchetypes.length, // Count only parents
                levels: new Set(parentArchetypes.map(a => a.level)).size // Count levels from parents
            };

            container.innerHTML = `
                <div class="stat-card" style="animation-delay: 0.1s;">
                    <div class="stat-icon">üìö</div>
                    <div class="stat-value">${stats.topics}</div>
                    <div class="stat-label">Topics</div>
                </div>
                <div class="stat-card" style="animation-delay: 0.2s;">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-value">${stats.archetypes}</div>
                    <div class="stat-label">Archetypes</div>
                </div>
                <div class="stat-card" style="animation-delay: 0.3s;">
                    <div class="stat-icon">üì∂</div>
                    <div class="stat-value">${stats.levels}</div>
                    <div class="stat-label">Levels</div>
                </div>
                <div class="stat-card" style="animation-delay: 0.4s;">
                    <div class="stat-icon">üîó</div>
                    <div class="stat-value">‚àû</div>
                    <div class="stat-label">SOP Chains</div>
                </div>
            `;
        }

        function populateTopicFilter() {
            const topicSelect = document.getElementById('topicSelect');
            // FIX: Filter topics from parent archetypes only
            const topics = [...new Set(ARCHETYPES_DATA.filter(a => !a.parent_id).map(a => a.topic))];
            topics.sort();
            let optionsHtml = '<option value="all">All Topics</option>';
            topics.forEach(topic => {
                if (topic) { // Avoid undefined topics
                    const capitalized = topic.charAt(0).toUpperCase() + topic.slice(1);
                    optionsHtml += `<option value="${topic}">${capitalized}</option>`;
                }
            });
            topicSelect.innerHTML = optionsHtml;
        }

        function setupEventListeners() {
            const searchBox = document.getElementById('searchBox');
            const searchDropdown = document.getElementById('searchDropdown');
            
            // Enhanced search with dropdown
            searchBox.addEventListener('input', e => {
                const query = e.target.value.trim();
                
                clearTimeout(searchTimeout);
                
                if (query.length >= 2) {
                    searchTimeout = setTimeout(() => {
                        showSearchResults(query);
                    }, 300);
                } else {
                    searchDropdown.classList.remove('show');
                    currentFilters.search = '';
                    renderMap();
                }
            });
            
            // Handle Enter key for direct search
            searchBox.addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = searchBox.value.trim();
                    if (query) {
                        performDirectSearch(query);
                    }
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', e => {
                if (!e.target.closest('.search-wrapper')) {
                    searchDropdown.classList.remove('show');
                }
            });

            document.getElementById('topicSelect').addEventListener('change', e => {
                currentFilters.topic = e.target.value;
                renderMap();
                resetHighlight();
            });

            document.getElementById('gradeSelect').addEventListener('change', e => {
                currentFilters.grade = e.target.value;
                renderMap();
                resetHighlight();
            });

            document.getElementById('categorySelect').addEventListener('change', e => {
                currentFilters.category = e.target.value;
                renderMap();
                resetHighlight();
            });

            document.getElementById('drillForm').addEventListener('submit', e => {
                e.preventDefault();
                const archId = document.getElementById('drillArchetype').value;
                const drill = {
                    name: document.getElementById('drillName').value,
                    platform: document.getElementById('drillPlatform').value,
                    url: document.getElementById('drillUrl').value,
                    description: document.getElementById('drillDescription').value
                };

                if (!drillLinks[archId]) drillLinks[archId] = [];
                drillLinks[archId].push(drill);
                
                saveDrillLinks();
                closeDrillManager();
                
                if (selectedNodeId === archId) {
                    showNodeInfo(archId);
                    setTimeout(() => {
                        const drillsTab = document.querySelector('.panel-tab[onclick*="drills"]');
                        if (drillsTab) drillsTab.click();
                    }, 100);
                }
            });

             window.addEventListener('resize', () => {
                if (highlightedChain.length > 0) {
                     setTimeout(() => {
                        const startNodeId = highlightedChain[0];
                        drawLines(startNodeId);
                     }, 100);
                }
             });
        }

        function showSearchResults(query) {
            const searchBox = document.getElementById('searchBox');
            const dropdown = document.getElementById('searchDropdown');
            const lowerQuery = query.toLowerCase();
            
            // Search in ID, name, and description
            const results = ARCHETYPES_DATA.filter(arch => {
                return arch.id.toLowerCase().includes(lowerQuery) ||
                       arch.name.toLowerCase().includes(lowerQuery) ||
                       (arch.topic && arch.topic.toLowerCase().includes(lowerQuery)) || // Added null check for topic
                       (arch.description && arch.description.toLowerCase().includes(lowerQuery)); // Added null check for description
            }).slice(0, 8); // Limit to 8 results
            
            if (results.length === 0) {
                dropdown.innerHTML = '<div style="padding: 16px; text-align: center; color: #a0aec0;">No matches found</div>';
                dropdown.classList.add('show');
                return;
            }
            
            dropdown.innerHTML = results.map(arch => `
                <div class="search-result-item" onclick="selectSearchResult('${arch.id}')">
                    <div class="search-result-id">${arch.id}</div>
                    <div class="search-result-name">${arch.name}</div>
                    <div class="search-result-desc">${arch.description ? arch.description.substring(0, 80) : ''}${arch.description && arch.description.length > 80 ? '...' : ''}</div>
                    <div class="search-result-meta">
                        <span class="search-result-badge level-badge ${arch.level}">${arch.level}</span>
                        <span class="search-result-badge archetype-badge ${arch.badge}">${arch.badge}</span>
                        <span class="search-result-badge" style="background: rgba(255,255,255,0.2);">${arch.topic || 'N/A'}</span>
                    </div>
                </div>
            `).join('');
            
            dropdown.classList.add('show');
        }
        
        function performDirectSearch(query) {
            const searchBox = document.getElementById('searchBox');
            const dropdown = document.getElementById('searchDropdown');
            const lowerQuery = query.toLowerCase();
            
            // Try exact ID match first
            let match = ARCHETYPES_DATA.find(arch => 
                arch.id.toLowerCase() === lowerQuery
            );
            
            // If no exact ID match, try name match
            if (!match) {
                match = ARCHETYPES_DATA.find(arch => 
                    arch.name.toLowerCase() === lowerQuery
                );
            }
            
            // If still no match, try partial match
            if (!match) {
                match = ARCHETYPES_DATA.find(arch => 
                    arch.id.toLowerCase().includes(lowerQuery) ||
                    arch.name.toLowerCase().includes(lowerQuery)
                );
            }
            
            if (match) {
                selectSearchResult(match.id);
            } else {
                // Show filtered results
                currentFilters.search = lowerQuery;
                renderMap();
                dropdown.classList.remove('show');
            }
        }
        
        function selectSearchResult(archId) {
            const searchBox = document.getElementById('searchBox');
            const dropdown = document.getElementById('searchDropdown');
            const arch = ARCHETYPES_DATA.find(a => a.id === archId);
            
            if (!arch) return;
            
            // Clear filters to ensure the node is visible
            currentFilters = { search: '', topic: 'all', grade: 'all', category: 'all' };
            document.getElementById('topicSelect').value = 'all';
            document.getElementById('gradeSelect').value = 'all';
            document.getElementById('categorySelect').value = 'all';
            
            // Update search box
            searchBox.value = `${arch.id} - ${arch.name}`;
            searchBox.classList.add('highlight-search');
            dropdown.classList.remove('show');
            
            // Render map and highlight the node
            renderMap();
            
            setTimeout(() => {
                const nodeEl = document.querySelector(`.node[data-id="${archId}"]`);
                if (nodeEl) {
                    // Remove any existing highlights
                    document.querySelectorAll('.node').forEach(n => {
                        n.classList.remove('search-match', 'highlighted');
                    });
                    
                    // Add search match highlight
                    nodeEl.classList.add('search-match');
                    
                    // Scroll to the node
                    nodeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Show info panel
                    showNodeInfo(archId);
                    
                    // Remove highlight class from search box after animation
                    setTimeout(() => {
                        searchBox.classList.remove('highlight-search');
                    }, 2000);
                }
            }, 100);
        }

        function loadDrillLinks() {
            try {
                const stored = localStorage.getItem('drillLinks');
                drillLinks = stored ? JSON.parse(stored) : {};
            } catch (e) {
                console.error('Error loading drill links:', e);
                drillLinks = {};
            }
        }

        function saveDrillLinks() {
            localStorage.setItem('drillLinks', JSON.stringify(drillLinks));
        }
        
        function renderMap() {
            const container = document.getElementById('nodes-wrapper');
            if (!container) return;

            const levels = ['L3', 'L2', 'L1'];
            const levelNames = { 'L3': 'Level 3: Meta-Strategy', 'L2': 'Level 2: Integrated Application', 'L1': 'Level 1: Foundational Skills' };
            const levelDescs = { 'L3': 'Complex strategic thinking and synthesis', 'L2': 'Multi-step problems requiring integration of L1 skills', 'L1': 'Basic procedures and single-step solutions' };

            let html = '';
            levels.forEach(level => {
                const archetypes = ARCHETYPES_DATA.filter(a => {
                    // --- FIX: Only show parent archetypes in the map ---
                    if (a.parent_id) return false;
                    
                    const levelMatch = a.level === level;
                    const topicMatch = currentFilters.topic === 'all' || a.topic === currentFilters.topic;
                    const gradeMatch = currentFilters.grade === 'all' || !a.grade || a.grade === currentFilters.grade;
                    const categoryMatch = currentFilters.category === 'all' || a.badge === currentFilters.category;
                    const searchMatch = currentFilters.search === '' || 
                                      a.name.toLowerCase().includes(currentFilters.search) ||
                                      a.id.toLowerCase().includes(currentFilters.search) ||
                                      (a.topic && a.topic.toLowerCase().includes(currentFilters.search)) ||
                                      (a.description && a.description.toLowerCase().includes(currentFilters.search));

                    return levelMatch && topicMatch && gradeMatch && categoryMatch && searchMatch;
                });

                if (archetypes.length > 0) {
                    html += `
                        <div class="level-section" data-level="${level}">
                            <div class="level-header">
                                <div class="level-badge ${level}">${level}</div>
                                <div class="level-title">${levelNames[level]}</div>
                                <div class="level-desc">${levelDescs[level]}</div>
                            </div>
                            <div class="nodes-container">
                                ${archetypes.map(arch => renderNode(arch)).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            container.innerHTML = html || '<p style="text-align:center; width: 100%; color: #a0aec0;">No archetypes match the current filters.</p>';
            setTimeout(() => {
                const mapContainer = document.getElementById('mapContainer');
                const svg = document.getElementById('connection-lines');
                if(mapContainer && svg) svg.style.height = `${mapContainer.scrollHeight}px`;
            }, 50);
        }

        function renderNode(arch) {
            // --- FIX: Get children from parent OR sub-branches ---
            const connections = arch.constituent_l1_ids || arch.source_l2_ids || arch.branches || [];
            let connectionLabel = '';
            if (arch.level === 'L3' && arch.source_l2_ids) connectionLabel = '‚Üì Integrates L2 Skills:';
            else if (arch.level === 'L2' && arch.constituent_l1_ids) connectionLabel = '‚Üì Calls L1 Skills:';
            // --- FIX: Add label for L1 parents that have branches ---
            else if (arch.level === 'L1' && arch.has_branches) connectionLabel = '‚Üì Contains Methods:';

            return `
                <div class="node" data-id="${arch.id}" onclick="showNodeInfo('${arch.id}')">
                    <div class="node-content">
                        <div class="node-header">
                            <span class="node-name">${arch.name}</span>
                            <div class="node-badges">
                                ${arch.grade ? `<span class="grade-tag ${arch.grade}">${arch.grade}</span>` : ''}
                                <span class="archetype-badge ${arch.badge}">${arch.badge}</span>
                            </div>
                        </div>
                        <div class="node-topic">${arch.topic}</div>
                        <div class="node-desc">${arch.description}</div>
                    </div>
                    <div class="node-connections">
                        <div style="flex-grow: 1;">
                        ${connections.length > 0 ? `
                            <div class="connection-label">
                                <span>${connectionLabel}</span>
                                <button class="visualize-btn" onclick="event.stopPropagation(); highlightChain('${arch.id}')" title="Visualize Path">
                                    üîÄ Visualize
                                </button>
                            </div>
                            <div class="connection-links">
                                ${connections.map(id => {
                                    // --- FIX: Handle sub-branch IDs ---
                                    const childArch = ARCHETYPES_DATA.find(a => a.id === id);
                                    const displayName = childArch ? childArch.name : id.split('-').slice(2).join('-');
                                    return `<span class="connection-link" data-connection-id="${id}" onclick="event.stopPropagation(); showNodeInfo('${id}')">${displayName}</span>`
                                }).join('')}
                            </div>
                        ` : `
                            <div class="connection-label">
                                <span>No downstream skills.</span>
                            </div>
                        `}
                        </div>
                    </div>
                </div>
            `;
        }

        function getChildren(parentId, archetypes) {
            const parent = archetypes.find(p => p.id === parentId);
            if (!parent) return [];
            // --- FIX: Get children from all possible connection types ---
            const children = parent.constituent_l1_ids || parent.source_l2_ids || parent.branches || [];
            let allChildren = [...children];
            children.forEach(c => allChildren.push(...getChildren(c, archetypes)));
            return [...new Set(allChildren)];
        }

        function highlightChain(nodeId) {
            selectedNodeId = nodeId;
            highlightedChain = [nodeId, ...getChildren(nodeId, ARCHETYPES_DATA)];
            
            document.querySelectorAll('.node').forEach(nodeEl => {
                const id = nodeEl.dataset.id;
                nodeEl.classList.remove('highlighted', 'in-chain', 'dimmed', 'search-match');
                if(id === nodeId) nodeEl.classList.add('highlighted');
                else if (highlightedChain.includes(id)) nodeEl.classList.add('in-chain');
                else nodeEl.classList.add('dimmed');
            });
            
            setTimeout(() => drawLines(nodeId), 50);
            document.getElementById('resetBtn').classList.add('visible');
        }

        function getAnchorPoint(nodeEl, side = 'bottom') {
            const container = document.getElementById('mapContainer');
            const containerRect = container.getBoundingClientRect();
            const nodeRect = nodeEl.getBoundingClientRect();
            const x = nodeRect.left - containerRect.left + (nodeRect.width / 2);
            let y = (side === 'top') ? nodeRect.top - containerRect.top : nodeRect.bottom - containerRect.top;
            return { x: x + container.scrollLeft, y: y + container.scrollTop };
        }

        function drawLines(startNodeId) {
            const svg = document.getElementById('connection-lines');
            svg.innerHTML = '';
            const toProcess = [startNodeId];
            const processed = new Set();

            while(toProcess.length > 0) {
                const currentId = toProcess.shift();
                if(processed.has(currentId)) continue;
                processed.add(currentId);

                const parentEl = document.querySelector(`.node[data-id="${currentId}"]`);
                if(!parentEl) continue;
                
                // --- FIX: Get children from all possible connection types ---
                const directChildrenIds = ARCHETYPES_DATA.find(a => a.id === currentId)?.constituent_l1_ids || 
                                      ARCHETYPES_DATA.find(a => a.id === currentId)?.source_l2_ids ||
                                      ARCHETYPES_DATA.find(a => a.id === currentId)?.branches || [];

                directChildrenIds.forEach(childId => {
                    const childEl = document.querySelector(`.node[data-id="${childId}"]`);
                    if (childEl) {
                        const startPoint = getAnchorPoint(parentEl, 'bottom');
                        const endPoint = getAnchorPoint(childEl, 'top');
                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        const d = `M ${startPoint.x} ${startPoint.y} C ${startPoint.x} ${startPoint.y + 70}, ${endPoint.x} ${endPoint.y - 70}, ${endPoint.x} ${endPoint.y}`;
                        path.setAttribute('d', d);
                        path.setAttribute('stroke', '#818cf8');
                        path.setAttribute('stroke-width', '2.5');
                        path.setAttribute('fill', 'none');
                        svg.appendChild(path);
                        toProcess.push(childId);
                    }
                });
            }
        }
        
        function resetHighlight() {
            highlightedChain = [];
            document.querySelectorAll('.node').forEach(node => node.classList.remove('highlighted', 'in-chain', 'dimmed', 'search-match'));
            document.getElementById('connection-lines').innerHTML = '';
            document.getElementById('resetBtn').classList.remove('visible');
            document.getElementById('searchBox').value = '';
            document.getElementById('searchBox').classList.remove('highlight-search');
            closeInfoPanel();
        }

        function showNodeInfo(id) {
            const arch = ARCHETYPES_DATA.find(a => a.id === id);
            if (!arch) return;
            selectedNodeId = id;

            // --- FIX: Add logic for Back Button ---
            const parent = arch.parent_id ? ARCHETYPES_DATA.find(a => a.id === arch.parent_id) : null;
            let backButtonHtml = '';
            if (parent) {
                backButtonHtml = `
                    <div style="margin-bottom: 16px; margin-top: -10px;">
                        <button onclick="showNodeInfo('${parent.id}')" style="background: #e0e7ff; color: #4338ca; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                            &larr; Back to ${parent.name}
                        </button>
                    </div>
                `;
            }
            // --- END FIX ---

            const panel = document.getElementById('infoPanel');
            const content = document.getElementById('infoPanelContent');
            
            let sopHtml = renderSOPContent(arch);
            let drillsHtml = renderDrillsContent(id);

            content.innerHTML = `
                <div class="panel-header">
                    <h2>${arch.name}</h2>
                    <p>${arch.level} ${arch.grade ? `‚Ä¢ ${arch.grade}` : ''} ‚Ä¢ ${arch.badge}</p>
                </div>
                ${backButtonHtml} <!-- FIX: Insert Back Button Here -->
                <div class="panel-tabs">
                    <button class="panel-tab active" onclick="switchTab(event, 'sopTabContent')">SOP</button>
                    <button class="panel-tab" onclick="switchTab(event, 'drillsTabContent')">Drills</button>
                </div>
                <div id="sopTabContent" class="tab-content active">${sopHtml}</div>
                <div id="drillsTabContent" class="tab-content">${drillsHtml}</div>
            `;
            panel.classList.add('visible');
        }
        
        function renderSOPContent(arch) {
             const sop = arch.sop;
             
             // --- FIX: Add logic for Sub-Branches ---
             let branchesHtml = '';
             if (arch.has_branches && arch.branches && arch.branches.length > 0) {
                 branchesHtml = `
                    <div class="section-title">üìÇ Sub-Branches (${arch.branches.length})</div>
                    ${arch.branches.map(branchId => {
                        const branch = ARCHETYPES_DATA.find(a => a.id === branchId);
                        if (!branch) return '';
                        return `<div class="sop-step sop-step-interactive" onclick="showNodeInfo('${branch.id}')">
                                    <strong>${branch.name}</strong>
                                    <div style="font-size: 11px; color: #555; margin-top: 4px;">${branch.description || ''}</div>
                                </div>`;
                    }).join('')}
                 `;
             }
             // --- END FIX ---
             
             if (!sop && branchesHtml === '') return `<p>SOP details not available.</p>`;

             const connections = arch.constituent_l1_ids || arch.source_l2_ids || [];
             const constituentArchetypes = connections.map(id => ARCHETYPES_DATA.find(a => a.id === id));
             const parentArchetypes = ARCHETYPES_DATA.filter(p => (p.constituent_l1_ids && p.constituent_l1_ids.includes(arch.id)) || (p.source_l2_ids && p.source_l2_ids.includes(arch.id)));
             
             // A helper to safely extract step text
             const getStepText = (step) => {
                 const stepParts = step.split(/:(.*)/s);
                 return stepParts.length > 1 ? stepParts[1].trim() : step;
             }

             let html = branchesHtml; // --- FIX: Add branches HTML first
             
             if (sop?.goal) {
                 html += `<div class="section-title">üéØ Goal</div><p>${sop.goal}</p>`;
             }
             
             if(sop?.triggers) {
                 html += `<div class="section-title">‚ö°Ô∏è Triggers</div><p><em>${sop.triggers.join(', ')}</em></p>`;
             }

             if (sop?.steps) {
                  html += `<div class="section-title">üìù Steps</div>` + sop.steps.map((step, i) => `<div class="sop-step"><strong>Step ${i+1}:</strong> ${getStepText(step)}</div>`).join('');
             }

             if (sop?.pitfalls) {
                 html += `<div class="section-title">‚ö†Ô∏è Pitfalls</div>` + sop.pitfalls.map(p => `
                     <div class="pitfall-item">
                         <div class="pitfall-type">${p.type}</div>
                         <p>${p.text}</p>
                     </div>
                 `).join('');
             }

             if (sop?.pro_tips) {
                 html += `<div class="section-title">üí° Pro Tips</div>` + sop.pro_tips.map(tip => `
                     <div class="tip-item">
                         <p>${tip}</p>
                     </div>
                 `).join('');
             }
             
             // Helper for links to avoid code duplication
             const renderSkillLink = (skill) => `<div class="sop-step sop-step-interactive" onclick="showNodeInfo('${skill.id}')">${skill.name} (${skill.level})</div>`;

             if (parentArchetypes.length > 0) {
                  html += `<div class="section-title">‚¨ÜÔ∏è Part Of</div>` + parentArchetypes.map(p => renderSkillLink(p)).join('');
             }
             if (constituentArchetypes.length > 0) {
                  html += `<div class="section-title">‚¨áÔ∏è Uses Skills</div>` + constituentArchetypes.map(c => c ? renderSkillLink(c) : '').join('');
             }
             return html;
         }

        function renderDrillsContent(archId) {
             const drills = drillLinks[archId] || [];
             if (drills.length === 0) {
                 return `
                      <div class="no-drills-message">
                           <p>üìö</p><p>No practice drills added yet.</p>
                           <button class="add-drill-btn" onclick="openDrillManager('${archId}')">‚ûï Add First Drill</button>
                      </div>
                 `;
             }
             return `
                  <div class="section-title">üéØ Practice Drills</div>
                  ${drills.map(drill => `
                      <a href="${drill.url}" target="_blank" class="drill-link-item">
                          <div class="drill-platform-icon">${drill.platform === 'google' ? 'üìÅ' : 'üìù'}</div>
                          <div class="drill-link-content">
                              <div class="drill-link-title">${drill.name}</div>
                              <div class="drill-link-desc">${drill.description || ''}</div>
                          </div>
                          <div class="external-link-icon">‚Üó</div>
                      </a>
                  `).join('')}
                  <button class="add-drill-btn" style="width:100%" onclick="openDrillManager('${archId}')">‚ûï Add More Drills</button>
             `;
         }

        function switchTab(evt, tabId) {
            const panel = evt.target.closest('.info-panel');
            panel.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            panel.querySelectorAll('.panel-tab').forEach(pt => pt.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        function closeInfoPanel() {
            document.getElementById('infoPanel').classList.remove('visible');
            if (!highlightedChain.length) {
                document.querySelectorAll('.node').forEach(n => n.classList.remove('highlighted', 'search-match'));
                selectedNodeId = null;
            }
        }
        
        function filterTopic(topic) {
            currentFilters.topic = topic;
            renderMap();
            resetHighlight();
        }
        function filterGrade(grade) {
            currentFilters.grade = grade;
            renderMap();
            resetHighlight();
        }
        function filterCategory(category) {
            currentFilters.category = category;
            renderMap();
            resetHighlight();
        }

        function openDrillManager(archId = null) {
            const modal = document.getElementById('drillModal');
            const select = document.getElementById('drillArchetype');
            select.innerHTML = ARCHETYPES_DATA.sort((a,b) => a.name.localeCompare(b.name)).map(a => `<option value="${a.id}">${a.name} (${a.level})</option>`).join('');
            if (archId) select.value = archId;
            document.getElementById('drillForm').reset();
            modal.classList.add('active');
        }

        function closeDrillManager() {
            document.getElementById('drillModal').classList.remove('active');
        }

    </script>
</body>
</html>
