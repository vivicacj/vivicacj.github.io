<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Math Syllabus & Exam Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-gradient-custom {
            background-image: linear-gradient(to bottom right, #0f172a, #1e3a8a, #0f172a);
        }
        /* Simple animation for appearing elements */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details[open] > summary .arrow {
            transform: rotate(90deg);
        }
        .arrow {
            transition: transform 0.2s;
        }
    </style>
</head>
<body class="bg-slate-900 bg-gradient-custom">
    <div id="app" class="min-h-screen text-white p-4 md:p-6 font-sans">
        <!-- App content will be rendered here by JavaScript -->
    </div>

    <script>
        // --- DATA DEFINITIONS ---
        const ARCHETYPES_DATA = [{"id":"ARCH-L1-ALG-01","level":"L1","name":"Factorisation","topic":"algebra","badge":"CORE","description":"Factorising expressions using common factor, difference of squares, or cross-multiplication method.","sop":{"goal":"Break down an algebraic expression into a product of simpler factors.","steps":["1. Common Factor: Always look for a common factor first.","2. Formula: Check for Difference of Squares (a²-b²) or Perfect Squares.","3. Cross-Method: Use the cross-multiplication method for trinomials."]}},{"id":"ARCH-L1-ALG-02","level":"L1","name":"Solving Fractional Equations","topic":"algebra","badge":"CORE","description":"Solving fractional equations that reduce to linear or quadratic by clearing denominators.","sop":{"goal":"Eliminate fractions and solve for the variable","triggers":["solve","equation with fractions"],"steps":["1. Identify the LCD of all denominators in the equation.","2. Multiply every term by the LCD: This eliminates all fractions.","3. Simplify and solve: You now have a standard linear or quadratic equation.","4. Check for extraneous solutions: Substitute back to ensure denominators ≠ 0."],"pitfalls":[{"type":"CRITICAL","text":"Forgetting to multiply ALL terms (including constants) by the LCD"},{"type":"COMMON","text":"Not checking if solutions make any denominator zero"}],"pro_tips":["Write 'LCD = ...' at the top before multiplying","Circle any values that would make denominators zero—these cannot be solutions"]}},{"id":"ARCH-L1-ALG-03","level":"L1","name":"Forming Expressions","topic":"algebra","badge":"CORE","description":"Translating word problems or scenarios into mathematical algebraic expressions.","sop":{"goal":"Represent a real-world situation using algebraic terms.","steps":["1. Define Variable: Let the unknown be x.","2. Translate Keywords: Convert words like 'more than' (+), 'product' (×) into math symbols.","3. Write Expression."]}},{"id":"ARCH-L1-ALG-04","level":"L1","name":"Adding/Subtracting Algebraic Fractions","topic":"algebra","badge":"CORE","description":"Combining fractions with algebraic denominators into a single fraction.","sop":{"goal":"Combine fractions with algebraic denominators into a single fraction","triggers":["add","subtract","fractions with different denominators"],"steps":["1. Find the LCD (Lowest Common Denominator): Factor all denominators if needed, then find LCD.","2. Convert each fraction: Multiply numerator and denominator by whatever makes the denominator = LCD.","3. Combine numerators: Add or subtract the numerators over the common denominator.","4. Simplify: Factor and cancel common factors if possible."],"pitfalls":[{"type":"CRITICAL","text":"Not distributing the negative sign when subtracting fractions"},{"type":"COMMON","text":"Forgetting to multiply both numerator AND denominator when converting"}],"pro_tips":["When subtracting, put brackets around the entire second numerator: (a) - (b + c)","Always factor the final numerator and denominator to check for further simplification"]}},{"id":"ARCH-L1-ALG-05","level":"L1","name":"Changing the Subject of a Formula","topic":"algebra","badge":"CORE","description":"Rearranging a complex formula to isolate a specified variable.","sop":{"goal":"Rearrange to isolate a specified variable","triggers":["make x the subject","express y in terms of"],"steps":["1. Identify the target variable: Circle or highlight what you're solving for.","2. Isolate terms containing the target: Move all other terms to the opposite side.","3. If target appears multiple times, factor it out: x(stuff) = other stuff.","4. Final isolation: Divide both sides to leave target alone.","5. Simplify if needed: Especially with fractions."],"pitfalls":[{"type":"CRITICAL","text":"Not factoring out when the variable appears in multiple terms"},{"type":"COMMON","text":"Sign errors when moving terms across the equals sign"}],"pro_tips":["When target is in denominator, first multiply both sides by that denominator","If target is squared, remember to take ± square root at the end"]}},{"id":"ARCH-L1-ALG-06","level":"L1","name":"Solving Simultaneous Equations","topic":"algebra","badge":"CORE","description":"Finding values that satisfy a system of two linear equations.","sop":{"goal":"Find values that satisfy both equations","triggers":["simultaneous equations","solve the system"],"steps":["1. Choose your method: Substitution (if one equation is already solved for a variable) or Elimination.","2. Elimination method: Multiply equations to make coefficients of one variable equal, then add/subtract to eliminate.","3. Solve for first variable: You'll get a simple equation in one variable.","4. Substitute back: Plug the value into either original equation to find the other variable.","5. Verify: Check both values satisfy both original equations."],"pitfalls":[{"type":"CRITICAL","text":"Not multiplying the entire equation when preparing for elimination"},{"type":"COMMON","text":"Forgetting to find the second variable after eliminating the first"}],"pro_tips":["Label equations as ① and ② to track your work","If coefficients are already opposites, add. If they're the same, subtract"]}},{"id":"ARCH-L1-TRIG-01","level":"L1","name":"Solving 2D Bearing / Geometry Problems","topic":"trigonometry","badge":"CORE","description":"Application of Sine/Cosine rules in 2D real-world contexts.","sop":{"goal":"To find unknown lengths or angles in non-right-angled triangles","triggers":["Bearing of","due east","diagrams with non-right-angled triangles"],"steps":["1. Annotate & Convert: Draw all North lines. Convert all given bearings into internal angles of the key triangle using parallel line properties.","2. Assess the Triangle: Count the knowns. Do you have SAS/SSS or AAS/SSA?","3. Select the Right Tool: If SAS or SSS, use the Cosine Rule. If AAS or SSA, use the Sine Rule.","4. Calculate & Check: Solve for the unknown. If finding an angle with the Sine Rule, check if an obtuse angle (180° - θ) is possible."],"pitfalls":[{"type":"CRITICAL","text":"Mixing up the Sine Rule and Cosine Rule formulas"},{"type":"COMMON","text":"Forgetting to check for the obtuse angle possibility when using Sine Rule"}],"pro_tips":["Memorize: 'If the problem gives you three sides (SSS) or a Side-Angle-Side sandwich (SAS), you need the Cosine Rule. For almost everything else, it\\'s the Sine Rule'","Always draw North lines first to visualize the bearing angles clearly"]}},{"id":"ARCH-L1-TRIG-02","level":"L1","name":"Finding Shortest Distance via Area Method","topic":"trigonometry","badge":"CORE","description":"Finding the perpendicular distance from a point to a line using area.","sop":{"goal":"To find the perpendicular distance from a point to a line using area","triggers":["shortest distance","perpendicular distance","from point to line"],"steps":["1. Identify the Triangle: The point and the two endpoints of the line segment form a triangle.","2. Calculate Area Using Sine: Use Area = ½ab sin C with the known sides and included angle.","3. Use Area = ½ × base × height: Set the line segment as the base, and solve for the perpendicular height (which is the shortest distance).","4. Verify: The shortest distance should be less than any direct distance from the point to the line's endpoints."],"pitfalls":[{"type":"CRITICAL","text":"Forgetting that Area = ½ × base × height must use the perpendicular height"},{"type":"COMMON","text":"Using the wrong side as the base"}],"pro_tips":["This method bypasses the need to find the angle at the base","Double-check: shortest distance < any slant distance"]}},{"id":"ARCH-L1-TRIG-03","level":"L1","name":"Bearings","topic":"trigonometry","badge":"CORE","description":"Interpreting and using bearings to find angles within geometric problems.","sop":{"goal":"Convert bearing information into usable angles for triangle calculations.","steps":["1. Draw North Lines at all relevant points.","2. Measure Clockwise from North.","3. Use Geometry (alternate/interior angles) to find triangle's internal angles."]}},{"id":"ARCH-L1-TRIG-04","level":"L1","name":"Elevation/Depression","topic":"trigonometry","badge":"CORE","description":"Solving problems involving angles of elevation and depression, typically using SOH-CAH-TOA.","sop":{"goal":"Solve right-angled triangle problems in a vertical plane.","steps":["1. Draw a right-angled triangle.","2. Identify Horizontal (adjacent) and Vertical (opposite) sides.","3. Use SOH-CAH-TOA."]}},{"id":"ARCH-L1-QUAD-01","level":"L1","name":"Completing the Square","topic":"algebra","badge":"CORE","description":"Converting a quadratic from standard form to completed square form.","sop":{"goal":"Convert quadratic from standard form to completed square form","triggers":["complete the square","express in the form (x + p)² + q"],"steps":["1. Identify coefficient of x²: If it's not 1, factor it out first.","2. Take half of the x coefficient, square it: For x² + bx, take (b/2)².","3. Add and subtract this value inside: x² + bx + (b/2)² - (b/2)².","4. Group to form perfect square: (x + b/2)² - (b/2)² + c.","5. Simplify the constant term: Combine constants to get final form (x + p)² + q."],"pitfalls":[{"type":"CRITICAL","text":"Forgetting to factor out the coefficient of x² before completing the square"},{"type":"COMMON","text":"Not squaring the half-coefficient correctly"}],"pro_tips":["Always write out the add-and-subtract step explicitly: + (b/2)² - (b/2)²","Check your answer by expanding back to verify"]}},{"id":"ARCH-L1-QUAD-02","level":"L1","name":"Graph Sketching (Quadratics)","topic":"algebra","badge":"CORE","description":"Sketching a parabola with all key features labeled.","sop":{"goal":"Sketch the parabola with all key features labeled","triggers":["sketch the graph","draw the curve"],"steps":["1. Identify the turning point: Use completed square form (x + p)² + q gives turning point (-p, q).","2. Determine if it opens up or down: Positive coefficient of x² → opens up, Negative → opens down.","3. Find y-intercept: Set x = 0 and calculate y.","4. Find x-intercepts (if they exist): Set y = 0 and solve the quadratic (use formula if needed).","5. Sketch: Draw smooth U-shape through all labeled points."],"pitfalls":[{"type":"CRITICAL","text":"Getting the sign wrong for the turning point coordinates"},{"type":"COMMON","text":"Forgetting to label all intercepts and the turning point"}],"pro_tips":["If completing the square gives (x - a)² + b, turning point is (a, b) not (-a, b)","Always mark minimum/maximum value clearly"]}},{"id":"ARCH-L1-QUAD-03","level":"L1","name":"Finding Equation from Graph","topic":"algebra","badge":"CORE","description":"Determining the quadratic equation given key features of the graph.","sop":{"goal":"Determine the quadratic equation given key features of the graph","triggers":["find the equation","given turning point and another point"],"steps":["1. Start with completed square form: Use y = a(x - h)² + k where (h, k) is the turning point.","2. Substitute the other given point: Plug in the coordinates to find the value of a.","3. Solve for a: Isolate a in the equation.","4. Write the final equation: Either in completed square form or expand to standard form if required."],"pitfalls":[{"type":"CRITICAL","text":"Forgetting to include the coefficient a in front"},{"type":"COMMON","text":"Sign errors when substituting coordinates with negative values"}],"pro_tips":["Always use y = a(x - h)² + k form first, it's faster than y = ax² + bx + c","Verify by checking if the turning point satisfies your final equation"]}},{"id":"ARCH-L1-GEO-01","level":"L1","name":"Proving Similarity (AA Criterion)","topic":"geometry","badge":"CORE","description":"Proving two triangles are similar, mainly using the AA criterion.","sop":{"goal":"Prove two triangles are similar using Angle-Angle","triggers":["prove triangles are similar","show similarity"],"steps":["1. Identify the two triangles: Label vertices clearly (e.g., △ABC and △DEF).","2. Find two pairs of equal angles: Use properties like vertically opposite angles, corresponding angles, alternate angles, or angles in the same segment.","3. State the equal angles explicitly: Write ∠ABC = ∠DEF and ∠BAC = ∠EDF with reasons.","4. Conclude using AA: State 'Since two angles are equal, △ABC is similar to △DEF (AA)'."],"pitfalls":[{"type":"CRITICAL","text":"Not providing geometric reasons for why angles are equal"},{"type":"COMMON","text":"Mixing up corresponding vertices when stating similarity"}],"pro_tips":["Common angle reasons: vertically opposite, corresponding (parallel lines), alternate (parallel lines), angles in same segment","Always write the triangle correspondence correctly: △ABC ~ △DEF means A↔D, B↔E, C↔F"]}},{"id":"ARCH-L1-GEO-02","level":"L1","name":"Proving Congruency (SAS, SSS, ASA, RHS)","topic":"geometry","badge":"CORE","description":"Proving two triangles are congruent using one of the four standard criteria.","sop":{"goal":"Prove two triangles are congruent","triggers":["prove triangles are congruent","show congruency"],"steps":["1. Identify the two triangles: Label all vertices.","2. List what you know: Mark equal sides and angles on the diagram.","3. Determine which test applies: SAS (Side-Angle-Side), SSS (Side-Side-Side), ASA (Angle-Side-Angle), or RHS (Right angle-Hypotenuse-Side).","4. State the equal elements with reasons: e.g., 'AB = DE (given)', '∠ABC = ∠DEF (common angle)'.","5. Conclude: State '△ABC ≅ △DEF (SAS)' with the appropriate criterion."],"pitfalls":[{"type":"CRITICAL","text":"Using the wrong congruency criterion (e.g., trying to use AAA)"},{"type":"COMMON","text":"For SAS, the angle must be BETWEEN the two equal sides"}],"pro_tips":["SAS: The angle must be included between the two sides","Common reasons: 'common side', 'given', 'opposite equal angles', 'radii of same circle'","ASA vs AAS: For ASA, the side must be between the two angles"]}},{"id":"ARCH-L1-GEO-03","level":"L1","name":"Using Similarity to Find Unknown Lengths","topic":"geometry","badge":"CORE","description":"Calculating unknown side lengths using the properties of similar triangles.","sop":{"goal":"Calculate unknown side lengths using similar triangles","triggers":["find the length","calculate x","given similar triangles"],"steps":["1. Confirm similarity: Either it's stated or prove it using SOP 1.","2. Set up the ratio: Write corresponding sides as a proportion. e.g., AB/DE = BC/EF = AC/DF.","3. Substitute known values: Plug in all given lengths.","4. Solve for unknown: Cross-multiply if needed, then isolate the unknown.","5. Check reasonableness: Does the answer make geometric sense?"],"pitfalls":[{"type":"CRITICAL","text":"Setting up ratios with non-corresponding sides"},{"type":"COMMON","text":"Inverting the ratio (getting it upside down)"}],"pro_tips":["Draw the triangles separately if they overlap, matching corresponding vertices","Write the similarity statement first (△ABC ~ △DEF) to ensure correct correspondence"]}},{"id":"ARCH-L1-GEO-04","level":"L1","name":"Shortest Distance","topic":"geometry","badge":"CORE","description":"Finding the shortest distance from a point to a line, which is the perpendicular distance.","sop":{"goal":"Calculate the perpendicular distance from a point to a line.","steps":["1. Identify the point and the line.","2. Recognize that the shortest distance is the perpendicular distance.","3. Often involves using area formulas (Area = 1/2 * base * height) or trigonometry."]}},{"id":"ARCH-L1-STAT-01","level":"L1","name":"Interpreting Stem-and-Leaf Diagrams","topic":"statistics","badge":"SAT","description":"Quickly and accurately extracting mode, median, and mean from stem-and-leaf diagrams.","sop":{"goal":"Quickly and accurately extract mode, median, and mean","triggers":["stem-and-leaf diagram is presented"],"steps":["1. Count Total (N): Write N beside the diagram—this controls the median.","2. Mode: Scan for the most frequent leaf (recombine with stem).","3. Median: Position is (N + 1) ÷ 2. If N odd → whole position (e.g., 11th). If N even → average of the two middle values (e.g., 13th and 14th).","4. Mean: Sum all values (stem+leaf) and divide by N. Use calculator carefully."],"pitfalls":[{"type":"CRITICAL","text":"For even N, forgetting to average the two middle values"},{"type":"COMMON","text":"Miscounting N"}],"pro_tips":["Write N = … on top before doing median","When N is even, pre-write Median = (____ + ____ ) ÷ 2"]}},{"id":"ARCH-L1-STAT-02","level":"L1","name":"Interpreting Grouped Frequency Tables","topic":"statistics","badge":"SAT","description":"Estimating the mean from a grouped frequency table.","sop":{"goal":"Estimate the mean from a grouped frequency table","triggers":["table with class intervals","140 < h ≤ 150"],"steps":["1. Midpoint (x): For each class, midpoint = (lower + upper) ÷ 2. Example: (140 + 150) ÷ 2 = 145.","2. Compute fx: Multiply midpoint x by frequency f.","3. Sum: Σf (often given) and Σ(fx).","4. Estimate Mean: Mean = Σ(fx) ÷ Σf."],"pitfalls":[{"type":"CRITICAL","text":"Using interval boundaries instead of midpoints"},{"type":"COMMON","text":"Forgetting to compute an fx column for each row"}],"pro_tips":["Add explicit columns for Midpoint (x) and fx","Do totals (Σf, Σfx) in a separate line to avoid slips"]}},{"id":"ARCH-L1-PROB-01","level":"L1","name":"Solving Basic Probability Problems","topic":"statistics","badge":"SAT","description":"Accurately calculating the probability of a single event.","sop":{"goal":"Accurately calculate the probability of an event","triggers":["probability","at random"],"steps":["1. Total Outcomes: Identify the size of the sample space.","2. Favourable Outcomes: List them explicitly (do not 'do it in your head'). Example: 'even and divisible by 3' → list evens, then circle those divisible by 3: 6, 12, 18.","3. Compute Probability: P(Event) = Favourable ÷ Total.","4. Simplify the fraction."],"pitfalls":[{"type":"CRITICAL","text":"Miscounting outcomes for compound 'and/or'"},{"type":"COMMON","text":"Leaving the fraction unsimplified"}],"pro_tips":["Always list the favourable outcomes—never rely on mental counting","Reduce the final fraction (or convert to simplest decimal/percentage if required)"]}},{"id":"ARCH-L1-CG-01","level":"L1","name":"Finding the Equation of a Straight Line","topic":"geometry","badge":"SAT","description":"Finding the equation of a line in the form y = mx + c.","sop":{"goal":"To find the equation connecting any two points","triggers":["Find the equation of the line","equation passing through"],"steps":["1. Find the Gradient (m): m = (y₂ − y₁) ÷ (x₂ − x₁). Pro-Tip: Label points (x₁,y₁) and (x₂,y₂) before calculating.","2. Write the Partial Equation: y = (your m)x + c.","3. Find the y-intercept (c): Substitute coordinates of one known point (use simpler one) into y = mx + c and solve for c.","4. Write the Final Equation: Combine your m and c values."],"pitfalls":[{"type":"CRITICAL","text":"Swapping x and y when substituting into y = mx + c"},{"type":"COMMON","text":"Computing m with (x₁,y₁) and (x₂,y₂) reversed by mistake"}],"pro_tips":["Label points clearly (x₁,y₁), (x₂,y₂) before any calculation","After finding m, immediately write y = mx + c, then plug in the simplest point to get c"]}},{"id":"ARCH-L1-CG-02","level":"L1","name":"Parallel & Perpendicular Lines","topic":"geometry","badge":"SAT","description":"Finding the equation of a new line based on its relationship to another line.","sop":{"goal":"To find the equation of a new line based on its relationship to another line","triggers":["parallel to","perpendicular to"],"steps":["1. Extract the Original Gradient (m₁): Rearrange the given line to y = mx + c first if needed. Gradient m₁ = ...","2. Determine the New Gradient (m₂): Parallel: m₂ = m₁. Perpendicular: m₂ = −1 ÷ m₁ (flip the fraction and change the sign).","3. Use SOP for Line Equation: With m₂ and a point on the new line, repeat steps to find the final equation."],"pitfalls":[{"type":"CRITICAL","text":"For perpendicular lines, forgetting to flip AND change sign"},{"type":"COMMON","text":"Not rearranging a general form (like ax + by = c) before reading m"}],"pro_tips":["Box m₁ first, then write m₂ = m₁ (parallel) or m₂ = −1/m₁ (perpendicular)","Once m₂ is fixed, jump straight into the standard line equation flow to finish quickly"]}},{"id":"ARCH-L1-CG-03","level":"L1","name":"Finding Length & Area (Coordinate Plane)","topic":"geometry","badge":"SAT","description":"Calculating the distance between points or the area of a polygon on a coordinate plane.","sop":{"goal":"To calculate the distance between points or the area of a triangle","triggers":["Find the length of","Find the area of"],"steps":["1. Length of a Line Segment: Distance = √[(x₂−x₁)² + (y₂−y₁)²].","2. Area of a Triangle (axis-aligned side): If one side is horizontal or vertical, use it as the base. Height is the perpendicular distance from the third vertex. Area = ½ × base × height.","3. Area of a General Triangle (Shoelace): List the vertices anti-clockwise and repeat the first at the end. Area = ½ × |(x₁y₂ + ...) − (y₁x₂ + ...)|."],"pitfalls":[{"type":"CRITICAL","text":"Misordering coordinates in Shoelace → wrong magnitude/sign"},{"type":"COMMON","text":"Dropping negative signs in distance/area calculations"}],"pro_tips":["For Shoelace, write points anti-clockwise and repeat the first at the bottom","If any side is axis-aligned, prefer ½ × base × height over Shoelace"]}},{"id":"ARCH-L1-MEN-01","level":"L1","name":"Master SOP for ALL Mensuration Problems","topic":"mensuration","badge":"SAT","description":"A master strategy to never lose marks due to formula or calculation errors in mensuration.","sop":{"goal":"To never lose marks due to formula or calculation errors","triggers":["area","surface area","volume","capacity"],"steps":["1. Identify the Shape(s): Name them immediately (e.g., cone + hemisphere).","2. Write the Formula FIRST: e.g., write CSA = πrl before substituting. (Secures method marks).","3. List Variables: Example: r = 8, l = 17.","4. Substitute and Calculate: Carefully.","5. Final Check (Units & Accuracy): Correct units (e.g., cm², cm³) and required s.f./d.p."],"pitfalls":[{"type":"CRITICAL","text":"Missing/incorrect units → lose accuracy/answer marks"},{"type":"COMMON","text":"Substituting numbers before writing the exact formula"}],"pro_tips":["Always write the formula first to lock in method marks","Box the final answer with units and accuracy"]}},{"id":"ARCH-L1-MEN-02","level":"L1","name":"Similar Figures & Solids","topic":"mensuration","badge":"SAT","description":"Correctly using scaling laws for length, area, and volume for similar figures.","sop":{"goal":"Correctly use scaling laws for length, area, and volume","triggers":["similar","same shape but different size"],"steps":["1. Find the Length Ratio (k) FIRST: k = Length₁ ÷ Length₂.","2. Identify the Target: Area or Volume/Capacity/Mass?","3. Apply Power Rule: Area ratio = k². Volume/Capacity/Mass ratio = k³.","4. Set up Proportion & Solve: Plug numbers into the correct ratio equation."],"pitfalls":[{"type":"CRITICAL","text":"Using k for area/volume without squaring/cubing"},{"type":"COMMON","text":"Swapping numerator/denominator (wrong object on top)"}],"pro_tips":["Always write k first, then immediately write k² or k³ before numbers","Draw a mini table with three rows: Length / Area / Volume = k / k² / k³"]}},{"id":"ARCH-L1-MEN-03","level":"L1","name":"Composite Solids","topic":"mensuration","badge":"SAT","description":"Finding the Total Surface Area (TSA) or Total Volume of combined shapes.","sop":{"goal":"Find Total Surface Area (TSA) or Total Volume of combined shapes","triggers":["combined shapes","cone + hemisphere","composite solid"],"steps":["1. Deconstruct the Shape: List the basic parts clearly.","2. Calculate Each Part Separately: Volume: sum volumes of parts. TSA (TRAP): only exposed surfaces count. Do NOT add base areas that are glued/hidden.","3. Sum the Exposed Parts for TSA; sum volumes for total volume."],"pitfalls":[{"type":"CRITICAL","text":"Double-counting hidden/glued faces in TSA"},{"type":"COMMON","text":"Mixing up CSA vs TSA formulas or incorrectly adding base areas"}],"pro_tips":["Make a checklist of faces; mark 'hidden' vs 'exposed'","Calculate and label each part with units before summing"]}},{"id":"ARCH-L1-MEN-04","level":"L1","name":"Sector & Segment Problems","topic":"mensuration","badge":"SAT","description":"Accurately calculating properties of circle parts like sectors and segments.","sop":{"goal":"Accurately calculate properties of circle parts","triggers":["sector","segment","arc length"],"steps":["1. Check Angle Unit: Degrees vs radians determines formulas.","2. Sector First: Arc length: (θ÷360)×2πr (degrees) or rθ (radians). Sector area: (θ÷360)×πr² (degrees) or ½r²θ (radians).","3. Segment: Master idea: Area of Segment = Area of Sector − Area of Triangle. Triangle area (using included angle): ½ab sinC. Perform the subtraction."],"pitfalls":[{"type":"CRITICAL","text":"Using degree formulas on radian inputs (or vice-versa)"},{"type":"COMMON","text":"Forgetting to subtract the triangle for a segment"}],"pro_tips":["Circle the angle unit at the start","Always write 'Segment = Sector − Triangle' before substituting numbers"]}},{"id":"ARCH-L1-INEQ-01","level":"L1","name":"Solving Compound Inequalities","topic":"algebra","badge":"SAT","description":"Finding the final, single range of x for a compound inequality.","sop":{"goal":"To find the final, single range of x","triggers":["two inequality signs","A < B ≤ C"],"steps":["1. SPLIT: Break into two simpler inequalities. Example: 3x − 1 < 2x + 9 ≤ 15 → Part A & Part B.","2. SOLVE: Solve Part A and Part B individually.","3. CRITICAL RULE: If you multiply or divide by a negative, you MUST flip the inequality sign.","4. DRAW: Draw a number line and mark key values.","5. PLOT & OVERLAP: Plot both solutions; the final answer is the overlap.","6. WRITE: Write as a single compound inequality (e.g., 4 < x ≤ 10)."],"pitfalls":[{"type":"CRITICAL","text":"Not flipping the sign after multiplying/dividing by a negative"},{"type":"COMMON","text":"Using the wrong open/closed circle on the number line"}],"pro_tips":["Write a banner note at the top: '× or ÷ negative → flip sign'","Always sketch the number line before writing the final compound form"]}},{"id":"ARCH-L1-INEQ-02","level":"L1","name":"Modelling with Inequalities","topic":"algebra","badge":"SAT","description":"Translating real-world language into a precise inequality.","sop":{"goal":"Translate real-world language into a precise inequality","triggers":["at least","no more than","minimum","maximum"],"steps":["1. DEFINE: 'Let x be …' (define the variable clearly).","2. TRANSLATE KEYWORDS: at least/minimum → ≥, at most/maximum/no more than → ≤, more than → >, less than → <.","3. CONSTRUCT: Build the inequality with the numbers and your symbol."],"pitfalls":[{"type":"CRITICAL","text":"Misreading 'at least/at most' leading to the wrong inequality direction"},{"type":"COMMON","text":"Forgetting to define the variable first"}],"pro_tips":["Underline the keyword and immediately write its symbol (≥, ≤, >, <)","Start with 'Let x = …' to anchor the model"]}},{"id":"ARCH-L1-INEQ-03","level":"L1","name":"Finding Max/Min Values in a Range","topic":"algebra","badge":"SAT","description":"Finding the absolute maximum or minimum value of an expression within given ranges.","sop":{"goal":"To find the absolute maximum or minimum value of an expression","triggers":["largest value","smallest value","with given ranges"],"steps":["1. LIST BOUNDARIES: Write x_min, x_max, y_min, y_max.","2. ANALYZE THE GOAL: To maximize y - x³, choose y_max and the smallest possible x³. To minimize y - 2x, choose y_min and the largest possible 2x.","3. CALCULATE: Substitute boundary values and compute."],"pitfalls":[{"type":"CRITICAL","text":"Choosing the wrong boundary combination (entire result wrong)"},{"type":"COMMON","text":"Forgetting that odd powers keep sign (e.g., (−9)³ = −729)"}],"pro_tips":["Draw a quick 2×2 boundary table for x and y, then pick the combo that matches the goal","Do a quick mental 'sanity check' before finalizing"]}},{"id":"ARCH-L1-IND-01","level":"L1","name":"Simplifying Complex Index Expressions","topic":"algebra","badge":"SAT","description":"Reducing complicated expressions to simplest form with positive indices.","sop":{"goal":"Reduce complicated expressions to simplest form with positive indices","triggers":["Simplify","expressions with powers, roots, negatives"],"steps":["1. Brackets First (Power of a Power): Multiply indices inside brackets. Examples: (p³)² = p⁶.","2. Handle Negatives & Roots: Negative indices → reciprocals: x⁻³ = 1 ÷ x³. Roots → fractional indices: √x = x^(1/2).","3. Combine Same Bases: Multiply same base → add indices. Divide same base → subtract indices.","4. Calculate Coefficients: Manage normal numbers separately; then recombine."],"pitfalls":[{"type":"CRITICAL","text":"Treating negative indices as negative numbers (instead of reciprocals)"},{"type":"COMMON","text":"Forgetting to distribute powers across brackets and coefficients"}],"pro_tips":["Convert roots to fractional indices and negatives to reciprocals FIRST","Separate coefficient arithmetic from index manipulation, then recombine"]}},{"id":"ARCH-L1-IND-02","level":"L1","name":"Solving Exponential Equations","topic":"algebra","badge":"SAT","description":"Finding the unknown in the exponent by unifying the base.","sop":{"goal":"Find the unknown in the exponent","triggers":["Solve","variables appear as powers"],"steps":["1. Unify the Base (Golden Rule): Write all numbers as powers of the SAME base. Examples: 9 = 3², 27 = 3³.","2. Simplify Both Sides: Use simplification rules until you get base^a = base^b.","3. Equate the Indices: Set a = b.","4. Solve: Finish the (usually linear) equation."],"pitfalls":[{"type":"CRITICAL","text":"Trying to equate indices BEFORE unifying the base"},{"type":"COMMON","text":"Mishandling fractional/negative powers during simplification"}],"pro_tips":["Always rewrite numbers as prime-base powers first","Keep a tiny scratch list of common conversions (e.g., 8 = 2³, 81 = 3⁴)"]}},{"id":"ARCH-L1-IND-03","level":"L1","name":"Handling '+' or '−' in Exponential Equations","topic":"algebra","badge":"SAT","description":"Solving exponential equations that involve addition or subtraction by factoring.","sop":{"goal":"Solve exponential equations that involve addition or subtraction","triggers":["Sums/differences of like exponentials"],"steps":["1. Identify the Trap: Index laws do NOT apply across + or −.","2. Factor / Combine Like Terms: Treat repeated exponentials like like-terms. Examples: 3³ + 3³ + 3³ = 3 × (3³); 2^(x+1) − 2^x = 2^x (2 − 1).","3. Simplify → Switch to Solving Exponential Equations SOP: Reduce to a standard exponential form."],"pitfalls":[{"type":"CRITICAL","text":"Forcing index laws over sums/differences"},{"type":"COMMON","text":"Forgetting to factor out the common exponential term"}],"pro_tips":["'Apples with apples': combine identical bases/powers first","After factoring, look for the single-base structure and revert to the standard solving SOP"]}},{"id":"ARCH-L1-IND-04","level":"L1","name":"Calculating with Standard Form","topic":"algebra","badge":"SAT","description":"Performing calculations with scientific notation and ensuring the final answer is in proper standard form.","sop":{"goal":"Perform calculations with A × 10^n and end in proper standard form (1 ≤ A < 10)","triggers":["numbers given in scientific notation"],"steps":["1. Multiplication / Division: 1) Multiply/divide the A parts. 2) Apply index laws to the 10^n parts. 3) Adjust to make 1 ≤ A < 10.","2. Addition / Subtraction: 1) Unify the exponent. 2) Factor out the common 10^n. 3) Add/subtract the A parts. 4) Adjust A back to [1, 10) if needed."],"pitfalls":[{"type":"CRITICAL","text":"Adding/subtracting without matching powers of 10"},{"type":"COMMON","text":"Leaving A outside [1, 10)"}],"pro_tips":["For +/−, match exponents first, then work on the A parts","Always do a final 'standard-form check'"]}},{"id":"ARCH-L1-RATIO-01","level":"L1","name":"Map Scale Problems","topic":"numbers","badge":"SAT","description":"Accurately converting between map distances and actual distances/areas.","sop":{"goal":"Accurately convert between map distances and actual distances/areas","triggers":["Scale 1 : n","area on the map","actual area"],"steps":["1. Write the 'Dual Scales': Length scale: 1 cm : (n ÷ 100,000) km. Area scale: 1 cm² : (n ÷ 100,000)² km².","2. Select the Correct Scale: Decide if it's length or area.","3. Proportion & Solve: Actual Distance = Map Distance × (length scale factor). Map Area = Actual Area ÷ (area scale factor)."],"pitfalls":[{"type":"CRITICAL","text":"Using the length scale to compute an area"},{"type":"COMMON","text":"Forgetting to square when switching to area"}],"pro_tips":["Always write BOTH scales first (length and area)","Circle the word 'Area' in the question → write 'square it' beside it"]}},{"id":"ARCH-L1-RATIO-02","level":"L1","name":"Percentage Change & Reverse Percentage","topic":"numbers","badge":"SAT","description":"Calculating the new value after a percentage change, or recovering the original value.","sop":{"goal":"Calculate the new value after change, or recover the original value","triggers":["increase by X%","discount","GST","after the increase"],"steps":["1. Identify the '100%': Always the original value / cost price / pre-tax price.","2. Compute New Percentage: Increase 15% → new % = 115%. Discount 20% → new % = 80%.","3. Execute: Forward (new value): New = Original × (New% ÷ 100). Reverse (original): Original = New ÷ (New% ÷ 100)."],"pitfalls":[{"type":"CRITICAL","text":"In reverse percentage, multiplying instead of dividing by the new percentage"},{"type":"COMMON","text":"Setting '100%' to the new (changed) value"}],"pro_tips":["Underline the '100% reference' (Original/Cost/Pre-tax) before any calculation","Write a reminder: 'Original? → divide by new%'"]}},{"id":"ARCH-L1-RATIO-03","level":"L1","name":"Simple & Compound Interest","topic":"numbers","badge":"SAT","description":"Computing total amount and interest for simple and compound interest scenarios.","sop":{"goal":"Compute total amount and interest for simple/compound interest","triggers":["simple interest","compound interest","per annum","compounded quarterly/half-yearly"],"steps":["1. Identify Type & Parameters: P = Principal, R = annual rate, T = time (years), n = compounding per year.","2. Write Formula: Simple: I = P × (R ÷ 100) × T. Compound: A = P × (1 + (R ÷ n) ÷ 100)^(n × T).","3. Substitute Carefully & Calculate: For compound, divide R by n, multiply T by n.","4. Answer the Question: If they want interest, use A − P."],"pitfalls":[{"type":"CRITICAL","text":"Forgetting R → R/n and T → nT for compounding"},{"type":"COMMON","text":"Confusing interest vs total amount"}],"pro_tips":["As soon as you read 'compounded …', jot n = …, then write R → R/n, T → nT","If the question says 'interest', remember to compute A − P"]}},{"id":"ARCH-L2-TRIG-01","level":"L2","name":"2D/3D Trigonometry in Context","topic":"trigonometry","badge":"CORE","grade":"G4","description":"Multi-step problems requiring students to model a real-world scenario on a 2D plane, solve for 'bridge' values, and then use them in a vertical 2D plane to solve 3D elevation/depression problems.","constituent_l1_ids":["ARCH-L1-TRIG-01","ARCH-L1-TRIG-03","ARCH-L1-TRIG-04","ARCH-L1-GEO-04"],"sop":{"goal":"Solve a complex 3D problem by breaking it down into 2D triangle calculations.","steps":["1. Call SOP-L1-BEARING: Convert all bearings to internal angles to solve the 'ground plane' triangle.","2. Call SOP-L1-TRIG-RULES: Use Sine/Cosine Rule to solve the 'ground plane' triangle.","3. Call SOP-L1-SOHCAHTOA: Use the result from step 2 as the 'bridge' to solve the 'vertical plane' right-angled triangle.","4. (If needed) Call SOP-L1-SHORTEST-DIST: Use the Area Method if the question asks for 'greatest angle of elevation'."]}},{"id":"ARCH-L2-QUAD-01","level":"L2","name":"Graphical Analysis of Functions","topic":"algebra","badge":"CORE","grade":"G4","description":"Problems that require students to plot a function (quadratic or cubic) and use the graph to solve equations by finding intersections with a suitable straight line, or finding the gradient of a tangent.","constituent_l1_ids":["ARCH-L1-QUAD-02","ARCH-L1-ALG-02","ARCH-L1-CG-01"],"sop":{"goal":"Use a plotted graph to solve related equations and find gradients.","steps":["1. Call SOP-L1-PLOT-GRAPH: Accurately plot points and draw a smooth curve.","2. Call SOP-L1-ALG-TRANSFORM: Algebraically manipulate the target equation to isolate the original function y on one side. The other side is the y=mx+c to be drawn.","3. Call SOP-L1-LINE-DRAW: Find two points and draw the straight line.","4. Call SOP-L1-READ-GRAPH: Read the coordinates of intersection points or draw a tangent to find the gradient."]}},{"id":"ARCH-L2-GEO-01","level":"L2","name":"Similarity & Congruency Application","topic":"geometry","badge":"CORE","grade":"G4","description":"Problems where proving similarity or congruency is the first step. The results (e.g., proportional sides) are then used as tools to perform subsequent calculations for unknown lengths, area ratios, etc.","constituent_l1_ids":["ARCH-L1-GEO-01","ARCH-L1-GEO-02","ARCH-L1-GEO-03"],"sop":{"goal":"Use the properties of similar or congruent triangles to solve for other unknown quantities.","steps":["1. Call SOP-L1-PROVE-SIMILAR: Use AA to prove the required triangles are similar. Write this out formally.","2. Call SOP-L1-RATIO-SETUP: Set up the correct ratio of corresponding sides or the ratio of areas (by squaring the length ratio).","3. Call SOP-L1-SOLVE-PROPORTION: Substitute known values and solve for the unknown length or area."]}},{"id":"ARCH-L2-ALG-01","level":"L2","name":"Algebraic Modelling in Context","topic":"algebra","badge":"CORE","grade":"G4","description":"Word problems (e.g., speed/distance/time, financial) where the student must first translate the text into one or more algebraic equations (often fractional or quadratic) and then solve them.","constituent_l1_ids":["ARCH-L1-ALG-02","ARCH-L1-ALG-03","ARCH-L1-RATIO-02"],"sop":{"goal":"Create and solve an algebraic equation from a real-world scenario.","steps":["1. Call SOP-L1-FORM-EXPRESSION: Translate the words into mathematical expressions (e.g., Time = Distance/Speed).","2. Call SOP-L1-FORM-EQUATION: Link the expressions with the final piece of information (e.g., 'the difference in time is 20 minutes') to form an equation.","3. Call SOP-L1-SOLVE-EQUATION: Use algebraic manipulation to solve the resulting equation."]}},{"id":"ARCH-L3-SYN-01","level":"L3","name":"Multi-Representation Synthesis","topic":"meta","badge":"SAT","grade":"G4","description":"Tasks where students must synthesize information from multiple representations – algebraic equations, geometric diagrams, and data tables – to arrive at a solution. The core skill is fluently translating between them.","source_l2_ids":["ARCH-L2-QUAD-01","ARCH-L2-TRIG-01"],"sop":{"goal":"Integrate information from different mathematical formats to solve a complex problem.","steps":["1. Deconstruct & Diagram: Read the entire problem. Use a highlighter. Draw a large, clear diagram. Translate all textual information onto this diagram.","2. Analyze & Archetype: Look at your diagram. Ask: 'What L2 Archetypes does this problem contain?'","3. Route & Plan: Create a quick, step-by-step plan linking the different parts of the problem.","4. Execute & Explain: Execute the plan step-by-step, calling upon the necessary L2 and L1 SOPs. Write down every step clearly, showing your formulas and reasoning."]}},{"id":"ARCH-L3-MOD-01","level":"L3","name":"Contextual Modelling & Justification","topic":"meta","badge":"SAT","grade":"G4","description":"Represents the highest level of application, where the problem is open-ended and may not have a single 'correct' answer. The student must select appropriate models, state assumptions, perform calculations, and justify their final decision.","source_l2_ids":["ARCH-L2-ALG-01","ARCH-L2-TRIG-01"],"sop":{"goal":"Develop a mathematical model for an open-ended problem and justify the conclusion.","steps":["1. Deconstruct & Diagram: Read the entire problem. Highlight key data and constraints. Draw a diagram.","2. Analyze & Archetype: Identify the underlying L2 problem type (e.g., 'This is a Trig problem') and the additional justification element.","3. Route & Plan: Create a step-by-step plan. 'First, I will solve the L2 part. Second, I will calculate the costs/options. Finally, I will compare and write my conclusion.'","4. Execute & Explain: Execute the plan clearly. For 'Justify' questions, write your final answer in a full sentence, referencing your calculations."]}}];
        
        const syllabusTopics = [
            { id: 'ALG1', strand: 'Algebra', grade: 'G3', name: 'Algebraic Manipulation', type: 'strengthening', pre: [], relatedArchetypes: ['ARCH-L1-ALG-01', 'ARCH-L1-ALG-04', 'ARCH-L1-ALG-05'] },
            { id: 'ALG2', strand: 'Algebra', grade: 'G3', name: 'Equations', type: 'strengthening', pre: ['ALG1'], relatedArchetypes: ['ARCH-L1-ALG-02', 'ARCH-L1-ALG-06'] },
            { id: 'ALG3', strand: 'Algebra', grade: 'G3', name: 'Inequalities', type: 'extending', pre: ['ALG2'], relatedArchetypes: ['ARCH-L1-INEQ-01', 'ARCH-L1-INEQ-02', 'ARCH-L1-INEQ-03'] },
            { id: 'ALG4', strand: 'Algebra', grade: 'G3', name: 'Functions & Quadratic Graphs', type: 'extending', pre: ['ALG1'], relatedArchetypes: ['ARCH-L1-QUAD-01','ARCH-L1-QUAD-02', 'ARCH-L1-QUAD-03'] },
            { id: 'ALG5', strand: 'Algebra', grade: 'G4', name: 'Graphs of Functions', type: 'extending', pre: ['ALG4'], relatedArchetypes: ['ARCH-L2-QUAD-01'] },
            { id: 'ALG6', strand: 'Algebra', grade: 'G4', name: 'Modelling', type: 'integrative', pre: ['ALG2', 'ALG5'], relatedArchetypes: ['ARCH-L2-ALG-01', 'ARCH-L3-MOD-01'] },
            { id: 'ALG7', strand: 'Algebra', grade: 'G4', name: 'Indices & Standard Form', type: 'strengthening', pre: ['ALG1'], relatedArchetypes: ['ARCH-L1-IND-01', 'ARCH-L1-IND-02', 'ARCH-L1-IND-03', 'ARCH-L1-IND-04'] },
            { id: 'ALG8', strand: 'Algebra', grade: 'G4', name: 'Matrices', type: 'new', pre: [], relatedArchetypes: [] }, 
            { id: 'ALG9', strand: 'Algebra', grade: 'G4', name: 'Sequences', type: 'new', pre: ['ALG6'], relatedArchetypes: [] }, 
            { id: 'GEO1', strand: 'Geometry', grade: 'G3', name: 'Plane Geometry', type: 'strengthening', pre: [], relatedArchetypes: ['ARCH-L1-GEO-02'] },
            { id: 'GEO2', strand: 'Geometry', grade: 'G3', name: 'Mensuration', type: 'extending', pre: ['GEO1'], relatedArchetypes: ['ARCH-L1-MEN-01', 'ARCH-L1-MEN-03', 'ARCH-L1-MEN-04'] },
            { id: 'GEO3', strand: 'Geometry', grade: 'G3', name: 'Similarity & Congruency', type: 'integrative', pre: ['GEO1'], relatedArchetypes: ['ARCH-L1-GEO-01', 'ARCH-L1-GEO-03', 'ARCH-L1-MEN-02'] },
            { id: 'GEO4', strand: 'Geometry', grade: 'G4', name: '3D Mensuration', type: 'extending', pre: ['GEO2'], relatedArchetypes: ['ARCH-L1-MEN-01', 'ARCH-L1-MEN-03'] },
            { id: 'GEO5', strand: 'Geometry', grade: 'G4', name: 'Bearings', type: 'new', pre: ['GEO1'], relatedArchetypes: ['ARCH-L1-TRIG-03'] },
            { id: 'GEO6', strand: 'Geometry', grade: 'G4', name: 'Loci & Construction', type: 'new', pre: ['GEO1'], relatedArchetypes: [] },
            { id: 'GEO7', strand: 'Geometry', grade: 'G4', name: 'Vectors', type: 'new', pre: ['GEO1'], relatedArchetypes: [] },
            { id: 'TRG1', strand: 'Trigonometry', grade: 'G3', name: 'Basic Trigonometry', type: 'new', pre: ['GEO1'], relatedArchetypes: ['ARCH-L1-TRIG-01', 'ARCH-L1-TRIG-04'] },
            { id: 'TRG2', strand: 'Trigonometry', grade: 'G3', name: 'Coordinate Geometry', type: 'integrative', pre: ['ALG2', 'GEO1'], relatedArchetypes: ['ARCH-L1-CG-01', 'ARCH-L1-CG-02', 'ARCH-L1-CG-03'] },
            { id: 'TRG3', strand: 'Trigonometry', grade: 'G4', name: '3D Trigonometry', type: 'extending', pre: ['TRG1', 'GEO4'], relatedArchetypes: ['ARCH-L2-TRIG-01'] },
            { id: 'TRG4', strand: 'Trigonometry', grade: 'G4', name: 'Applications with Bearings', type: 'integrative', pre: ['TRG1', 'GEO5'], relatedArchetypes: ['ARCH-L2-TRIG-01'] },
            { id: 'STP1', strand: 'Statistics', grade: 'G3', name: 'Data Representation', type: 'strengthening', pre: [], relatedArchetypes: ['ARCH-L1-STAT-01', 'ARCH-L1-STAT-02'] },
            { id: 'STP2', strand: 'Statistics', grade: 'G3', name: 'Probability', type: 'extending', pre: ['STP1'], relatedArchetypes: ['ARCH-L1-PROB-01'] },
            { id: 'STP3', strand: 'Statistics', grade: 'G3', name: 'Ratio & Proportion', type: 'strengthening', pre: [], relatedArchetypes: ['ARCH-L1-RATIO-01'] },
            { id: 'STP4', strand: 'Statistics', grade: 'G3', name: 'Percentages', type: 'extending', pre: ['STP3'], relatedArchetypes: ['ARCH-L1-RATIO-02', 'ARCH-L1-RATIO-03'] },
            { id: 'STP5', strand: 'Statistics', grade: 'G4', name: 'Interpretation & Reasoning', type: 'integrative', pre: ['STP1', 'STP2'], relatedArchetypes: [] }
        ];
        
        const examTopics = [
            { id: 'g3c1', num: '01', cat: 'core', grade: 'G3', name: 'Trigonometry', topics: ['TRG1'], wt: '20-25%', g3f: 7, g4f: 10, prog: 'Right → Any triangle', relatedArchetypes: [] },
            { id: 'g3c2', num: '02', cat: 'core', grade: 'G3', name: 'Quadratic Graphs', topics: ['ALG4'], wt: '15-20%', g3f: 8, g4f: 10, prog: 'Expands function types', relatedArchetypes: [] },
            { id: 'g3c3', num: '03', cat: 'core', grade: 'G3', name: 'Algebra', topics: ['ALG1', 'ALG2', 'ALG3'], wt: '15-18%', g3f: 9, g4f: 10, prog: 'Adds complexity', relatedArchetypes: [] },
            { id: 'g3c4', num: '04', cat: 'core', grade: 'G3', name: 'Circle & Similarity', topics: ['GEO1', 'GEO3'], wt: '12-15%', g3f: 7, g4f: 9, prog: 'Completes theorems', relatedArchetypes: [] },
            { id: 'g3c5', num: '05', cat: 'core', grade: 'G3', name: 'Statistics & Prob', topics: ['STP1', 'STP2'], wt: '8-12%', g3f: 5, g4f: 8, prog: 'Inferential stats', relatedArchetypes: [] },
            { id: 'g3c6', num: '06', cat: 'core', grade: 'G3', name: 'Financial Maths', topics: ['STP3', 'STP4'], wt: '8-10%', g3f: 6, g4f: 8, prog: 'Real-world models', relatedArchetypes: [] },
            { id: 'g3s1', num: '07', cat: 'satellite', grade: 'G3', name: 'Mensuration', topics: ['GEO2'], wt: '6-8%', g3f: 6, g4f: 7, prog: 'Composite solids', relatedArchetypes: [] },
            { id: 'g3s2', num: '08', cat: 'satellite', grade: 'G3', name: 'Coord Geometry', topics: ['TRG2'], wt: '4-6%', g3f: 5, g4f: 6, prog: 'Perpendicularity', relatedArchetypes: [] },
            { id: 'g3s3', num: '09', cat: 'satellite', grade: 'G3', name: 'Sequences', topics: ['ALG9'], wt: '3-4%', g3f: 0, g4f: 4, prog: '🆕 New in G4', relatedArchetypes: [] },
            { id: 'g3s4', num: '10', cat: 'satellite', grade: 'G3', name: 'Vectors & Matrices', topics: ['GEO7', 'ALG8'], wt: '4-6%', g3f: 0, g4f: 5, prog: '🆕 New in G4', relatedArchetypes: [] },
            { id: 'g4c1', num: '11', cat: 'core', grade: 'G4', name: 'Geometry & Mensuration', topics: ['GEO1', 'GEO2', 'GEO3', 'GEO4', 'GEO5', 'GEO6'], wt: '25-30%', g3f: 0, g4f: 10, prog: 'Sine/Cosine Rule + Circle Theorems', relatedArchetypes: [] },
            { id: 'g4c2', num: '12', cat: 'core', grade: 'G4', name: 'Algebra Mastery', topics: ['ALG1', 'ALG2', 'ALG3', 'ALG4', 'ALG5', 'ALG6', 'ALG7'], wt: '20-25%', g3f: 0, g4f: 10, prog: 'Quadratic Formula + Completing Square', relatedArchetypes: [] },
            { id: 'g4c3', num: '13', cat: 'core', grade: 'G4', name: 'Statistics & Probability', topics: ['STP1', 'STP2', 'STP5'], wt: '15-18%', g3f: 0, g4f: 9, prog: 'Standard Deviation + Tree Diagrams', relatedArchetypes: [] },
            { id: 'g4c4', num: '14', cat: 'core', grade: 'G4', name: 'Financial & Proportion', topics: ['STP3', 'STP4'], wt: '12-15%', g3f: 0, g4f: 8, prog: 'Compound Interest + HCF/LCM', relatedArchetypes: [] },
            { id: 'g4s1', num: '15', cat: 'satellite', grade: 'G4', name: 'Coordinate Geometry', topics: ['TRG2'], wt: '6-8%', g3f: 0, g4f: 6, prog: 'Perpendicular + Intersection', relatedArchetypes: [] },
            { id: 'g4s2', num: '16', cat: 'satellite', grade: 'G4', name: 'Vectors 2D', topics: ['GEO7'], wt: '5-7%', g3f: 0, g4f: 5, prog: 'Collinear Points + Magnitude', relatedArchetypes: [] },
            { id: 'g4s3', num: '17', cat: 'satellite', grade: 'G4', name: 'Matrices', topics: ['ALG8'], wt: '4-6%', g3f: 0, g4f: 5, prog: 'Matrix Multiplication', relatedArchetypes: [] },
            { id: 'g4s4', num: '18', cat: 'satellite', grade: 'G4', name: 'Sequences & Patterns', topics: ['ALG9'], wt: '3-5%', g3f: 0, g4f: 4, prog: 'AP/GP + nth term', relatedArchetypes: [] }
        ];
        
        // --- APP LOGIC ---
        const colors = { new: '#EF4444', extending: '#F59E0B', strengthening: '#EAB308', integrative: '#8B5CF6' };
        const labels = { new: '🆕 New', extending: '🧩 Extending', strengthening: '⚙️ Strengthening', integrative: '🏗️ Integrative' };
        const icons = {
            Circle: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>`,
            Target: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
            BookOpen: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>`,
            TrendingUp: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>`,
            ArrowRight: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>`,
            Sparkles: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.9 5.8-5.8 1.9 5.8 1.9L12 18l1.9-5.8 5.8-1.9-5.8-1.9z"/></svg>`,
            CheckCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
            Cpu: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><rect x="9" y="9" width="6" height="6"></rect><line x1="9" y1="1" x2="9" y2="4"></line><line x1="15" y1="1" x2="15" y2="4"></line><line x1="9" y1="20" x2="9" y2="23"></line><line x1="15" y1="20" x2="15" y2="23"></line><line x1="20" y1="9" x2="23" y2="9"></line><line x1="20" y1="14" x2="23" y2="14"></line><line x1="1" y1="9" x2="4" y2="9"></line><line x1="1" y1="14" x2="4" y2="14"></line></svg>`
        };

        // --- STATE MANAGEMENT ---
        let state = {
            selectedTopic: null,
            selectedExamTopic: null,
            filter: 'all',
            hoveredTopic: null,
            viewMode: 'galaxy',
            masteredTopics: [], 
            selectedGrade: 'G3',
        };

        // --- RENDER FUNCTIONS ---
        
        function render() {
            const app = document.getElementById('app');
            if (!app) return; // Guard clause
            
            const filtered = getFilteredSyllabusTopics();
            app.innerHTML = `
                <div class="max-w-7xl mx-auto mb-6">
                    <h1 class="text-3xl lg:text-4xl font-bold mb-4 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                        E-Math Syllabus & Exam Map
                    </h1>
                    <p class="text-sm text-slate-400 mb-6">Interactive map: Syllabus Topics (${syllabusTopics.length}) ↔ Exam Topics (${examTopics.length})</p>
                    ${renderHeaderStats()}
                </div>

                <div class="max-w-7xl mx-auto mb-6 space-y-4" id="controls">
                    ${renderControls()}
                </div>

                <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
                    ${state.viewMode === 'galaxy' ? renderGalaxyView(filtered) : renderMatrixView()}
                    <div class="bg-slate-800/50 rounded-2xl p-4 md:p-6 border border-slate-700">
                        ${renderDetailsPanel()}
                    </div>
                </div>
            `;
            
            // We moved the event listener setup to initializeApp, 
            // but for dynamically added elements inside innerHTML, we need to re-add them
            // or (better) use event delegation, which is what we are doing.
            // So, no need to call addEventListeners() here.
        }
        
        function renderHeaderStats() {
            const coreCount = examTopics.filter(t => t.grade === state.selectedGrade && t.cat === 'core').length;
            const satelliteCount = examTopics.filter(t => t.grade === state.selectedGrade && t.cat === 'satellite').length;
            const g4NewCount = syllabusTopics.filter(t => t.grade === 'G4' && t.type === 'new').length;

            return `
                 <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                    <div class="bg-slate-800/60 p-3 rounded-lg border border-slate-700">
                        <div class="text-slate-400">Mastered (Syllabus)</div>
                        <div class="text-xl font-bold text-green-400">${state.masteredTopics.length}/${syllabusTopics.length}</div>
                    </div>
                    <div class="bg-slate-800/60 p-3 rounded-lg border border-slate-700">
                        <div class="text-slate-400">Core Topics (${state.selectedGrade})</div>
                        <div class="text-xl font-bold text-yellow-400">${coreCount} (~80%)</div>
                    </div>
                     <div class="bg-slate-800/60 p-3 rounded-lg border border-slate-700">
                        <div class="text-slate-400">Satellite Topics (${state.selectedGrade})</div>
                        <div class="text-xl font-bold text-cyan-400">${satelliteCount} (~20%)</div>
                    </div>
                     <div class="bg-slate-800/60 p-3 rounded-lg border border-slate-700">
                        <div class="text-slate-400">G4 New Syllabus Topics</div>
                        <div class="text-xl font-bold text-red-400">${g4NewCount}</div>
                    </div>
                </div>
            `;
        }

        function renderControls() {
            const strands = [...new Set(syllabusTopics.map(t => t.strand))];

             return `
                <div class="flex flex-col md:flex-row items-center justify-center gap-2 md:gap-4">
                    <div class="flex items-center p-1 rounded-lg bg-slate-800/70">
                        <button data-action="setViewMode" data-value="galaxy" class="py-2 px-4 rounded-md text-sm font-semibold transition-colors duration-300 flex items-center justify-center gap-2 ${state.viewMode === 'galaxy' ? 'bg-purple-600 text-white' : 'text-slate-300 hover:bg-slate-700'}">
                            ${icons.Circle} Galaxy View
                        </button>
                        <button data-action="setViewMode" data-value="matrix" class="py-2 px-4 rounded-md text-sm font-semibold transition-colors duration-300 flex items-center justify-center gap-2 ${state.viewMode === 'matrix' ? 'bg-purple-600 text-white' : 'text-slate-300 hover:bg-slate-700'}">
                            ${icons.Target} Exam Matrix
                        </button>
                    </div>
                    <div class="flex items-center p-1 rounded-lg bg-slate-800/70">
                        <button data-action="setGrade" data-value="G3" class="py-2 px-4 rounded-md text-sm font-semibold transition-colors duration-300 ${state.selectedGrade === 'G3' ? 'bg-indigo-600 text-white' : 'text-slate-300 hover:bg-slate-700'}">Context: G3</button>
                        <button data-action="setGrade" data-value="G4" class="py-2 px-4 rounded-md text-sm font-semibold transition-colors duration-300 ${state.selectedGrade === 'G4' ? 'bg-indigo-600 text-white' : 'text-slate-300 hover:bg-slate-700'}">Context: G4</button>
                    </div>
                </div>
                 <div class="flex flex-wrap items-center justify-center gap-2 text-xs font-medium">
                    <button data-action="setFilter" data-value="all" class="px-3 py-1.5 rounded-md ${state.filter === 'all' ? 'bg-blue-600 text-white' : 'bg-slate-700/80 text-slate-300 hover:bg-slate-600'}">All Strands</button>
                    ${strands.map(s => `<button data-action="setFilter" data-value="${s}" class="px-3 py-1.5 rounded-md ${state.filter === s ? 'bg-teal-600 text-white' : 'bg-slate-700/80 text-slate-300 hover:bg-slate-600'}">${s}</button>`).join('')}
                    <button data-action="setFilter" data-value="mastered" class="px-3 py-1.5 rounded-md ${state.filter === 'mastered' ? 'bg-green-600 text-white' : 'bg-slate-700/80 text-slate-300 hover:bg-slate-600'}">✓ Mastered (${state.masteredTopics.length})</button>
                </div>
            `;
        }
        
        function renderGalaxyView(filtered) {
            const strands = [...new Set(syllabusTopics.map(t => t.strand))];
            const clusterCenters = {
                Algebra: { x: 25, y: 28 },
                Geometry: { x: 75, y: 28 },
                Trigonometry: { x: 25, y: 72 },
                Statistics: { x: 75, y: 72 },
            };
            const clusterRadius = 18;

            const getPos = (topic, topicsInStrand) => {
                const center = clusterCenters[topic.strand];
                const totalInStrand = topicsInStrand.length;
                const idx = topicsInStrand.findIndex(t => t.id === topic.id);
                const a = (idx / totalInStrand) * 2 * Math.PI - (Math.PI / 2);
                return {
                    x: center.x + clusterRadius * Math.cos(a),
                    y: center.y + clusterRadius * Math.sin(a),
                };
            };

            let subtitle = `Displaying all ${syllabusTopics.length} Syllabus Topics`;
            if (state.filter !== 'all') {
                subtitle = `Displaying ${filtered.length} topics for the '${state.filter}' strand.`;
                 if(state.filter === 'mastered') {
                    subtitle = `Displaying ${filtered.length} Mastered Syllabus Topics`;
                }
            }

            const lines = filtered.map(t => {
                const topicsInTStrand = filtered.filter(f => f.strand === t.strand);
                const pos = getPos(t, topicsInTStrand);
                return t.pre.map(p => {
                    const pTopic = filtered.find(f => f.id === p);
                    if (!pTopic) return '';
                    const topicsInPStrand = filtered.filter(f => f.strand === pTopic.strand);
                    const ppos = getPos(pTopic, topicsInPStrand);
                    const hl = state.hoveredTopic === t.id || state.hoveredTopic === p;
                    return `<line class="transition-all" key="${p}-${t.id}" x1="${ppos.x}" y1="${ppos.y}" x2="${pos.x}" y2="${pos.y}" stroke="${hl ? '#60A5FA' : '#475569'}" stroke-width="${hl ? '0.4' : '0.2'}" opacity="${hl ? '0.9' : '0.4'}" />`;
                }).join('');
            }).join('');

            const nodes = strands.map(strand => {
                const topicsInStrand = filtered.filter(f => f.strand === strand);
                if (topicsInStrand.length === 0) return '';
                const center = clusterCenters[strand];

                return `
                    <text x="${center.x}" y="${center.y - clusterRadius - 4}" text-anchor="middle" font-size="3" font-weight="bold" class="fill-purple-300">${strand}</text>
                    ${topicsInStrand.map((t) => {
                        const pos = getPos(t, topicsInStrand);
                        const hov = state.hoveredTopic === t.id;
                        const sel = state.selectedTopic?.id === t.id;
                        const mas = state.masteredTopics.includes(t.id);
                        const sz = 2.5;

                        let hoverLabel = '';
                        if (hov) {
                            let labelY = pos.y + sz + 3; // Default: below the node
                            let textAnchor = 'middle';
        
                            if (pos.y > 85) { 
                                labelY = pos.y - sz - 2; 
                            }
                            
                            if (pos.x > 80) { 
                                textAnchor = 'end';
                            } else if (pos.x < 20) { 
                                textAnchor = 'start';
                            }
                            
                            hoverLabel = `<text x="${pos.x}" y="${labelY}" text-anchor="${textAnchor}" fill="white" font-size="1.8" font-weight="600">${t.name}</text>`;
                        }

                        return `
                            <g class="cursor-pointer" data-action="selectSyllabusTopic" data-id="${t.id}">
                                ${hov ? `<circle cx="${pos.x}" cy="${pos.y}" r="${sz + 1}" fill="${colors[t.type]}" opacity="0.3" class="animate-pulse" />` : ''}
                                <circle cx="${pos.x}" cy="${pos.y}" r="${hov ? sz * 1.2 : sz}" fill="${colors[t.type]}" stroke="${sel ? '#FFF' : mas ? '#10B981' : 'none'}" stroke-width="0.3" opacity="${mas ? '0.7' : '1'}" />
                                <text x="${pos.x}" y="${pos.y + 0.8}" text-anchor="middle" fill="${t.grade === 'G3' ? 'white' : '#111'}" font-size="1.5" font-weight="bold">${t.id.replace(t.strand.substring(0,3).toUpperCase(),'')}</text>
                                ${hoverLabel}
                            </g>
                        `;
                    }).join('')}
                `;
            }).join('');

            return `
                <div class="lg:col-span-2 bg-slate-800/50 rounded-2xl p-4 md:p-6 border border-slate-700">
                    <div class="mb-4 text-center">
                        <h4 class="text-lg font-semibold text-purple-300">Syllabus Topic Galaxy</h4>
                        <p class="text-sm text-slate-400">${subtitle}</p>
                    </div>
                    <div class="relative w-full" style="padding-bottom: 100%;">
                        <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100">
                            ${lines}
                            ${nodes}
                        </svg>
                    </div>
                    <div class="mt-2 space-y-4 text-sm">
                        ${renderLegend()}
                    </div>
                </div>`;
        }


        function renderLegend() {
            return `
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-3">
                    <div>
                        <div class="flex items-center gap-2 font-semibold mb-1">
                            <div class="w-4 h-4 rounded-full bg-red-500 flex-shrink-0"></div>
                            <span>${labels.new}</span>
                        </div>
                        <p class="text-xs text-slate-400 ml-6">A foundational, brand-new branch of mathematics.</p>
                    </div>
                     <div>
                        <div class="flex items-center gap-2 font-semibold mb-1">
                            <div class="w-4 h-4 rounded-full bg-yellow-500 flex-shrink-0"></div>
                            <span>${labels.strengthening}</span>
                        </div>
                        <p class="text-xs text-slate-400 ml-6">Increases the depth and complexity of a core skill.</p>
                    </div>
                    <div>
                        <div class="flex items-center gap-2 font-semibold mb-1">
                            <div class="w-4 h-4 rounded-full bg-orange-500 flex-shrink-0"></div>
                            <span>${labels.extending}</span>
                        </div>
                        <p class="text-xs text-slate-400 ml-6">Applies a known concept to a new context.</p>
                    </div>
                    <div>
                        <div class="flex items-center gap-2 font-semibold mb-1">
                            <div class="w-4 h-4 rounded-full bg-purple-500 flex-shrink-0"></div>
                            <span>${labels.integrative}</span>
                        </div>
                        <p class="text-xs text-slate-400 ml-6">Combines skills from multiple different topics.</p>
                    </div>
                </div>
            `;
        }

        function renderMatrixView() {
            const coreTopics = examTopics.filter(t => t.cat === 'core' && t.grade === state.selectedGrade);
            const satelliteTopics = examTopics.filter(t => t.cat === 'satellite' && t.grade === state.selectedGrade);
            return `
                 <div class="lg:col-span-2 bg-slate-800/50 rounded-2xl p-4 md:p-6 border border-slate-700 overflow-y-auto max-h-[80vh]">
                    <h3 class="text-2xl font-bold mb-4 text-purple-400">Exam Topics Matrix (${state.selectedGrade})</h3>
                    <div class="mb-6">
                        <h4 class="text-xl font-bold mb-3 text-yellow-400">🔥 Core — ~80%</h4>
                        ${coreTopics.map(renderExamTopicCard).join('')}
                    </div>
                    <div>
                        <h4 class="text-xl font-bold mb-3 text-cyan-400">📌 Satellite — ~20%</h4>
                        ${satelliteTopics.map(renderExamTopicCard).join('')}
                    </div>
                </div>
            `;
        }

        function renderExamTopicCard(t) {
             const isSelected = state.selectedExamTopic?.id === t.id;
             const ringColor = t.cat === 'core' ? 'ring-yellow-400' : 'ring-cyan-400';
             const isMastered = t.topics.every(tid => state.masteredTopics.includes(tid));
             return `
                <div data-action="selectExamTopic" data-id="${t.id}" class="rounded-lg p-3 mb-3 cursor-pointer transition-all hover:bg-slate-700/50 ${isSelected ? 'ring-2 ' + ringColor : ''} ${isMastered ? 'bg-green-900/40 border border-green-600/50' : 'bg-slate-700/30'}">
                    <div class="flex justify-between mb-2">
                        <div>
                             <h5 class="font-bold flex items-center gap-2">${t.num}. ${t.name} ${isMastered ? `<span class="text-green-400">${icons.CheckCircle.replace('width="12"','width="16"').replace('height="12"','height="16"')}</span>` : ''}</h5>
                            <div class="flex gap-2 mt-1">
                                ${t.topics.map(tid => `<button data-action="gotoSyllabus" data-id="${tid}" class="px-2 py-1 bg-slate-600 hover:bg-slate-500 rounded text-xs">${tid}</button>`).join('')}
                            </div>
                        </div>
                        <div class="text-sm font-bold text-yellow-300">${t.wt}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="flex items-center gap-2"><span class="text-blue-300">G3:</span>
                            <div class="flex-1 bg-slate-600 h-1 rounded"><div class="h-full bg-blue-500" style="width: ${t.g3f * 10}%"></div></div>
                            <span>${t.g3f}/10</span>
                        </div>
                        <div class="flex items-center gap-2"><span class="text-orange-300">G4:</span>
                            <div class="flex-1 bg-slate-600 h-1 rounded"><div class="h-full bg-orange-500" style="width: ${t.g4f * 10}%"></div></div>
                            <span>${t.g4f}/10</span>
                        </div>
                    </div>
                    <div class="text-xs text-purple-300 mt-2">🔄 ${t.prog}</div>
                </div>
             `;
        }

        function renderDetailsPanel() {
            if (state.selectedTopic) {
                const topic = state.selectedTopic;
                const isMastered = state.masteredTopics.includes(topic.id);
                
                let relatedArchetypesHtml = '';
                if (topic.relatedArchetypes && topic.relatedArchetypes.length > 0 && typeof ARCHETYPES_DATA !== 'undefined') {
                    const archetypes = topic.relatedArchetypes.map(id => ARCHETYPES_DATA.find(a => a.id === id)).filter(Boolean);
                    if (archetypes.length > 0) {
                        relatedArchetypesHtml = `
                        <div class="bg-slate-700/50 rounded-lg p-4 fade-in">
                            <h5 class="font-semibold text-sm text-purple-300 mb-3 flex items-center gap-2">${icons.Cpu} Related Archetypes</h5>
                            <div class="space-y-2">
                                ${archetypes.map(arch => `
                                    <details class="bg-slate-800 rounded-lg overflow-hidden transition-all duration-300">
                                        <summary class="p-2 cursor-pointer hover:bg-slate-700 flex justify-between items-center text-xs">
                                            <div>
                                                <div class="font-bold text-slate-200">${arch.id}</div>
                                                <div class="text-slate-400">${arch.name}</div>
                                            </div>
                                            <span class="text-slate-500 text-xs px-2 arrow">▶</span>
                                        </summary>
                                        <div class="p-3 border-t border-slate-700 text-xs space-y-3 bg-slate-900/50">
                                            ${arch.sop?.goal ? `<p><strong class="text-purple-300">Goal:</strong> ${arch.sop.goal}</p>` : ''}
                                            ${arch.sop?.steps ? `
                                            <div>
                                                <strong class="text-purple-300">Steps:</strong>
                                                <ol class="list-decimal list-inside text-slate-300 pl-2 mt-1 space-y-1">
                                                    ${arch.sop.steps.map(step => `<li>${step.replace(/^(\\d+\\.\\s*)/, '')}</li>`).join('')}
                                                </ol>
                                            </div>
                                            ` : ''}
                                            ${arch.sop?.pitfalls ? `
                                            <div>
                                                <strong class="text-red-400">Pitfalls:</strong>
                                                <ul class="list-disc list-inside text-slate-300 pl-2 mt-1 space-y-1">
                                                    ${arch.sop.pitfalls.map(p => `<li><strong>${p.type}:</strong> ${p.text}</li>`).join('')}
                                                </ul>
                                            </div>
                                            ` : ''}
                                            ${arch.sop?.pro_tips ? `
                                            <div>
                                                <strong class="text-green-400">Pro Tips:</strong>
                                                <ul class="list-disc list-inside text-slate-300 pl-2 mt-1 space-y-1">
                                                    ${arch.sop.pro_tips.map(tip => `<li>${tip}</li>`).join('')}
                                                </ul>
                                            </div>
                                            ` : ''}
                                            ${!arch.sop ? `<p class="text-slate-400">No detailed SOP data available.</p>` : ''}
                                        </div>
                                    </details>
                                `).join('')}
                            </div>
                        </div>
                        `;
                    }
                }

                return `
                    <div class="space-y-4">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-2xl font-bold text-blue-400">${topic.id}</h3>
                                <button data-action="toggleMastery" class="px-3 py-1 rounded-full text-xs font-medium flex items-center gap-1.5 transition-colors ${isMastered ? 'bg-green-600 text-white' : 'bg-slate-700 hover:bg-slate-600'}">
                                    ${isMastered ? `${icons.CheckCircle} Mastered` : 'Mark as Mastered'}
                                </button>
                            </div>
                            <h4 class="text-xl font-semibold mb-2">${topic.name}</h4>
                            <div class="px-3 py-1 rounded-lg text-sm font-medium inline-block" style="background-color: ${colors[topic.type]}20; color: ${colors[topic.type]}">
                                ${labels[topic.type]}
                            </div>
                        </div>
                        
                        ${relatedArchetypesHtml}

                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <h5 class="font-semibold text-sm text-blue-300 mb-2 flex items-center gap-2">${icons.BookOpen} G3 Content</h5>
                            <p class="text-sm">${topic.grade === 'G3' ? 'This is a G3 Topic.' : 'No specific G3 content.'}</p>
                        </div>
                        <div class="flex justify-center text-yellow-400">${icons.ArrowRight}</div>
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <h5 class="font-semibold text-sm text-orange-300 mb-2 flex items-center gap-2">${icons.TrendingUp} G4 Content</h5>
                             <p class="text-sm">${topic.grade === 'G4' ? 'This is a G4 Topic.' : 'Content extends into G4.'}</p>
                        </div>
                    </div>
                `;
            } else if (state.selectedExamTopic) {
                const topic = state.selectedExamTopic;
                let relatedArchetypesHtml = '';
                if (topic.relatedArchetypes && topic.relatedArchetypes.length > 0 && typeof ARCHETYPES_DATA !== 'undefined') {
                    const archetypes = topic.relatedArchetypes.map(id => ARCHETYPES_DATA.find(a => a.id === id)).filter(Boolean);
                    if (archetypes.length > 0) {
                        relatedArchetypesHtml = `
                        <div class="bg-slate-700/50 rounded-lg p-4 fade-in">
                            <h5 class="font-semibold text-sm text-purple-300 mb-3 flex items-center gap-2">${icons.Cpu} Related Archetypes</h5>
                            <div class="space-y-2">
                                ${archetypes.map(arch => `
                                    <details class="bg-slate-800 rounded-lg overflow-hidden transition-all duration-300">
                                        <summary class="p-2 cursor-pointer hover:bg-slate-700 flex justify-between items-center text-xs">
                                            <div>
                                                <div class="font-bold text-slate-200">${arch.id}</div>
                                                <div class="text-slate-400">${arch.name}</div>
                                            </div>
                                            <span class="text-slate-500 text-xs px-2 arrow">▶</span>
                                        </summary>
                                        <div class="p-3 border-t border-slate-700 text-xs space-y-3 bg-slate-900/50">
                                            ${arch.sop?.goal ? `<p><strong class="text-purple-300">Goal:</strong> ${arch.sop.goal}</p>` : ''}
                                            ${arch.sop?.steps ? `
                                            <div>
                                                <strong class="text-purple-300">Steps:</strong>
                                                <ol class="list-decimal list-inside text-slate-300 pl-2 mt-1 space-y-1">
                                                    ${arch.sop.steps.map(step => `<li>${step.replace(/^(\\d+\\.\\s*)/, '')}</li>`).join('')}
                                                </ol>
                                            </div>
                                            ` : ''}
                                            ${arch.sop?.pitfalls ? `
                                            <div>
                                                <strong class="text-red-400">Pitfalls:</strong>
                                                <ul class="list-disc list-inside text-slate-300 pl-2 mt-1 space-y-1">
                                                    ${arch.sop.pitfalls.map(p => `<li><strong>${p.type}:</strong> ${p.text}</li>`).join('')}
                                                </ul>
                                            </div>
                                            ` : ''}
                                            ${arch.sop?.pro_tips ? `
                                            <div>
                                                <strong class="text-green-400">Pro Tips:</strong>
                                                <ul class="list-disc list-inside text-slate-300 pl-2 mt-1 space-y-1">
                                                    ${arch.sop.pro_tips.map(tip => `<li>${tip}</li>`).join('')}
                                                </ul>
                                            </div>
                                            ` : ''}
                                            ${!arch.sop ? `<p class="text-slate-400">No detailed SOP data available.</p>` : ''}
                                        </div>
                                    </details>
                                `).join('')}
                            </div>
                        </div>
                        `;
                    }
                }

                 return `
                     <div class="space-y-4">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-3 py-1 rounded-full text-xs font-bold ${topic.cat === 'core' ? 'bg-yellow-600' : 'bg-cyan-600'}">
                                    ${topic.cat === 'core' ? '🔥 CORE' : '📌 SATELLITE'}
                                </span>
                                <span class="text-lg font-bold text-purple-300">${topic.wt}</span>
                            </div>
                            <h3 class="text-2xl font-bold">${topic.num}. ${topic.name}</h3>
                        </div>
                        
                        ${relatedArchetypesHtml}

                        <div class="bg-blue-900/20 rounded-lg p-4 border border-blue-500/30">
                            <h5 class="font-semibold text-sm text-blue-300 mb-2">Related Syllabus Topics</h5>
                            <div class="flex flex-wrap gap-2">
                                ${topic.topics.map(tid => {
                                    const st = syllabusTopics.find(t => t.id === tid);
                                    if (!st) return '';
                                    const isMastered = state.masteredTopics.includes(st.id);
                                    return `
                                        <button data-action="gotoSyllabus" data-id="${st.id}" class="p-2 bg-slate-700 hover:bg-slate-600 rounded text-xs text-left w-full flex items-center justify-between">
                                            <div>
                                                <div class="font-semibold text-white">${st.id}: ${st.name}</div>
                                                <div style="color: ${colors[st.type]}">${labels[st.type]}</div>
                                            </div>
                                            ${isMastered ? `<span class="text-green-400">${icons.CheckCircle.replace('width="12"','width="16"').replace('height="12"','height="16"')}</span>` : ''}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-blue-900/20 rounded p-3 border border-blue-500/30">
                                <div class="text-xs text-blue-300 font-semibold mb-2">G3 Focus</div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 bg-slate-600 h-2 rounded"><div class="h-full bg-blue-500" style="width: ${topic.g3f * 10}%"></div></div>
                                    <span class="text-xs">${topic.g3f}/10</span>
                                </div>
                            </div>
                            <div class="bg-orange-900/20 rounded p-3 border border-orange-500/30">
                                <div class="text-xs text-orange-300 font-semibold mb-2">G4 Focus</div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 bg-slate-600 h-2 rounded"><div class="h-full bg-orange-500" style="width: ${topic.g4f * 10}%"></div></div>
                                    <span class="text-xs">${topic.g4f}/10</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-purple-900/20 rounded-lg p-3 border border-purple-500/30">
                            <div class="text-xs font-semibold text-purple-300 mb-1">🔄 Progression</div>
                            <div class="text-sm">${topic.prog}</div>
                        </div>
                    </div>
                `;
            } else if (state.filter === 'mastered' && state.masteredTopics.length === 0) {
                 return `
                    <div class="h-full flex flex-col items-center justify-center text-center text-slate-400">
                        <div class="text-green-500 opacity-50 mb-4">${icons.CheckCircle.replace('width="12"','width="48"').replace('height="12"','height="48"')}</div>
                        <p class="text-lg font-medium mb-2">No Mastered Topics Yet</p>
                        <p class="text-sm">Click a topic in the Galaxy to mark it as mastered.</p>
                    </div>`;
            } else {
                return `
                    <div class="h-full flex flex-col items-center justify-center text-center text-slate-400 p-4">
                        <div class="opacity-60 mb-4 text-purple-400">${icons.Sparkles.replace('width="48"','width="64"').replace('height="48"','height="64"')}</div>
                        <h3 class="text-xl font-bold mb-3 text-slate-200">Welcome to the E-Math Galaxy!</h3>
                        <div class="bg-slate-700/50 rounded-lg p-4 w-full text-sm mb-4">
                            <div class="grid grid-cols-3 divide-x divide-slate-600 text-center">
                                <div>
                                    <div class="font-bold text-lg text-blue-300">${syllabusTopics.length}</div>
                                    <div class="text-xs text-slate-400">Syllabus Topics</div>
                                </div>
                                <div>
                                    <div class="font-bold text-lg text-yellow-300">${examTopics.filter(t=>t.grade==='G3').length}</div>
                                    <div class="text-xs text-slate-400">G3 Exam Topics</div>
                                </div>
                                <div>
                                    <div class="font-bold text-lg text-orange-300">${examTopics.filter(t=>t.grade==='G4').length}</div>
                                    <div class="text-xs text-slate-400">G4 Exam Topics</div>
                                </div>
                            </div>
                        </div>
                        <div class="text-left text-slate-300 space-y-2 text-sm w-full">
                            <p class="font-semibold text-slate-200">How to use this tool:</p>
                            <p><strong>1. Explore the Galaxy:</strong> Click any node (e.g., ALG1) to see details.</p>
                            <p><strong>2. Analyze the Matrix:</strong> Switch to "Exam Matrix" to see how topics are tested.</p>
                            <p><strong>3. Track Progress:</strong> Mark topics as "Mastered" to track your learning.</p>
                        </div>
                    </div>
                `;
            }
        }
        
        // --- EVENT HANDLING ---
        function addEventListeners() {
            // Setup persistent event listeners using delegation on the main app container
            const app = document.getElementById('app');
            if (app) {
                // We clear old listeners just in case, though with innerHTML rewrite this is redundant
                // But it's safer if we ever change render() to be partial.
                // A better way is to attach listeners *once* in initializeApp.
            }
        }

        function handleInteraction(e) {
            const target = e.target;
            const actionTarget = target.closest('[data-action]');
            
            if (!actionTarget) return;

            e.stopPropagation();
            const { action, value, id } = actionTarget.dataset;

            switch (action) {
                case 'setViewMode':
                    state.viewMode = value;
                    break;
                case 'setGrade':
                    state.selectedGrade = value;
                    break;
                case 'setFilter':
                    state.filter = value;
                    state.viewMode = 'galaxy';
                    break;
                case 'selectSyllabusTopic':
                    state.selectedTopic = syllabusTopics.find(t => t.id === id);
                    state.selectedExamTopic = null;
                    break;
                case 'selectExamTopic':
                    state.selectedExamTopic = examTopics.find(t => t.id === id);
                    state.selectedTopic = null;
                    break;
                case 'gotoSyllabus':
                    state.selectedTopic = syllabusTopics.find(s => s.id === id);
                    state.selectedExamTopic = null;
                    state.viewMode = 'galaxy';
                    break;
                case 'toggleMastery':
                    if (state.selectedTopic) {
                        const topicId = state.selectedTopic.id;
                        if (state.masteredTopics.includes(topicId)) {
                            state.masteredTopics = state.masteredTopics.filter(id => id !== topicId);
                        } else {
                            state.masteredTopics.push(topicId);
                        }
                        localStorage.setItem('masteredTopics', JSON.stringify(state.masteredTopics));
                    }
                    break;
            }
            render();
        }

        function handleHover(e) {
            const hoverTarget = e.target.closest('g[data-action="selectSyllabusTopic"]');
            if (hoverTarget) {
                if (state.hoveredTopic !== hoverTarget.dataset.id) {
                    state.hoveredTopic = hoverTarget.dataset.id;
                    render();
                }
            } else {
                if (state.hoveredTopic !== null) {
                    state.hoveredTopic = null;
                    render();
                }
            }
        }

        // --- UTILS ---
        function getFilteredSyllabusTopics() {
            if (typeof syllabusTopics === 'undefined') return [];
            
            return syllabusTopics.filter(t => {
                if (state.filter === 'all') return true;
                if (state.filter === 'mastered') return state.masteredTopics.includes(t.id);
                if (['Algebra', 'Geometry', 'Trigonometry', 'Statistics'].includes(state.filter)) {
                    return t.strand === state.filter;
                }
                return true;
            });
        }
        
        // --- INITIALIZATION ---
        function initializeApp() {
            const app = document.getElementById('app');
            if (!app) {
                // This is the critical error. We must wait for the DOM to be ready.
                console.error('Fatal Error: #app element not found during initialization.');
                return;
            }
            
            if (typeof syllabusTopics === 'undefined' || typeof examTopics === 'undefined' || typeof ARCHETYPES_DATA === 'undefined') {
                app.innerHTML = `<div class="text-center text-red-400 p-8"><strong>Error:</strong> Data variables (syllabusTopics, examTopics, or ARCHETYPES_DATA) are not defined. The application cannot start.</div>`;
                return;
            }

            // Augment examTopics with related archetypes
            examTopics.forEach(examTopic => {
                const relatedArchetypeIds = new Set();
                examTopic.topics.forEach(syllabusTopicId => {
                    const syllabusTopic = syllabusTopics.find(st => st.id === syllabusTopicId);
                    if (syllabusTopic && syllabusTopic.relatedArchetypes) {
                        syllabusTopic.relatedArchetypes.forEach(archId => {
                            relatedArchetypeIds.add(archId);
                        });
                    }
                });
                examTopic.relatedArchetypes = [...relatedArchetypeIds];
            });


            const savedMastery = localStorage.getItem('masteredTopics');
            if (savedMastery) {
                try {
                    const parsed = JSON.parse(savedMastery);
                    if (Array.isArray(parsed)) state.masteredTopics = parsed;
                } catch (e) {
                    console.error("Could not parse mastered topics from localStorage", e);
                }
            }
            
            // Setup persistent event listeners using delegation on the main app container
            app.addEventListener('click', handleInteraction);
            app.addEventListener('mouseover', handleHover);
            
            render(); // Initial render
        }

        // Use 'DOMContentLoaded' to ensure the DOM is ready before the script runs.
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>

