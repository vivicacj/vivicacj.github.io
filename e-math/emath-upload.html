<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Math Link Library (Cloud Sync)</title>
    <!-- Firebase SDKs -->
      <!-- Firebase v9+ (Êõ¥Êñ∞ÁöÑËØ≠Ê≥ï) -->
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: #f4f7f9; min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 30px; text-align: center; border-radius: 20px 20px 0 0; position: relative; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); display: flex; align-items: center; justify-content: center; gap: 15px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .sync-status { position: absolute; top: 15px; right: 20px; font-size: 0.9em; font-weight: 600; background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; }
        .user-info { position: absolute; top: 15px; left: 20px; font-size: 0.9em; background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; }
        .content { padding: 30px; background: white; border-radius: 0 0 20px 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1); }
        .section-title { font-size: 1.5em; color: #343a40; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .section-title i { font-style: normal; color: #4facfe; }
        
        /* Auth Styles */
        .auth-container { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1); text-align: center; }
        .auth-title { font-size: 2em; color: #343a40; margin-bottom: 20px; }
        .auth-subtitle { color: #6c757d; margin-bottom: 30px; }
        .auth-input { width: 100%; max-width: 300px; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; margin: 10px auto; display: block; font-size: 1em; }
        .auth-input:focus { outline: none; border-color: #4facfe; box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1); }
        .auth-btn { padding: 12px 30px; background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: 600; margin: 10px; transition: all 0.3s ease; }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4); }
        .auth-btn.secondary { background: #6c757d; }
        .auth-error { color: #e74c3c; margin-top: 15px; font-size: 0.9em; }
        .hidden { display: none; }

        .add-link-section { background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 30px; }
        .link-input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .input-field { width: 100%; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1em; transition: all 0.3s ease; }
        .input-field:focus { outline: none; border-color: #4facfe; box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1); }
        .notes-field { grid-column: 1 / -1; }
        .add-btn { padding: 12px 25px; background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s ease; white-space: nowrap; grid-column: 1 / -1; }
        .add-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4); }
        .logout-btn { position: absolute; top: 50px; left: 20px; padding: 8px 15px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 0.8em; }

        .files-list { margin-top: 30px; }
        .link-item { background: white; border: 1px solid #e9ecef; border-radius: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); }
        .link-item:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1); }
        .link-anchor { flex-grow: 1; display: flex; align-items: center; gap: 15px; padding: 20px; text-decoration: none; color: inherit; }
        .link-icon { width: 45px; height: 45px; background: linear-gradient(135deg, #4facfe, #00f2fe); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0; font-size: 1.2em; }
        .link-details { display: flex; flex-direction: column; min-width: 0; }
        .link-name { font-weight: 600; font-size: 1.1em; color: #343a40; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .link-notes { font-size: 0.9em; color: #6c757d; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 8px; }
        .upload-date { font-size: 0.8em; color: #adb5bd; }

        .remove-btn { background: #e74c3c; color: white; border: none; padding: 10px 18px; border-radius: 0 12px 12px 0; cursor: pointer; font-size: 0.9em; transition: all 0.3s ease; align-self: stretch; border-left: 1px solid #e9ecef; }
        .remove-btn:hover { background: #c0392b; }

        .empty-state { text-align: center; color: #6c757d; font-style: italic; padding: 30px; }
        .link-type-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .link-type-btn { padding: 8px 18px; border: 2px solid #e9ecef; background: white; border-radius: 25px; cursor: pointer; font-size: 0.9em; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .link-type-btn.active { background: #4facfe; color: white; border-color: #4facfe; }
        .link-type-btn:hover:not(.active) { border-color: #4facfe; }
    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div id="authContainer" class="container">
        <div class="auth-container">
            <h2 class="auth-title">üîó E-Math Link Library</h2>
            <p class="auth-subtitle">Sign in to sync your links across all devices</p>
            <input type="email" id="authEmail" class="auth-input" placeholder="Enter your email">
            <input type="password" id="authPassword" class="auth-input" placeholder="Enter your password">
            <div>
                <button onclick="signIn()" class="auth-btn">Sign In</button>
                <button onclick="signUp()" class="auth-btn secondary">Sign Up</button>
            </div>
            <div id="authError" class="auth-error"></div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="mainAppContainer" class="container hidden">
        <div class="header">
            <h1>üîó E-Math Link Library</h1>
            <p>Real-time sync for all your learning resources</p>
            <div id="userInfo" class="user-info">üë§ Loading...</div>
            <div id="syncStatus" class="sync-status">‚ö™Ô∏è Connecting...</div>
            <button onclick="signOut()" class="logout-btn">Sign Out</button>
        </div>
        
        <div class="content">
            <div class="add-link-section">
                <div class="section-title"><i>üîó</i> Add New Link</div>
                <div class="link-type-buttons">
                    <button class="link-type-btn active" data-type="notion">üìù Notion</button>
                    <button class="link-type-btn" data-type="google-doc">üìÑ Google Docs</button>
                    <button class="link-type-btn" data-type="google-sheet">üìä Google Sheets</button>
                    <button class="link-type-btn" data-type="google-slide">üìΩÔ∏è Google Slides</button>
                    <button class="link-type-btn" data-type="other">üåê Other</button>
                </div>
                <div class="link-input-group">
                    <input type="text" class="input-field" id="linkName" placeholder="Link Name (e.g., Quadratic Functions Cheatsheet)">
                    <input type="url" class="input-field" id="linkUrl" placeholder="Link URL (e.g., https://notion.so/...)">
                    <input type="text" class="input-field notes-field" id="linkNotes" placeholder="Notes (Optional, e.g., 'For exam prep')">
                </div>
                 <button class="add-btn" onclick="addLink()">+ Add Link</button>
            </div>

            <div class="files-list">
                <div class="section-title"><i>üìã</i> Cloud Link Library</div>
                <div id="linksList">
                    <div class="empty-state">Loading from cloud...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDdtQYfOC87IvpTZPFoDyb6ZgpEISzqw_I",
            authDomain: "emath-study-plan.firebaseapp.com",
            projectId: "emath-study-plan",
            storageBucket: "emath-study-plan.firebasestorage.app",
            messagingSenderId: "589299697460",
            appId: "1:589299697460:web:df1e0bb0586b3740c04761",
            measurementId: "G-09QVE4GLS0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let user = null;
        let linksRef = null;
        let selectedLinkType = 'notion';
        let unsubscribe = null;

        // --- 2. AUTHENTICATION ---
        function signIn() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            const errorEl = document.getElementById('authError');
            
            if (!email || !password) {
                errorEl.textContent = 'Please enter both email and password.';
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error('Sign in error:', error);
                    errorEl.textContent = error.message;
                });
        }

        function signUp() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            const errorEl = document.getElementById('authError');
            
            if (!email || !password) {
                errorEl.textContent = 'Please enter both email and password.';
                return;
            }
            
            if (password.length < 6) {
                errorEl.textContent = 'Password must be at least 6 characters.';
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error('Sign up error:', error);
                    errorEl.textContent = error.message;
                });
        }

        function signOut() {
            auth.signOut();
        }

        // --- 3. AUTH STATE LISTENER ---
        auth.onAuthStateChanged(async firebaseUser => {
            const authContainer = document.getElementById('authContainer');
            const mainAppContainer = document.getElementById('mainAppContainer');
            const userInfo = document.getElementById('userInfo');
            
            if (unsubscribe) unsubscribe();
            
            if (firebaseUser) {
                user = firebaseUser;
                linksRef = db.collection('userLinks').doc(user.uid);
                
                authContainer.classList.add('hidden');
                mainAppContainer.classList.remove('hidden');
                userInfo.textContent = `üë§ ${user.email}`;
                
                // Check and create user document if needed
                try {
                    const docSnap = await linksRef.get();
                    const docExists = typeof docSnap.exists === 'function' ? docSnap.exists() : docSnap.exists;
                    
                    if (!docExists) {
                        console.log("New user, creating initial document");
                        await linksRef.set({ list: [] });
                        console.log("Initial document created");
                    }
                } catch (error) {
                    console.error("Error checking/creating user document:", error);
                }
                
                listenToLinks();
            } else {
                user = null;
                linksRef = null;
                authContainer.classList.remove('hidden');
                mainAppContainer.classList.add('hidden');
                document.getElementById('linksList').innerHTML = '<div class="empty-state">Loading from cloud...</div>';
            }
        });

        // --- 4. ÂÆûÊó∂ÁõëÂê¨‰∏éÊ∏≤Êüì ---
        function listenToLinks() {
            const syncStatus = document.getElementById('syncStatus');
            
            if (!linksRef) return;
            
            unsubscribe = linksRef.onSnapshot(doc => {
                const docExists = typeof doc.exists === 'function' ? doc.exists() : doc.exists;
                const linksData = (docExists && doc.data().list) ? doc.data().list : [];
                renderLinks(linksData);
                syncStatus.textContent = 'üü¢ Synced';
                console.log("Links loaded from Firebase:", linksData);
            }, error => {
                console.error("Error listening to links:", error);
                syncStatus.textContent = 'üî¥ Error';
            });
        }

        function renderLinks(links) {
            const listEl = document.getElementById('linksList');
            if (links.length === 0) {
                listEl.innerHTML = '<div class="empty-state">No links added yet.</div>';
                return;
            }
            listEl.innerHTML = links.sort((a, b) => b.uploadDate - a.uploadDate).map(link => `
                <div class="link-item">
                    <a class="link-anchor" href="${link.url}" target="_blank" title="${link.url}">
                        <div class="link-icon">${getLinkIcon(link.type)}</div>
                        <div class="link-details">
                            <div class="link-name">${link.name}</div>
                            ${link.notes ? `<div class="link-notes">${link.notes}</div>` : ''}
                            <div class="upload-date">Added on: ${new Date(link.uploadDate).toLocaleDateString()}</div>
                        </div>
                    </a>
                    <button class="remove-btn" onclick="removeLink('${link.id}')">Remove</button>
                </div>
            `).join('');
        }
        
        // --- 5. Ê∑ªÂä†ÈÄªËæë ---
        function addLink() {
            if (!user || !linksRef) {
                alert('Please sign in first');
                return;
            }
            
            const nameInput = document.getElementById('linkName');
            const urlInput = document.getElementById('linkUrl');
            const notesInput = document.getElementById('linkNotes');
            
            const name = nameInput.value.trim();
            const url = urlInput.value.trim();
            const notes = notesInput.value.trim();
            
            if (!name || !url || !isValidUrl(url)) {
                alert('Please enter a valid Name and URL.');
                return;
            }

            const linkData = {
                id: `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                name: name,
                url: url,
                type: selectedLinkType,
                notes: notes,
                uploadDate: Date.now()
            };

            linksRef.update({
                list: firebase.firestore.FieldValue.arrayUnion(linkData)
            }).then(() => {
                console.log("Link added successfully");
                nameInput.value = '';
                urlInput.value = '';
                notesInput.value = '';
            }).catch(err => {
                console.error("Error adding link:", err);
                if (err.code === 'not-found' || err.message.includes("No document to update")) {
                    linksRef.set({ list: [linkData] }).then(() => {
                        console.log("Link added with new document");
                        nameInput.value = '';
                        urlInput.value = '';
                        notesInput.value = '';
                    });
                }
            });
        }
        
        // --- 6. Âà†Èô§ÈÄªËæë ---
        async function removeLink(linkId) {
            if (!user || !linksRef) {
                alert('Please sign in first');
                return;
            }
            
            if (!confirm("Are you sure you want to remove this link from the cloud?")) return;
            
            try {
                const doc = await linksRef.get();
                const docExists = typeof doc.exists === 'function' ? doc.exists() : doc.exists;
                
                if (docExists) {
                    const currentList = doc.data().list || [];
                    const itemToRemove = currentList.find(l => l.id === linkId);
                    if (itemToRemove) {
                        await linksRef.update({
                            list: firebase.firestore.FieldValue.arrayRemove(itemToRemove)
                        });
                        console.log("Link removed successfully");
                    }
                }
            } catch (error) {
                console.error("Error removing link:", error);
                alert("Failed to remove link. See console for details.");
            }
        }

        // --- 7. ËæÖÂä©ÂáΩÊï∞ ---
        document.addEventListener('DOMContentLoaded', () => {
            // Link type buttons
            document.querySelectorAll('.link-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.link-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedLinkType = this.dataset.type;
                    const urlInput = document.getElementById('linkUrl');
                    const placeholders = {
                        'notion': 'Notion Page URL (e.g., https://notion.so/...)',
                        'google-doc': 'Google Docs URL (e.g., https://docs.google.com/document/...)',
                        'google-sheet': 'Google Sheets URL (e.g., https://docs.google.com/spreadsheets/...)',
                        'google-slide': 'Google Slides URL (e.g., https://docs.google.com/presentation/...)',
                        'other': 'Enter any valid URL'
                    };
                    urlInput.placeholder = placeholders[selectedLinkType];
                });
            });

            // Enter key handlers
            document.getElementById('authEmail').addEventListener('keypress', (e) => { 
                if (e.key === 'Enter') signIn(); 
            });
            document.getElementById('authPassword').addEventListener('keypress', (e) => { 
                if (e.key === 'Enter') signIn(); 
            });
            document.getElementById('linkUrl').addEventListener('keypress', (e) => { 
                if (e.key === 'Enter') addLink(); 
            });
        });

        function isValidUrl(url) { 
            try { 
                new URL(url); 
                return true; 
            } catch { 
                return false; 
            } 
        }

        function getLinkIcon(type) { 
            switch(type) { 
                case 'notion': return 'üìù'; 
                case 'google-doc': return 'üìÑ'; 
                case 'google-sheet': return 'üìä'; 
                case 'google-slide': return 'üìΩÔ∏è'; 
                default: return 'üåê'; 
            } 
        }
    </script>
</body>
</html>
