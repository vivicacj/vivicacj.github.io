<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Math 链接资料库 (云同步)</title>
    <!-- 只需要 Firestore -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .sync-status { position: absolute; top: 15px; right: 20px; font-size: 0.9em; font-weight: 600; background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; }
        .content { padding: 40px; }
        .section-title { font-size: 1.5em; color: #343a40; margin-bottom: 20px; display: flex; align-items: center; }
        .section-title::before { content: ''; width: 4px; height: 25px; background: linear-gradient(135deg, #4facfe, #00f2fe); margin-right: 15px; border-radius: 2px; }
        .link-input-group { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .input-field { flex: 1; min-width: 200px; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1em; transition: all 0.3s ease; }
        .input-field:focus { outline: none; border-color: #4facfe; box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1); }
        .add-btn { padding: 12px 25px; background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s ease; white-space: nowrap; }
        .add-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4); }
        .files-list { margin-top: 30px; }
        .link-item { background: white; border: 1px solid #e9ecef; border-radius: 10px; padding: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); }
        .link-item:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1); }
        .link-info { display: flex; align-items: center; gap: 15px; overflow: hidden; }
        .link-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #4facfe, #00f2fe); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0; }
        .link-details { display: flex; flex-direction: column; min-width: 0; }
        .link-name { font-weight: 600; color: #343a40; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .link-url { font-size: 0.9em; color: #6c757d; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .remove-btn { background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9em; transition: all 0.3s ease; flex-shrink: 0; }
        .remove-btn:hover { background: #c82333; transform: translateY(-1px); }
        .empty-state { text-align: center; color: #6c757d; font-style: italic; padding: 30px; }
        .link-type-buttons { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .link-type-btn { padding: 8px 16px; border: 2px solid #e9ecef; background: white; border-radius: 25px; cursor: pointer; font-size: 0.9em; transition: all 0.3s ease; }
        .link-type-btn.active { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; border-color: #4facfe; }
        .link-type-btn:hover { border-color: #4facfe; transform: translateY(-1px); }
        .upload-date { font-size: 0.8em; color: #adb5bd; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔗 E-Math 链接资料库 (云同步)</h1>
            <p>实时同步您和 Dennis 的所有学习链接</p>
            <div id="syncStatus" class="sync-status">⚪️ Connecting...</div>
        </div>
        
        <div class="content">
            <div class="links-section">
                <div class="section-title">🔗 添加新链接</div>
                <div class="link-type-buttons">
                    <button class="link-type-btn active" data-type="notion">📝 Notion</button>
                    <button class="link-type-btn" data-type="google-doc">📄 Google Docs</button>
                    <button class="link-type-btn" data-type="google-sheet">📊 Google Sheets</button>
                    <button class="link-type-btn" data-type="google-slide">📽️ Google Slides</button>
                    <button class="link-type-btn" data-type="other">🌐 其他链接</button>
                </div>
                <div class="link-input-group">
                    <input type="text" class="input-field" id="linkName" placeholder="链接名称 (例如：二次函数错题集)">
                    <input type="url" class="input-field" id="linkUrl" placeholder="Notion页面链接 (例如：https://notion.so/...)">
                    <button class="add-btn" onclick="addLink()">➕ 添加链接</button>
                </div>
            </div>

            <div class="files-list">
                <div class="section-title">📋 云端链接列表</div>
                <div id="linksList">
                    <div class="empty-state">正在从云端加载...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDdtQYfOC87IvpTZPFoDyb6ZgpEISzqw_I",
            authDomain: "emath-study-plan.firebaseapp.com",
            projectId: "emath-study-plan",
            storageBucket: "emath-study-plan.firebasestorage.app", // This is okay to keep, won't be used
            messagingSenderId: "589299697460",
            appId: "1:589299697460:web:df1e0bb0586b3740c04761",
            measurementId: "G-09QVE4GLS0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const linksRef = db.collection("emath-uploads").doc("links"); // Only need a reference for links

        let selectedLinkType = 'notion';

        // --- 2. 实时监听与渲染 ---
        function listenToLinks() {
            const syncStatus = document.getElementById('syncStatus');
            linksRef.onSnapshot(doc => {
                const linksData = (doc.exists && doc.data().list) ? doc.data().list : [];
                renderLinks(linksData);
                syncStatus.textContent = '🟢 Synced';
            }, error => {
                console.error("Error listening to links:", error);
                syncStatus.textContent = '🔴 Error';
            });
        }

        function renderLinks(links) {
            const listEl = document.getElementById('linksList');
            if (links.length === 0) {
                listEl.innerHTML = '<div class="empty-state">暂无云端链接</div>';
                return;
            }
            listEl.innerHTML = links.sort((a, b) => b.uploadDate - a.uploadDate).map(link => `
                <div class="link-item">
                    <div class="link-info">
                        <div class="link-icon">${getLinkIcon(link.type)}</div>
                        <div class="link-details">
                            <a class="link-name" href="${link.url}" target="_blank" title="${link.name}">${link.name}</a>
                            <div class="link-url" title="${link.url}">${link.url}</div>
                            <div class="upload-date">Added on: ${new Date(link.uploadDate).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <button class="remove-btn" onclick="removeLink('${link.id}')">删除</button>
                </div>
            `).join('');
        }
        
        // --- 3. 添加逻辑 ---
        function addLink() {
            const nameInput = document.getElementById('linkName');
            const urlInput = document.getElementById('linkUrl');
            const name = nameInput.value.trim();
            const url = urlInput.value.trim();
            
            if (!name || !url || !isValidUrl(url)) {
                alert('请填写有效且完整的链接信息！');
                return;
            }

            const linkData = {
                id: `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                name: name,
                url: url,
                type: selectedLinkType,
                uploadDate: Date.now()
            };

            // 使用 arrayUnion atomically add a new region to the "regions" array field.
            linksRef.update({
                list: firebase.firestore.FieldValue.arrayUnion(linkData)
            }).catch(err => {
                // If the document or 'list' field doesn't exist, set it.
                if (err.code === 'not-found' || err.message.includes("No document to update")) {
                    linksRef.set({ list: [linkData] });
                }
            });

            nameInput.value = '';
            urlInput.value = '';
        }
        
        // --- 4. 删除逻辑 ---
        async function removeLink(linkId) {
            if (!confirm("确定要从云端删除这个链接吗？")) return;
            try {
                const doc = await linksRef.get();
                if (doc.exists) {
                    const currentList = doc.data().list || [];
                    const itemToRemove = currentList.find(l => l.id === linkId);
                    if (itemToRemove) {
                        // Use arrayRemove to atomically remove an instance in an array field.
                        await linksRef.update({
                            list: firebase.firestore.FieldValue.arrayRemove(itemToRemove)
                        });
                        alert("链接已成功删除！");
                    }
                }
            } catch (error) {
                console.error("Error removing link:", error);
                alert("删除失败，请检查控制台错误信息。");
            }
        }

        // --- 5. 辅助函数 ---
        document.querySelectorAll('.link-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.link-type-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedLinkType = this.dataset.type;
                const urlInput = document.getElementById('linkUrl');
                const placeholders = {
                    'notion': 'Notion页面链接 (例如：https://notion.so/...)',
                    'google-doc': 'Google Docs链接 (例如：https://docs.google.com/document/...)',
                    'google-sheet': 'Google Sheets链接 (例如：https://docs.google.com/spreadsheets/...)',
                    'google-slide': 'Google Slides链接 (例如：https://docs.google.com/presentation/...)',
                    'other': '请输入有效的网址链接'
                };
                urlInput.placeholder = placeholders[selectedLinkType];
            });
        });
        document.getElementById('linkUrl').addEventListener('keypress', (e) => { if (e.key === 'Enter') addLink(); });
        function isValidUrl(url) { try { new URL(url); return true; } catch { return false; } }
        function getLinkIcon(type) { switch(type) { case 'notion': return '📝'; case 'google-doc': return '📄'; case 'google-sheet': return '📊'; case 'google-slide': return '📽️'; default: return '🌐'; } }

        // --- 6. 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            listenToLinks();
        });
    </script>
</body>
</html>